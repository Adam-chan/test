<div id="top_tools" class=" btn-group">
	<button  class="btn btn-sm btn-white"
		onclick="aihome.cleanLookManage();">
		<i class="iconfont">&#xe626;</i> <span>清空</span>
	</button>
	<button  class="btn btn-sm btn-white"
		onclick="aihome.queryLookManage();">
		<i class="iconfont">&#xe626;</i> <span>查询</span>
	</button>
	<button  class="btn btn-sm btn-white"
		onclick="aihome.cancelLookManage();">
		<i class="iconfont">&#xe6e3;</i> <span>取消</span>
	</button>
	<button  class="btn btn-sm btn-white"
		onclick="aihome.lookManageAgain();">
		<i class="iconfont">&#xe626;</i> <span>再约/带</span>
	</button><button  class="btn btn-sm btn-white"
		onclick="aihome.updateLookManage();">
		<i class="iconfont">&#xe6dd;</i> <span>修改</span>
	</button>
</div>
<div class="row">
<div class="col-sm-12 col-xs-12 my-group ">
	<div class="form-horizontal row my-inputs">
		<div class=" row ">
			<div class="col-md-6 col-sm-6">
				<div class="form-xs form-group row">
					<div class="col-xs-2 "></div>
					<div class="col-xs-4">
						<select id="entryDate" class="input-xs form-control ">
							<option value=""></option>
							<option value="1" selected="selected">录入时间</option>
							<option value="2">约看时间</option>
						</select>
					</div>
					<div class="col-xs-4"> 
						<select id="selectDateRange" class="input-xs form-control dateRange">
							<option value=""></option>
							<option value="1">近一周</option>
							<option value="2">近一天</option>
							<option value="3">近二天</option>
							<option value="4">近三天</option>
							<option value="5">近一月</option>
						</select>
					</div>
				</div>
			</div>

			<div class="col-md-6 col-sm-6">
				<div class="form-xs form-group row">
				<div class="col-xs-1"/>
					<div class="col-xs-8">
						<div class=" input-daterange input-group 5i5jdate" style="">
							<input type="text" class="form-control input-xs"
								id="createTimeStart" placeholder="开始时间" name="timeStart"> <span
								class="input-group-addon addon-xs"> <i
								class="fa fa-exchange"></i>
							</span> <input type="text" class="form-control input-xs"
								id="createTimeEnd" placeholder="结束时间" name="timeEnd">
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class=" row ">
			<div class="col-md-6 col-sm-6">
				<div class="form-xs form-group row">
					<div class="col-xs-2 "></div>
					<div class="col-xs-4">
						<select id="demandCode" class="input-xs form-control">
							<option value=""></option>
							<option value="1" selected="selected">客源编号</option>
							<option value="2">客户姓名</option>
						</select>
					</div>
					<div class="col-xs-4">
						<input id = "customerName" type="text" class="form-control input-xs"
							placeholder="输入客源编号或客户姓名" />
					</div>
				</div>
			</div>
			
			<div class="col-md-6 col-sm-6">
				<div class="form-xs form-group row">
				<div class="col-xs-1"/>
					<div class="col-xs-4">
						<select id="houseCode" class="input-xs form-control">
							<option value=""></option>
							<option value="1" selected="selected">房源编号</option>
							<option value="2">业主姓名</option>
						</select>
					</div>
					<div class="col-xs-4">
						<input id = "ownerName" type="text" class="form-control input-xs"
							placeholder="输入房源编号或业主姓名" />
					</div>
				</div>
			</div>
		</div>

		<div class=" row ">
			<div class="col-md-6 col-sm-6">
				<div class="form-xs form-group row">
					<label for="" class="col-xs-2 control-label">需求类型：</label>
					<div class="col-xs-4">
						<select id="demandType" class="input-xs form-control" 
							onchange="switchTable();">
							<option value="">请选择</option>
							<option value="1" >求租</option>
							<option value="2">求购</option>
						</select>
					</div>
					<div class="col-xs-4">
						 <select id="propertyType" class="input-xs form-control" 
							onchange="switchTable();">
							<option value="">请选择</option>
							<option value="1" >住宅</option>
							<option value="2">商铺</option>
							<option value="3">写字楼</option>
							<option value="4">车位</option>
						</select>
					</div>
					
				</div>
			</div>
			
			<div class="col-md-2 col-sm-2">
				<div class="form-xs form-group row">
					<label for="" class="col-xs-3 control-label">状态：</label>
					<div class="col-xs-9 ">
						<select id="promiseStatus" class="input-xs form-control">
							<option value=""></option>
							<option value="1">新建</option>
							<option value="2">已带看</option>
							<option value="3">已取消</option>
						</select>
					</div>
				</div>
			</div>
		</div>


		<div class=" row ">
			<div class="col-md-3 " >
				<div class="form-xs form-group row">
				
					<label for="" class="col-xs-4 control-label">录入区：</label>
					<div class="col-xs-6 ">
						<select id="quOrg" class="input-xs form-control">
							<option value=""></option>
						<#list quOrgList as item>
							<option value="${item.orgCode}">${item.name}</option>
						</#list>
						</select>
					</div>
				</div>
			</div>
			
			<div class="col-md-3 " >
				<div class="form-xs form-group row">
					<label for="" class="col-xs-3 control-label">录入组：</label>
					<div class="col-xs-5">
						<select id="zuOrg" class="input-xs form-control">
							<option value=""></option>
						</select>
					</div>
				</div>
			</div>		
			
			<div class="col-md-2 " >
				<div class="form-xs form-group row">
					<label for="" class="col-xs-4 control-label">录入人：</label>
					<div class="col-xs-8 ">
						<select id="jingjiren" class="input-xs form-control">
							<option value=""></option>
						</select>
					</div>
				</div>
			</div>
		</div>

	</div>
	<div id="more-input" class="" style="height: 71px;">
			<div>
				<i class="iconfont"></i>
			</div>
		</div>
	</div>
	
	<div class="col-xs-12 my-grid">
	<table id="lookManageJqGrid"></table>
	<div id="lookManageJqGridPager"></div>
	</div>
	

</div>
<input id = "demandType" type="hidden">
<input id = "propertyType" type="hidden">
<input id = "custPromiseId" type="hidden">
<input id = "custPromiseHouseId" type="hidden">
<input id = "custPromisePremisesId" type="hidden">
<script type="text/javascript">
var aihome = {};
	$('.page-content-area').ace_ajax('loadScripts', [ null, "../assets/js/bootbox.js"], function() {
	});
	
	/*初始化分页页面*/
	aihome.lookManageInit = function () {
		$("#lookManageJqGrid")
				.jqGrid(
						{
							height : $(window).height() - 279,
							multiselect : true,
							multiboxonly : true,
							viewrecords : true,
							rownumbers : true,
							autowidth : true,
							autoheight : true,
							async : false,
							url : "${CTX}/customerSource/getLookManagePage.do",
							postData : {
								
							},
							datatype : "json",
							colNames : [ '约/带看人', '业务类型', '客源编号','客户姓名','房源编号/楼盘名称', '录入时间' 
							             , '约看时间' , '带看时间' , '状态' ,'promiseStatus','customerName','demandCode','promiseDone'
							             ,'demandId','demandType','premisesId','houseInfoId','accompany','takeUser','id','operateUser','houseCode'],
							colModel : [       
										{name : 'takeUser',sortable : false,width : 5,align : 'center'}, 
										{name : 'demandType',sortable : false,width : 5,align : 'center',
											 formatter:function(rowName, options, rowObject){
												 var html = "";
												 if(rowObject.demandTypeStr){
													 html += rowObject.demandTypeStr;
												 }
												 if(rowObject.propertyTypeStr){
													 html += "（"+rowObject.propertyTypeStr+"）";
												 }
							            	     return html;
								             }}, 
										{name : 'customerDemand',sortable : false,width : 6,align : 'center',
											 formatter:function(rowName, options, rowObject){
												 var html = "";
												 if(rowObject.demandCode){
													 html += "<a style='color: blue;' onclick='aihome.showDetails("+rowObject.demandId+");'>"+rowObject.demandCode+"</a>";
												 }
							            	     return html;
								             }
										}, 
										{name : 'customerName',sortable : false,width : 6,align : 'center'},   
										{name : 'houseCode',sortable : false,width : 6,align : 'center',
											 formatter:function(rowName, options, rowObject){
												 var html = "";
												 if(rowObject.houseCode){
													 if(rowObject.demandType == 1){
														 html += "<a href=\"javascript:aihome.houseDetail('"+rowObject.houseInfoId+"',1,"+rowObject.propertyType+");\"  style='color:blue'>"+rowObject.houseCode+"</a>";
													 }else if(rowObject.demandType == 2){
														 html += "<a href=\"javascript:aihome.houseDetail('"+rowObject.houseInfoId+"',2,"+rowObject.propertyType+");\"  style='color:blue'>"+rowObject.houseCode+"</a>";
													 }
												 }
												 if(rowObject.premisesName){
													 html += "<a style='color: blue;' onclick='aihome.toPremisesDetails("+rowObject.premisesId+");'>"+rowObject.premisesName+"</a>";
												 }
							            	     return html;
								             }}, 
										{name : 'createTimeStr',sortable : false,width : 6,align : 'center'},
										{name : 'promiseDateStr',sortable : false,width : 6,align : 'center'},
										{name : 'takeDateStr',sortable : false,width : 6,align : 'center'},
										{name : 'promiseDone',sortable : false,width : 4,align : 'center',
											 formatter:function(rowName, options, rowObject){
												 var html = "";
												 if(rowObject.promiseDone){
													 if(rowObject.promiseDone == 1){
														 html += "约带看中";
													 }else if(rowObject.promiseDone == 2){
														 html += "已带看";
													 }else if(rowObject.promiseDone == 3){
														 html += "已取消";
													 }
												 }
							            	     return html;
								             }},
										{name : 'promiseStatus',hidden:true},
										{name : 'promiseDone',hidden:true},
										{name : 'customerName',hidden:true},
										{name : 'demandType',hidden:true},
										{name : 'demandId',hidden:true},
										{name : 'premisesId',hidden:true},
										{name : 'houseInfoId',hidden:true}, 
										{name : 'houseCode',hidden:true},  
										{name : 'accompany',hidden:true},
										{name : 'takeUser',hidden:true},
										{name : 'operateUser',hidden:true},
										{name : 'demandCode',hidden:true},
										{name : 'id',hidden:true}
										],
							rowNum : 30,
							rowList : [ 10, 20, 30, 50, 100 ],
							pager : "#lookManageJqGridPager",
							jsonReader : {
								root : 'pagerResults',
								page : 'currentPage',
								rows : 'rowCount',
								total : 'pageCount',
								records : 'totalCount',
								repeatitems : false
							}
						});
	}
	
	/* 客源详情 */
	aihome.showDetails = function(id) {		
		oaDialogOpen("customerSourceDetail",//对话框ID，必填，且不能与当前页面的ID重复
			{
		url : "${CTX}/customerSource/customerSourceDetail.do?id="+id,//调用页面的url
		title : "客源详情",//弹框的title
		closeOnEscpe : true,//是否通过escpe关闭弹框
		closeBtn : true,//是否显示关闭按钮
		width : 1000,//弹框的宽度
		height : 800,
		buttons : {
			"取消" : function() {
				$(this).dialog("close");
			}
		}
	});
	}
	
	/* 查询 */
	aihome.queryLookManage = function () {
		$("#lookManageJqGrid").setGridParam({
			postData : {
				demandCode : $("#demandCode").val(),
				customerName : $("#customerName").val(),
				houseCode : $("#houseCode").val(),
				ownerName : $("#ownerName").val(),
				demandType : $("#demandType").val(),
				propertyType : $("#propertyType").val(),
				entryDate : $("#entryDate").val(),
				createTimeStart : $("#createTimeStart").val(),
				createTimeEnd : $("#createTimeEnd").val(),
				jingjiren : $("#jingjiren").val(), 
				promiseStatus : $("#promiseStatus").val()
			}
		}).trigger("reloadGrid");
	}

	/* 清空 */
	aihome.cleanLookManage = function () {
		$("#demandCode").val(1),
		$("#customerName").val(''),
		$("#houseCode").val(1),
		$("#ownerName").val(''),
		$("#demandType").val(''),
		$("#propertyType").val(''),
		$("#entryDate").val(''),
		$("#selectDateRange").val(''),
		$("#createTimeStart").val(''),
		$("#createTimeEnd").val(''),
		$("#quOrg").val(''),
		$("#zuOrg").val(''),
		$("#jingjiren").val(''),
		$("#promiseStatus").val('')
	}
	
	aihome.getAddress = function (val, objId) {
		var _url  = "${CTX}/org/orgList.do";
		if(objId == "jingjiren"){
			_url= "${CTX}/org/userList.do";
		}
		$.ajax({
			type : "post",
			url : _url,
			async : false,
			dataType : 'json',
			async:false,
			data : {
				"orgCode" : val
			},
			success : function(data) {
				
				aihome.changeAddress(data, objId);
			},
		});
	}

	aihome.changeAddress = function(data, objId) {
		var obj = $("#" + objId);
		
		obj.children().first().siblings().remove();
		var str = "";
		for (var i = 0; i < data.length; i++) {
			var orgCode = "";
			if(objId==="jingjiren"){
				orgCode = data[i].userId;
			}else{
				orgCode = data[i].orgCode;
			}
			var name = data[i].name;
			str = '<option value="'+orgCode+'">'
					+ name + '</option>';
			obj.append(str);
		}
	}

	/**组*/
	$("#zuOrg").change(function (){
		var orgCode = $(this).val();
		//组数据变更，下级全部清空
		$("#jingjiren").children().first().siblings().remove();
		aihome.getAddress(orgCode, "jingjiren");
	});
	/**
	 * 区
	 */
	$("#quOrg").change(function() {
		
		var orgCode = $(this).val();
		//区数据变更，下级全部清空
		$("#zuOrg").children().first().siblings().remove();
		$("#jingjiren").children().first().siblings().remove();
		aihome.getAddress(orgCode, "zuOrg");
	});
	
	/* 取消约带看 */
	aihome.cancelLookManage = function (){
		var rowIds = $("#lookManageJqGrid").jqGrid('getGridParam','selarrrow');
		var selCount=rowIds.length;
		
		if (selCount==0){
			alert("没有选中的记录！");
			return;
		}else if(selCount >1){
			alert("请只选择一个记录！");
			return;
		}
		var rowData = $("#lookManageJqGrid").jqGrid('getRowData',rowIds);
		
		var mydate = new Date();
		nextNow = addDate((mydate.getMonth()+1)+"/"+mydate.getDate()+"/"+mydate.getFullYear(),-1);
		var dateStr = "" + nextNow.getFullYear() + "-";
		dateStr += (nextNow.getMonth()+1) + "-";
		dateStr += nextNow.getDate()< 10 ? "0"+nextNow.getDate() : nextNow.getDate();
		
		if(!(rowData.promiseStatus == 1 && dateStr <  rowData.takeDateStr)){
			alert("只能取消新建的约带看！");
			return;
		}
		
		if(confirm("确定要取消新建的约带看吗？")){
			$.ajax({
				url : "${CTX}/customerSource/cancelLookManage.do",
				dataType : "json",
				type : 'post',
				data : {
					rowIds : rowIds
				},
				success : function(data) {
					$("#lookManageJqGrid").trigger("reloadGrid");
					}
			});
		}
		
	}
	
	function addDate(dd,dadd){
		var a = new Date(dd)
		a = a.valueOf()
		a = a + dadd * 24 * 60 * 60 * 1000
		a = new Date(a)
		return a;
		}
	
	/* 再约 */
	aihome.lookManageAgain = function (){
		var rowIds = $("#lookManageJqGrid").jqGrid('getGridParam','selarrrow');
		var selCount=rowIds.length;
		
		if (selCount==0){
			alert("没有选中的记录！");
			return;
		}else if(selCount >1){
			alert("请只选择一个记录！");
			return;
		}
		
		var rowData = $("#lookManageJqGrid").jqGrid('getRowData',rowIds);
		var userName = rowData.customerName;
		var demandCode = rowData.demandCode;
		$("#demandType").val(rowData.demandType);
		
		var mydate = new Date();
		nextNow = addDate((mydate.getMonth()+1)+"/"+mydate.getDate()+"/"+mydate.getFullYear(),-1);
		var dateStr = "" + nextNow.getFullYear() + "-";
		dateStr += (nextNow.getMonth()+1) + "-";
		dateStr += nextNow.getDate()< 10 ? "0"+nextNow.getDate() : nextNow.getDate();
		
		if(rowData.promiseStatus == 1 && dateStr <  rowData.takeDateStr){
			alert("新建中的约带看不可以再约！");
			return;
		}
		
		var heights = $(window).height()*0.9;
		var widths = $(window).width()*0.6;
		oaDialogOpen("toAppointTakeLookAdd",//对话框ID，必填，且不能与当前页面的ID重复
				{
					url : "${CTX}/customerSource/addAppointTakeLook.do?userName="+userName+
							"&demandCode="+demandCode+"&addCustomerId="+rowIds,//调用页面的url
					title : "再约/带约带看",//弹框的title
					closeOnEscpe : true,//是否通过escpe关闭弹框
					closeBtn : true,//是否显示关闭按钮
					width : widths,//弹框的宽度
					height : heights,
					buttons : {
						"添加" : function() {
							
							aihome.addDemandHouse();
						},
						"保存" : function() {
							var takeType = $("#takeType").val();
							if(takeType == 1){
								aihome.saveCustTakeLook(rowIds);
							}else{
								aihome.savePremisesTakeLook(rowIds);
							}
							$(this).dialog("close");
							$("#lookManageJqGrid").trigger('reloadGrid');
						},
						"取消" : function() {
							$(this).dialog("close");
						}
					}
				});
	}
	
	/* 修改  */
	aihome.updateLookManage = function (){
		var rowIds = $("#lookManageJqGrid").jqGrid('getGridParam','selarrrow');
		var selCount=rowIds.length;
		
		if (selCount==0){
			alert("没有选中的记录！");
			return;
		}else if(selCount >1){
			alert("请只选择一个记录！");
			return;
		}
		
		var rowData = $("#lookManageJqGrid").jqGrid('getRowData',rowIds);
		var promiseStatus = rowData.promiseStatus;
		if(promiseStatus != 1){
			alert("只能修改状态为新建的约带看！");
			return
		}
		
		var userName = rowData.customerName;
		var demandCode = rowData.demandCode;
		var demandId = rowData.demandId;
		var premisesId = rowData.premisesId;
		var houseInfoId  = rowData.houseInfoId ;
		var promiseDateStr  = rowData.promiseDateStr ;
		var takeDateStr  = rowData.takeDateStr ;
		var takeUser  = rowData.takeUser ;
		var operateUser  = rowData.operateUser ;
		var accompany = rowData.accompany;
		var premisesData = '';
		$("#demandType").val(rowData.demandType);
		var demandType = rowData.demandType;
		$("#custPromiseId").val(rowData.id);
		$("#custPromiseHouseId").val(houseInfoId);
		$("#custPromisePremisesId").val(premisesId);
		
		var heights = $(window).height()*0.9;
		var widths = $(window).width()*0.6;
		
		oaDialogOpen("toAppointTakeLookUpdate",//对话框ID，必填，且不能与当前页面的ID重复
				{
					url : "${CTX}/customerSource/addAppointTakeLook.do?userName="+userName
							+"&demandCode="+demandCode+"&addCustomerId="+demandId+"&premisesId="+
							premisesId+"&houseInfoId="+houseInfoId+"&promiseDateStr="+promiseDateStr+"&takeDateStr="+takeDateStr
							+"&demandType="+demandType+"&operateUser="+operateUser+"&accompany="+accompany+"&takeUser="+takeUser,//调用页面的url
					title : "修改约带看",//弹框的title
					closeOnEscpe : true,//是否通过escpe关闭弹框
					closeBtn : true,//是否显示关闭按钮
					width : widths,//弹框的宽度
					height : heights,
					buttons : {
						"保存" : function() {
							var takeType = $("#takeType").val();
							custPromiseId = $("#custPromiseId").val();
							if(takeType == 1){
								if(custPromiseId != null & custPromiseId != ''){
									aihome.deleteCustPromisebyId(custPromiseId);
								}
								aihome.saveCustTakeLook(demandId);
							}else{
								if(custPromiseId != null & custPromiseId != ''){
									aihome.deleteCustPromisebyId(custPromiseId);
								}
								aihome.savePremisesTakeLook(demandId);
							}
							$(this).dialog("close");
							$("#lookManageJqGrid").trigger('reloadGrid');
						},
						"取消" : function() {
							$(this).dialog("close");
						}
					}
				});
		
	}	
	
	/* 点击转到楼盘详情页面*/
	aihome.toPremisesDetails = function (id){
		var heights = $(window).height()*0.7;
		var widths = $(window).width()*0.45;
		
		oaDialogOpen("toPremisesDetails",//对话框ID，必填，且不能与当前页面的ID重复
				{
					url : "${ADDR_CTX}/infoDisplay/getInfo.do?id="+id,//调用页面的url
					title : "楼盘详情",//弹框的title
					closeOnEscpe : true,//是否通过escpe关闭弹框
					closeBtn : true,//是否显示关闭按钮
					width : widths,//弹框的宽度
					height : heights,
					buttons : {
						"确定" : function() {
							var custArrays = aihome.saveAddCustSource();
							if(custArrays != null){
								$(this).dialog("close");
								caihome.ustTableInit(custArrays);
							}
						},
						"取消" : function() {
							$(this).dialog("close");
						}
					}
				});
		
	}
	
	//查看租赁房源详情页
	aihome.houseDetail = function(houseId,type,num){
		oaDialogOpen("lookUpHouse",//对话框ID，必填，且不能与当前页面的ID重复
			 {url:"${CTX}/houseLease/lookUpDetail.do?houseInfoId="+houseId+"&type="+type+"&num="+num,
			      title:"查看详细信息",//弹框的title
			      closeOnEscpe:true,//是否通过escpe关闭弹框
			      closeBtn:true,//是否显示关闭按钮
			      width: $(window).width()*0.8,//弹框的宽度
				  height: $(window).height()*0.9,
			  })
	}
	
	$(function() {
		aihome.lookManageInit();
		
		//时间控件
		$('.5i5jdate').datepicker({
		    clearBtn: true,
		    language: "zh-CN",
		    autoclose: true,
		    todayHighlight: true,
		    format: "yyyy-mm-dd",
		});
		
		//时间范围显示
		$(".dateRange").change(function(){
			var dateRange = $(this).val();//1.本周2.今日3.二天 4.三天内  5.本月
			var start = $("#createTimeStart");
			var end = $("#createTimeEnd");
			var week_day = new Date().getDay()-1;//当前时间是本周第几天
			var month_day = new Date().getDate()-1;//当前日期是本月第几天
			if(dateRange==2){
				$(start).datepicker('setDate', 'null');
			}else if(dateRange==3){
				$(start).datepicker('setDate', '-2d');
			}else if(dateRange==4){
				$(start).datepicker('setDate', '-3d');
			}else if(dateRange==1){
				$(start).datepicker('setDate', '-'+week_day+'d');
			}else if(dateRange==5){
				$(start).datepicker('setDate', '-'+month_day+'d');
			}else if(dateRange==""){
				$(start).val("");
			}
			if(dateRange!=""){
				$(end).datepicker('setDate', 'null');
			}else{
				$(end).val("");
			}
		});
		
	});
</script>