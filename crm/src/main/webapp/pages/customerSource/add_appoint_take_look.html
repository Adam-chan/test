<div class="col-xs-12 my-group">
	<div class="panel-heading" style="background-color: #A8C9F4;">
		<h5 class="panel-title">
			<a class="accordion-toggle">客源信息</a>
		</h5>
	</div>
	<div class="panel-collapse">
		<div class="panel-body">
			<div class="form-horizontal row ">
				<row>
					<a id="cusDetail" style="color: blue;" onclick="aihome.showDetails(${addCustomerId},1);">${demandCodeCust !''}</a>（${userNameCust !''}）
					<b id="lookTell">&nbsp;电话：</b><a onclick='aihome.userCheckInfoFun(this)' demandType="${demandType !''}" demandId = "${addCustomerId !''}" style='color:blue'> 查看 </a>
				</row>
				<div class=" input-daterange input-group 5i5jdate">
					<div class="col-md-8 col-sm-8">
						<div class="col-md-6 col-sm-6">
							<div class="form-xs form-group row ">
								<label for="promiseDate" class="col-xs-4 control-label">约看时间：</label>
								<div class="col-xs-8">
									<input id="promiseDate" class="form-control input-xs" value="${promiseDateStr !''}"/>
								</div>
							</div>
						</div>
						<div class="col-md-6 col-sm-6">
							<div class="form-xs form-group row">
								<label for="takeDate" class="col-xs-4 control-label">带看时间：</label>
								<div class="col-xs-8">
									<input id="takeDate" class="form-control input-xs" value="${takeDateStr !''}"/>
								</div>
							</div>
						</div>
					</div>

					<div class="col-md-4 col-sm-4">
						<div class="form-xs form-group row">
							<label for="takeType" class="col-xs-4 control-label">类型：</label>
							<div class="col-xs-8">
								<select id="takeType" class="input-xs form-control" onchange="aihome.switchGrid();">
									<option value="1">房源</option>
									<option value="2">一手楼盘</option>
								</select>
							</div>
						</div>
					</div>
				</div>

				<div class="col-md-8 col-sm-8">
					<div class="col-md-6 col-sm-6">
						<div class="form-xs form-group row">
							<label for="takeUser" class="col-xs-4 control-label">带看人：</label>
							<div class="col-xs-8">
								<input id="takeUser" class="form-control input-xs" value="${takeUser !''}"/>
							</div>
						</div>
					</div>
					<div class="col-md-6 col-sm-6">
						<div class="form-xs form-group row">
							<label for="operateUserCust" class="col-xs-4 control-label">录入人：</label>
							<div class="col-xs-8">
								<input id="operateUserCust" class="form-control input-xs" value="${operateUser !''}"/>
								<input id="operateUserCustId" type="hidden"/>
							</div>
						</div>
					</div>
				</div>
				<div class="col-md-4 col-sm-4">
					<div class="form-xs form-group row">
						<label for="accompany" class="col-xs-4 control-label">陪看人：</label>
						<div class="col-xs-8">
							<input id="accompany" class="form-control input-xs" value="${accompany !''}"/>
						</div>
					</div>
				</div>

			</div>
		</div>

	</div>

	<div class="panel-heading" style="background-color: #A8C9F4;">
		<h5 class="panel-title">
			<a class="accordion-toggle">约看房源</a>
		</h5>
	</div>
	
	<div class="panel-collapse">
		<div class="panel-body">
		
		<div id="hideTable1" class="col-xs-12">
		<table id="custTable1" class="table table-striped table-bordered table-hover">
			<colgroup>
				<col style="width:8%">
				<col style="width:8%">
				<col style="width:12%">
				<col style="width:6%">
				<col style="width:3%">
				<col style="width:3%">
				<col style="width:3%">
				<col style="width:3%">
			</colgroup>
			<thead>
				<tr>
					<th>房源编号</th>
					<th>小区名</th>
					<th>房源地址</th>
					<th>户型</th>
					<th>面积</th>
					<th>楼层</th>
					<th>售价</th>
					<th>操作</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
	</div>
	
	<div id="hideTable2" class="col-xs-12">
		<table id="custTable2" class="table table-striped table-bordered table-hover">
			<colgroup>
				<col style="width:8%">
				<col style="width:12%">
				<col style="width:4%">
				<col style="width:4%">
				<col style="width:4%">
			</colgroup>
			<thead>
				<tr>
					<th>楼盘名称</th>
					<th>楼盘地址</th>
					<th>起价（万元）</th>
					<th>均价（万元）</th>
					<th>操作</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
	</div>
	
		</div>
	</div>
</div>
<input id = "userNameCust" type="hidden" value="${userNameCust !''}">
<input id = "demandCodeCust" type="hidden" value="${demandCodeCust !''}">
<input id = "premisesId" type="hidden" value="${premisesId !''}">
<input id = "houseInfoId" type="hidden" value="${houseInfoId !''}">
<input id="appointlastPage" type="hidden" value ="${(lastPage)!''}" />
<script type="text/javascript">
	$(function() {
		$("#hideTable2").hide();
		var demandType = $("#demandType").val();
		if(demandType == 2){
			$("#takeType").attr("disabled","disabled");
		}
		
		var userNameCust = $("#userNameCust").val();
		var demandCodeCust = $("#demandCodeCust").val();
		var custPromiseId = $("#custPromiseId").val();
		var premisesId = $("#premisesId").val();
		if(premisesId != null && premisesId != ''){
			$("#takeType").val(2);
			$("#hideTable1").hide();
			$("#hideTable2").show();
			
			$.ajax({
				url : "${CTX}/customerSource/getPremisesByid.do",
				dataType : "json",
				type : 'post',
				data : {
					premisesId : premisesId,
					custPromiseId : custPromiseId
				},
				success : function(data) {
					var appendTr = "<tr><td><a style='color: blue;' onclick='aihome.toPremisesDetails(" + data.id + ");' >"+data.name +"<a/></td><td>" + data.addrDetail + "</td><td>" + data.startingAtPrice + "</td><td>" + data.averagePrice + 
					"</td><td><a style='color: blue;' onclick='aihome.removePremisesTr(this," + data.id + ")'>删除<a/></td></tr>"
					$("#custTable2").append(appendTr);
				}	
			});
		}
		
		var houseInfoId = $("#houseInfoId").val();
		if(houseInfoId != null && houseInfoId != ''){
		
			$.ajax({
				url : "${CTX}/customerSource/getHouseById.do",
				dataType : "json",
				type : 'post',
				data : {
					houseInfoId : houseInfoId,
					demandType : $("#demandType").val(),
					custPromiseId : custPromiseId
				},
				success : function(data) {
					var chaoXiangStr = data.chaoXiangStr?data.chaoXiangStr:"";
					var demandType = $("#demandType").val();
					var appendTr = "<tr><td><a style='color: blue;' onclick='aihome.houseDetail(" + houseInfoId +","+demandType+","+data.property + ");' >"+data.code +"<a/>（"+userNameCust +"）</td><td>"+data.communityName+"</td><td>" + data.addressDetail + "</td><td>" + data.rooms+"室"+data.office +"厅"+ "</td><td>" + data.coveredArea + 
					"</td><td>" + data.floor +"</td><td>" + chaoXiangStr +
					"</td><td><a style='color: blue;' onclick='aihome.removePremisesTr(this," + ${addCustomerId} + ")'>删除<a/></td></tr>"
					$("#custTable1").append(appendTr);
				}	
			});
		}
		
	});
	aihome.addDemandHouse = function () {

		var takeType = $("#takeType").val();
		var heights = $(window).height() * 0.9;
		var widths = $(window).width() * 0.65;
		if (takeType == 1) {

			oaDialogOpen("toTakeLookCust",//对话框ID，必填，且不能与当前页面的ID重复
			{
				url : "${CTX}/customerSource/toTakeLookCust.do",//调用页面的url
				title : "添加房源",//弹框的title
				closeOnEscpe : true,//是否通过escpe关闭弹框
				closeBtn : true,//是否显示关闭按钮
				width : widths,//弹框的宽度
				height : heights,
				buttons : {
					"确定" : function() {
						var custArrays = aihome.saveAddCustSource();
						if(custArrays != null){
							$(this).dialog("close");
							aihome.custTableInit(custArrays);
						}
					},
					"取消" : function() {
						$(this).dialog("close");
					}
				}
			});
		} else {
			
			oaDialogOpen("toTakeLookPremises",//对话框ID，必填，且不能与当前页面的ID重复
					{
						url : "${CTX}/customerSource/toTakeLookPremises.do",//调用页面的url
						title : "添加楼盘",//弹框的title
						closeOnEscpe : true,//是否通过escpe关闭弹框
						closeBtn : true,//是否显示关闭按钮
						width : widths,//弹框的宽度
						height : heights,
						buttons : {
							"确定" : function() {
								var premisesArrays = aihome.saveAddPremises();
								if(premisesArrays != null){
									$(this).dialog("close");
									aihome.premisesTableInit(premisesArrays);
								}
							},
							"取消" : function() {
								$(this).dialog("close");
							}
					}
			});
		}

	}
	
	var houseInfoIds = '';
	/* 房源列表初始化 */
	aihome.custTableInit = function (objArrays) {
		var userName = $("#userNameCust").val();
		var demandCode = $("#demandCodeCust").val();
		var demandType =$("#demandType").val();
		var trLength = objArrays.length;
		var tdLength = 8;
		var houseIds = '';
		for(i = 0 ; i<trLength ; i++){
			var obj = objArrays[i];
			var colArray = obj.split(',');
			var appendTr = "<tr><td><a style='color: blue;' onclick='aihome.houseDetail(" + colArray[9] +","+demandType+","+colArray[8] + ");'>"+colArray[7] +"<a/>（"+userName+"）</td><td>"+colArray[6]+"</td><td>" + colArray[0] + "</td><td>" + colArray[1] + "</td><td>" + colArray[2] + 
			"</td><td>" + colArray[3] + "</td><td>" + colArray[4] + "</td><td><a style='color: blue;' onclick='aihome.removeCustTr(this," + colArray[5] + ")'>删除<a/></td></tr>"
			$("#custTable1").append(appendTr);
			houseIds += colArray[5];
			houseIds +=',';
		}
		houseInfoIds +=houseIds;
	}
	
	var premisesIds = '';
	/* 楼盘列表初始化 */
	aihome.premisesTableInit = function (objArrays) {
		var trLength = objArrays.length;
		var tdLength = 5;
		var premisesId = '';
		for(i = 0 ; i<trLength ; i++){
			var obj = objArrays[i];
			var colArray = obj.split(',');
			var appendTr = "<tr><td><a style='color: blue;' onclick='aihome.toPremisesDetails(" + colArray[4] + ");' >"+colArray[0] +"<a/></td><td>" + colArray[1] + "</td><td>" + colArray[2] + "</td><td>" + colArray[3] + 
			"</td><td><a style='color: blue;' onclick='aihome.removePremisesTr(this," + colArray[4] + ")'>删除<a/></td></tr>"
			$("#custTable2").append(appendTr);
			premisesId += colArray[4];
			premisesId +=',';
		}
		premisesIds += premisesId;
	}
	
	/* 点击转到楼盘详情页面*/
	aihome.toPremisesDetails = function (id){
		var heights = $(window).height()*0.7;
		var widths = $(window).width()*0.45;
		
		oaDialogOpen("toPremisesDetails",//对话框ID，必填，且不能与当前页面的ID重复
				{
					url : "${ADDR_CTX}/infoDisplay/getInfo.do?id="+id,//调用页面的url
					title : "楼盘详情",//弹框的title
					closeOnEscpe : true,//是否通过escpe关闭弹框
					closeBtn : true,//是否显示关闭按钮
					width : widths,//弹框的宽度
					height : heights,
					buttons : {
						"确定" : function() {
							var custArrays = aihome.saveAddCustSource();
							if(custArrays != null){
								$(this).dialog("close");
								caihome.ustTableInit(custArrays);
							}
						},
						"取消" : function() {
							$(this).dialog("close");
						}
					}
				});
		
	}
	
	/* 删除房源列表中选中行*/
	aihome.removeCustTr = function (temp,id) {
		if(confirm("确认删除该房源吗？")){
			$(temp).parent().parent().remove();
			houseInfoIds = houseInfoIds.replace(id,"");
			var cId = $("#custPromiseHouseId").val();
			if(cId = id){
				$("#custPromiseHouseId").val('');
			}
		}
	}
	
	/* 删除楼盘列表中选中行*/
	aihome.removePremisesTr = function (temp,id) {
		if(confirm("确认删除该楼盘吗？")){
			$(temp).parent().parent().remove();
			premisesIds = premisesIds.replace(id,"");
			var pId = $("#custPromisePremisesId").val();
			if(pId = id){
				$("#custPromisePremisesId").val('');
			}
		}
	}
	
	/* 保存添加房源 */
	aihome.saveCustTakeLook = function (demandId) {
		houseInfoIds = houseInfoIds.substring(0,houseInfoIds.length-1);
		var custPromiseHouseId = $("#custPromiseHouseId").val();
		houseInfoIds += ','+custPromiseHouseId;
		$.ajax({
			url : "${CTX}/customerSource/saveCustTakeLook.do",
			dataType : "json",
			type : 'post',
			data : {
				houseIds : houseInfoIds,
				demandId : demandId,
				promiseDate : $("#promiseDate").val(),
				takeDate : $("#takeDate").val(),
				takeType : $("#takeType").val(),
				operateUser : $("#operateUserCust").val(),
				accompany : $("#accompany").val(),
				agentId :$ ("#operateUserCustId").val(),
				takeUser : $("#takeUser").val()
			},
			success : function(data) {
				if(data == 0){
					alert("添加约带看失败！");
					return
				}
				alert("成功添加约带看！");
			}
		});
		
	}
	
	/* 保存添加楼盘 */
	aihome.savePremisesTakeLook = function (demandId) {
		premisesIds = premisesIds.substring(0,premisesIds.length-1);
		var custPromisePremisesId = $("#custPromisePremisesId").val();
		premisesIds += ','+custPromisePremisesId;
		
		$.ajax({
			url : "${CTX}/customerSource/savePremisesTakeLook.do",
			dataType : "json",
			type : 'post',
			data : {
				premisesIds : premisesIds,
				demandId : demandId,
				promiseDate : $("#promiseDate").val(),
				takeDate : $("#takeDate").val(),
				takeType : $("#takeType").val(),
				operateUser : $("#operateUserCust").val(),
				accompany : $("#accompany").val(),
				agentId : $("#operateUserCustId").val(),
				takeUser : $("#takeUser").val()
			},
			success : function(data) {
				alert("成功添加约带看！");
			}
		});
		
	}
	
	/* 根据约带看id删除一条约带看记录 */
	aihome.deleteCustPromisebyId = function (custPromiseId) {
		$.ajax({
			url : "${CTX}/customerSource/deleteCustPromisebyId.do",
			dataType : "json",
			type : 'post',
			data : {
				custPromiseId : custPromiseId
			},
			success : function(data) {
				
			}
		});
		
	}
	
	//查看租赁房源详情页
	aihome.houseDetail = function(houseId,type,num){
		oaDialogOpen("lookUpHouse",//对话框ID，必填，且不能与当前页面的ID重复
			 {url:"${CTX}/houseLease/lookUpDetail.do?houseInfoId="+houseId+"&type="+type+"&num="+num,
			      title:"查看详细信息",//弹框的title
			      closeOnEscpe:true,//是否通过escpe关闭弹框
			      closeBtn:true,//是否显示关闭按钮
			      width: $(window).width()*0.8,//弹框的宽度
				  height: $(window).height()*0.9,
			  })
	}
	
	/* 根据需求切换列表 */
	aihome.switchGrid = function () {
		var takeType = $("#takeType").val();
		if(takeType == 1){
			$("#hideTable1").show();
			$("#hideTable2").hide();
		}else{
			$("#hideTable1").hide();
			$("#hideTable2").show();
		}
	}
	
	/*录入人*/
	$("#operateUserCust").autocomplete({
		source : function(request, response) {
			$.ajax({
				url : "${CTX}/commonSearch/personnelInfoList.do",
				dataType : "json",
				type : 'post',
				data : {
					matchStr : request.term
				},
				success : function(data) {
					var array = new Array(data.length);
					for (var i = 0; i < data.length; i++) {
						var temp = {
							key : data[i].userId,
							value : data[i].userName,
							
						};
						array[i] = temp;
					}
					response(array);
				}
			});
		},
		select : function(event, ui) {
			$("#operateUserCustId").val(ui.item.key);
			$("#operateUserCust").val(ui.item.value);
			event.preventDefault();
		}
	});
	
	if($("#appointlastPage").val()==1){//从详情跳转来的查看详情失效
		$("#cusDetail").attr("onclick", "");
	}
</script>
