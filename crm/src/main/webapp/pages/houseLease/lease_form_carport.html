<!-- 页面描述:租赁房源(车位) -->
<div class="panel">
	<form id="house_lease_Form">
		<div class="panel-heading" style="background-color: #A8C9F4;">
			<h4 class="panel-title">
				<a class="accordion-toggle">基本信息</a>
			</h4>
		</div>
		<div class="panel-collapse">
			<div class="panel-body">
				<div class="modal-body form-horizontal row" >
					<div class="col-sm-12 form-xs form-group row" style="left:-4.7%">
						<div class="col-sm-12 form-xs form-group row">
						   <label class="col-xs-2 control-label">具体地址：</label>
						   <div class="col-xs-10">
						      <input id="addrDetail" type="text" class="form-control selectInput" vRequired="true" value="${(houseLeaseResult.addressDetail)!''}">
						   </div>
						</div>
						<div class="col-sm-12 form-xs form-group row">
						    <label class="col-xs-2 control-label">证载地址：</label>
						    <div class="col-xs-10">
						       <input id="zzdz" type="text" class="form-control input-xs" maxlength="80" name="zzdz" value="${(houseLeaseResult.zzdzDetail)!''}">
						    </div>
						</div>
					</div>
					<div class="col-sm-12 form-xs form-group row" style="width:90%;left:3.5%">
						<label class="col-xs-1 control-label">楼盘名称：</label>
				        <div class="col-xs-2">
				        	<input id="premisesName" type="text" class="form-control input-xs" disabled="true" value="${(houseLeaseResult.premisesName)!''}">
				        </div>
						<label class="col-xs-1 control-label">临近栋座：</label>
				        <div class="col-xs-2">
							<select id="closeBuilding" class="input-xs form-control" name="closeBuilding">
								<option value="">请选择</option>
							</select>
						</div>
						<label class="col-xs-1 control-label">车位类型：</label>
				        <div class="col-xs-2">
							<select id="carPortType" class="input-xs form-control">
								<option value="1">车位</option>
								<option value="2">车库</option>
							</select>
						</div> 
						<label class="col-xs-1 control-label">楼层：</label>
				      	<div class="col-xs-2">
				        	<select id="carPortFloor" class="input-xs form-control">
				            	<option value="1">地上</option>
				            	<option value="2">地下</option>
				            </select>
				      	</div>
					</div>
					<div class="col-sm-12 form-xs form-group row">
						<div class="col-sm-4">
							<label class="col-xs-4 control-label">车位号：</label>
					        <div class="col-xs-6">
					        	<input id="parkNum" type="text" class="form-control input-xs selectInput" style="width:93%" vRequired="true" value="${(houseLeaseResult.parkNum)!''}">
					        </div>
						</div>
						<div class="col-xs-4">
					    	<strong class="contactHouseLease"></strong>
					    </div>
					</div>
					<div class="col-sm-12 form-xs form-group row" style="left:10.8%">
						<#if !houseLeaseResult?exists>
							<div class="col-xs-9">
								<table class="col-xs-12 table-input">
						         <tr>
						             <th style="width:5%">序号</th>
						             <th style="width:30%">联系人类别</th>
						             <th style="width:30%">联系人</th>
						             <th style="width:30%">联系方式</th>
						         </tr>
						         <tbody id="lm_tbody">
						           <tr id="lm_tr0" class="hasDelete">
						              <td class="cloneList">
						               1
						              </td>
							          <td>
							              <select id="type" class='form-control input-xs' name="type">
							                  <option value="1">产权人</option>
							                  <option value="2">父母</option>
							                  <option value="3">丈夫</option>
							                  <option value="4">妻子</option>
							                  <option value="5">子女</option>
							                  <option value="6">亲戚</option>
							                  <option value="7">其他</option>
							              </select>
							          </td>
							          <td>
							             <input id="name" class="form-control input-xs" type="text" name="name" maxlength="10">
							          </td>
							          <td>
							             <input id="contactType" class="form-control input-xs" type="text" name="contactType" onblur="aihome.validateTel(this);">
							          </td>
						           </tr>
						      </tbody>
						     </table>
							</div>
						</#if>
						<#if houseLeaseResult?exists>
							<div class="col-xs-9">
								<table class="col-xs-12 table-input">
						         <tr>
						             <th style="width:5%">序号</th>
						             <th style="width:30%">联系人类别</th>
						             <th style="width:30%">联系人</th>
						             <th style="width:30%">联系方式</th>
						         </tr>
						         <tbody id="lm_tbody">
						         	<#assign n = 1 />
						            <#list houseLeaseResult.linkManList as item>
							           	<tr id="lm_tr0" class="hasDelete">
							              <td id="lm_tr_cell1" class="cloneList">
							               ${n}
							              </td>
								          <td>
								              <select id="type" class='form-control input-xs' name="type">
								                  <option value="1" <#if item.type==1>selected="selected"</#if>>产权人</option>
								                  <option value="2" <#if item.type==2>selected="selected"</#if>>父母</option>
								                  <option value="3" <#if item.type==3>selected="selected"</#if>>丈夫</option>
								                  <option value="4" <#if item.type==4>selected="selected"</#if>>妻子</option>
								                  <option value="5" <#if item.type==5>selected="selected"</#if>>子女</option>
								                  <option value="6" <#if item.type==6>selected="selected"</#if>>亲戚</option>
								                  <option value="7" <#if item.type==7>selected="selected"</#if>>其他</option>
								              </select>
								          </td>
								          <td>
								             <input id="name" class="form-control input-xs" type="text" name="name" value="${(item.name!'')}">
								          </td>
								          <td>
								             <input id="contactType" class="form-control input-xs" type="text" name="contactType" value="${(item.contactType!'')}">
								          </td>
							           </tr>
							           <#assign n = n+1 /> 
						           </#list>
						      </tbody>
						     </table>
							</div>
						</#if>
						<div class="col-xs-1">
							<input type="button" id="addBut" value="+" class="btn btn-blue btn-white"/>
						</div>
					</div>
					<div class="col-sm-12 form-xs form-group row">
						<div class="col-sm-4">
							<label class="col-xs-4 control-label">使用类别：</label>
					      	<div class="col-xs-7">
					        	<select id="house_useType" class="input-xs form-control" name="house_useType" disabled="true">
					          		<option value="1">住宅</option>
					          		<option value="2">商铺</option>
					          		<option value="3">写字楼</option>
					          		<option value="4" selected="selected">车位</option>
					          	</select>
					      	</div>
						</div>
						<div class="col-sm-4">
							<label class="col-xs-3 control-label">产权性质：</label>
						      <div class="col-xs-7">
						        <select id="carPortPropertyRight" class="input-xs form-control" name="carPortPropertyRight">
						          <option value="">请选择</option>
						          <option value="1">有产权</option>
						          <option value="2">无产权</option>
						         </select>
						      </div>
						</div>
						<div class="col-sm-4">
							<label class="col-xs-3 control-label">意向租金：</label>
						    <div class="col-xs-7">
						        <input id="leasePrice" type="text" class="form-control input-xs checkNum" format="10.2" name="leasePrice" value="${(houseLeaseResult.leasePrice)!''}">
						    </div>
						    <div class="col-xs-2">元/月</div>
						</div>
					</div>
					<div class="col-sm-12 form-xs form-group row">
						<div class="col-sm-4">
							<label class="col-xs-4 control-label">物业费：</label>
						    <div class="col-xs-6">
						        <input type="text" class="form-control input-xs checkNum" format="10.2" name="propertyFee" style="width:118%" value="${(houseLeaseResult.propertyFee)!''}">
						    </div>
						    <div class="col-xs-2" style="left:6%">元/㎡/月</div>
						</div>
						<div class="col-sm-4">
							<label class="col-xs-3 control-label">使用现状：</label>
						    <div class="col-xs-7">
						        <select id="useStatus" class="input-xs form-control" name="useStatus">
						          <option value="">请选择</option>
						          <option value="1">空置</option>
						          <option value="2">出租</option>
						          <option value="3">自住</option>
						        </select>
						    </div>
						</div>
						<div class="col-sm-4">
							<label class="col-xs-3 control-label">房源状态：</label>
							<div class="col-xs-7">
								<select class="input-xs form-control" name="status" disabled="true">
									<option value="1" selected="selected">待租</option>
								</select>
							</div>
						</div>
					</div>
					
				</div>
			</div>
		</div>
		<div class="panel-heading" style="background-color: #A8C9F4;">
			<h4 class="panel-title">
				<a class="accordion-toggle">
					其他信息
				</a>
			</h4>
		</div>
		<div class="panel-collapse">
			<div class="panel-body">
				<div class="modal-body form-horizontal row" style="left: -70px;">
					<div class="col-sm-12 form-xs form-group row">
						<label class="col-xs-2 control-label">业主来源渠道：</label>
						<div class="col-xs-2">
							<select id="parentSource" class="floor input-xs form-control" onchange="aihome.getChildrenSource(this);">
								<option value="">请选择</option>
								<#if parentSourceList?exists>
									<#list parentSourceList as source>
										<option value="${source.id!''}">
											${source.source!''}
										</option>
									</#list>
								</#if>
							</select>
						</div>
						<div class="col-xs-2">
							<select id="childSource" class="floor input-xs form-control" name="childSource">
								<option value="">请选择</option>
							</select>
						</div>
					</div>
					<!-- 房源标签 s -->
					<div class="col-sm-12 form-xs form-group row">
						<label class="col-xs-2 control-label">房源标签：</label>
						<#if sysParamMap.ZLFYBQ??>
							<#list sysParamMap.ZLFYBQ as item>  
						        <div class="col-xs-2">
									<label>
										<input type="checkbox" class="tags ace" value="${item.id!''}">
										<span class="lbl"> ${item.sysHouseDescribe!''}</span>
									</label>
								</div>
								<#if (item_index+1)%5==0>
									<label class="col-xs-2 control-label"></label>
								</#if> 
						    </#list>  
						</#if> 
					</div>
					<!-- 房源标签 e -->
					<div class="col-sm-12 form-xs form-group row">
						<label class="col-xs-2 control-label">备注：</label>
						<div class="col-xs-10">
							<textarea id="remark" rows="5" cols="25" class="form-control" maxlength="300">${(houseLeaseResult.remark)!''}</textarea>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- 隐藏域 S-->
		<input id="preId" type="hidden" value="${(houseLeaseResult.premisesId)!''}"/>
		<input id="carPortId" type="hidden" name="carPortId" value="${(houseLeaseResult.carPortId)!''}"/>
		<input type="hidden" name="houseInfoId" value="${(houseLeaseResult.houseInfoId)!''}">
		<!-- 隐藏域 E-->
	</form>
</div>

<script type="text/javascript">
	aihome.isContactHouseLease = function(){
		$.ajax({
			url: "${CTX}/houseLease/isContactHouseLease.do",
			data:{
				carPortId:$("#carPortId").val()
			},
			type:"post",
			dataType:"json",
			success:function(data){
				if(data.length>0){
					$(".contactHouseLease").html("关联房源："+data[0].code);
				}else{
					$(".contactHouseLease").html("");
				}
			}
		});
	};
	aihome.getCloseBuilding = function(){
		$("#closeBuilding").empty();
		$("#closeBuilding").append("<option value=''>请选择</option>");
		$.ajax({
			url : "${CTX}/houseLease/getBuildingsList.do",
			dataType : "json",
			type : "post",
			async:false,
			data : {
				premisesId : $("#preId").val()
			},
			success : function(data) {
				var html = "";
				if(data.length>0){
					for(var i = 0;i<data.length;i++){
						html+="<option value='"+data[i].id+"'>"+data[i].buildingName+"</option>"
					}
				}
				$("#closeBuilding").append(html);
			}
		});
	};

	$(function(){
		//联系人克隆
		$("#addBut").click(function(){
			var flag = true;
			$("#lm_tbody tr").each(function(){
				var name = $(this).find("input[name='name']").val();
				var contactType = $(this).find("input[name='contactType']").val();
				if(name=="" || contactType==""){
					flag = false;
				}
			});
			if(flag){
				cloneDom({
				    dom:$("#lm_tr0"),//克隆对象
				    target:$("#lm_tbody"),//克隆位置
				    loadBefore: null,
				    callBack: function(a){
				    	$("#lm_tbody tr:first td:last").hide();
				    	$("#lm_tbody select").each(function(i){
				    		if(i!=0){
				    			$(this).attr("disabled",false);
				    		}
				    	}); 
				    	//序号排序
				    	for(var i=1; i<$(".cloneList").length;i++){
				    		$(this).html(i);
				    	}
				    },//克隆后的回调函数，a为克隆完成后的html对象
				    willDelete: function(a){console.log(a)},//删除前回调函数
				    deleteBack: function(){
				    	//序号排序
				    	for(var i=1; i<$(".cloneList").length;i++){
				    		$(this).html(i);
				    	}
				    },//删除后回调函数
				    deleteNoId: false,//行对象是否有ID
				    allDelete:true//是否允许全部删除
				});
			}else{
				alert("请完善联系人和联系方式！");
			}
		});	
		//修改时-初始化联系人操作
		$("#lm_tbody select").eq(0).attr("disabled",true);
		$(".delete").eq(0).hide();
		
		//"使用类别"默认值
		$("#form_useType").find("[value='" + ${(useType)!''} + "']").attr("selected", "selected");
		
		//具体地址模糊查询
	    $("#addrDetail").autocomplete({
			source : function(request, response) {
				$.ajax({
					url : "${CTX}/houseLease/getAddrDetailB.do",
					dataType : "json",
					type : 'post',
					data : {
						matchStr : request.term
					},
					success : function(data) {
						var array = [];
						for (var i = 0; i < data.length; i++) {
							if(data[i].premisesName!=""){
								var temp = {
									value : data[i].addrDetail,//详细地址
									premisesId : data[i].premisesId,//楼盘ID
									premisesName : data[i].premisesName//楼盘名称
								};
								array.push(temp);
							}
						}
						response(array);
					}
				});
			},
			select : function(event, ui) {
				$("#addrDetail").val(ui.item.value);
				$("#preId").val(ui.item.premisesId);
				$("#premisesName").val(ui.item.premisesName);
				event.preventDefault();
				//查询临近栋座
				aihome.getCloseBuilding();
			}
		});
	    $("#addrDetail").blur(function(){
	    	var addrDetail = $("#addrDetail").val();
	    	if(addrDetail==""){
	    		$("#preId").val("");
	    	}
	    });
	    //车位号模糊查询
	    $("#parkNum").autocomplete({
			source : function(request, response) {
				var premisesId = $("#preId").val();
				if(premisesId==""){
					alert("请选择具体地址！");
				}else{
					$.ajax({
						url : "${CTX}/houseLease/getCarPortByMatch.do",
						dataType : "json",
						type : 'post',
						data : {
							matchStr : request.term,
							premisesId : premisesId,
							type : $("#carPortType option:selected").val(),//车位/车库
							floor : $("#carPortFloor option:selected").val()//地上/地下
						},
						success : function(data) {
							var array = [];
							for (var i = 0; i < data.length; i++) {
								var temp = {
									value : data[i].parkNum,
									carPortId : data[i].id//车位ID
								};
								array.push(temp);
							}
							response(array);
						}
					});
				}
			},
			select : function(event, ui) {
				$("#parkNum").val(ui.item.value);
				$("#carPortId").val(ui.item.carPortId);
				event.preventDefault();
				aihome.isContactHouseLease();
			}
		});
	    
	  	//修改-数据初始化
		var carPortType = "${(houseLeaseResult.carPortType)!''}";//车位类型
		if(carPortType!=""){
			$("#carPortType").find("[value='"+carPortType+"']").attr("selected", "selected");
		}
		var carPortFloor = "${(houseLeaseResult.carPortFloor)!''}";//楼层
		if(carPortFloor!=""){
			$("#carPortFloor").find("[value='"+carPortFloor+"']").attr("selected", "selected");
		}
		var carPortPropertyRight = "${(houseLeaseResult.carPortPropertyRight)!''}";//产权性质
		if(carPortPropertyRight!=""){
			$("#carPortPropertyRight").find("[value='"+carPortPropertyRight+"']").attr("selected", "selected");
		}
		var useStatus = "${(houseLeaseResult.useStatus)!''}";//使用现状
		if(useStatus!=""){
			$("#useStatus").find("[value='"+useStatus+"']").attr("selected", "selected");
		}
		var tags = "${(houseLeaseResult.tags)!''}";//房源标签
		if(tags!=""){
			var tagsArray = tags.split(",");
			$(tagsArray).each(function(i){
				$(".tags[value='"+tagsArray[i]+"']").prop("checked", "checked");
			});
		}
		//临近栋座
		var premisesId = "${(houseLeaseResult.premisesId)!''}";
		if(premisesId!=""){
			aihome.getCloseBuilding();
			var closeBuilding = "${(houseLeaseResult.closeBuildingId)!''}";
			if(closeBuilding!=""){
				$("#closeBuilding").find("[value='"+closeBuilding+"']").attr("selected", "selected");
			}
		}
		//业主来源
		var source1 = "${(houseLeaseResult.source1)!''}";
		if(source1!=""){
			aihome.getChildrenSource(source1);
			$("#parentSource").find("[value='"+source1+"']").attr("selected", "selected");//业主来源1
			var source2 = "${(houseLeaseResult.source2)!''}";//业主来源2
			if(source2!=""){
				$("#childSource").find("[value='"+source2+"']").attr("selected", "selected");
			}
		}
		
	});
</script>
			
			
			
			
			
			
			
			