<title>房源管理</title>
<!-- tools S -->
<div id="top_tools" class=" btn-group">
  <button id="house_query" class="btn btn-sm btn-white  confirmBtn">
    <i class="iconfont">&#xe6e4;</i>
    <span>查询</span>
  </button>

  <button id="house_add" class="btn btn-sm btn-white ladda-button">
    <i class="iconfont">&#xe6e0;</i>
    <span>新增</span>
  </button>
  
  <button id="house_comment" class="btn btn-sm btn-white ladda-button">
    <i class="iconfont">&#xe6e0;</i>
    <span>评论</span>
  </button>
  
  <!-- <button id="hosue_recovery" class="btn btn-sm btn-white ladda-button">
    <i class="iconfont">&#xe6e0;</i>
    <span>房源恢复</span>
  </button>
  
  <button id="road_recovery_review" class="btn btn-sm btn-white btn-default">
    <i class="iconfont">&#xe6dd;</i>
    <span>房源恢复审核</span>
  </button> -->
  
</div>
<div class="row">
	<div class="col-xs-12">
	  <div id="tabs" class="tabbable tabbable-lightBlue">
	    <ul class="nav nav-tabs" >
	      <li class="active">
	        <a data-toggle="tab" tabUrl="${CTX}/houseManage/getSellHouseTable.do" tabView="#tab-content1">买卖房源管理</a>
	      </li>
	      <li>
	        <a data-toggle="tab" tabUrl="${CTX}/houseLease/getHouseLeaseTable.do" tabView="#tab-content1">租赁房源管理</a>
	      </li>
	    </ul>
	    <div class="tab-content" id="tab-content1"></div>
	  </div>
	</div> 
</div> 
<div id="house_form" ></div>
<script type="text/javascript">
	 $('.page-content-area').ace_ajax('loadScripts', [null,"../assets/js/bootbox.js"], function () {});
	 
	 var aihome = {
		 fakeType:"1",
		 /* 当前选中tab页下标 (1买卖房源管理 2租赁房源管理)*/
		 getSelTabIndex : function(){
			 var selTabIndex;
			 if($("#tabs ul>li").eq(0).attr("class")=="active"){
				 selTabIndex = 1;
			 }else if($("#tabs ul>li").eq(1).attr("class")=="active"){
				 selTabIndex = 2;
			 }
			 return selTabIndex;
		 },
		 /* 使用类别*/
		 getUseType : function(){
			 var type = $("#useType option:selected").val();
			 return type;
		 },
		 /* 买卖房源弹窗 */
		 openSaleDialog : function(title,url){
			 oaDialogOpen(
				   "saleHouseDialog",{
					url: url,
					closeOnEscpe: true,
				    width : 1300,
				    height: $(window).height()-150,
				    modal : true,
			        title : title,
			        buttons : {
			            "确定" : function() {
			            	var data = $("#house_sale_Form").serialize();
				        	var addrDetail = $("#addrDetail").val();//具体地址
				        	var useType = $("#form_useType option:selected").val();//使用类别
				        	var remark = $("#remark").val();//备注
				        	//判断是否是车位新增
				        	if(useType==4){
				        		var roomId = "";//房间id
				        	}else{
				        		var roomId = $("#roomId").val();//房间id
				        	}
				        	//具体地址必填校验
				        	if(addrDetail==""){
				        		alert("请选择具体地址！");
				        		return;
				        	}
				        	//车位id必填校验
				        	if(useType==4){
				        		var parkNum = $("#parkNum").val();
				        		if(parkNum==""){
				        			alert("请选择车位号！");
				        			return;
				        		}
				        	}
				        	//计算单价
				        	var sellPrice = $("#sellPrice").val();
				        	var coveredArea = $("#coveredArea").val();
				        	var unitPrice = 0;
				        	if(sellPrice!="" && coveredArea!="" && sellPrice!=0){
				        		unitPrice =Math.round((sellPrice*10000)/coveredArea);
				        	}
				        	
				        	var linkmanflag = true;
							$("#lm_tbody tr").each(function(){
								var name = $(this).find("input[name='name']").val();
								var contactType = $(this).find("input[name='contactType']").val();
								if(name=="" || contactType==""){
									linkmanflag = false;
								}
							});
							if(!linkmanflag){
								alert("请完善联系人和联系方式！");
				        		return;
							}
				        	
				        	//业主姓名
				        	var ownerName = $("#lm_tbody tr:first").find("input[name='name']").val();
				        	//业主联系方式
				        	var ownerTel = $("#lm_tbody tr:first").find("input[name='contactType']").val();
				        	
				        	//是否是凶宅haunted
				        	var haunted = "";
				        	var haunted2 = "";
				        	$("input[type=checkbox].haunted:checked").each(function(i){
				        		if(i==0){
				        			haunted = $(this).val();
				        			haunted2 = $(this).next().html();
				        		}else{
				        			haunted += (","+$(this).val());
				        			haunted2 += (","+$(this).next().html());
				        		}
				        	});
				        	//看房方式
				        	var lookWay ="";
				        	var lookWay2="";
				        	$("input[type=checkbox].lookWay:checked").each(function(i){
				        		if(i==0){
				        			lookWay = $(this).val();
				        			lookWay2 = $(this).next().html();
				        		}else{
				        			lookWay += (","+$(this).val());
				        			lookWay2 += (","+$(this).next().html());
				        		}
				        	});
				        	//房源描述
				        	var special = "";
				        	var special2 = "";
				        	$("input[type=checkbox].special:checked").each(function(i){
				        		if(i==0){
				        			special = $(this).val();
				        			special2 = $(this).next().html();
				        		}else{
				        			special += (","+$(this).val());
				        			special2 += (","+$(this).next().html());
				        		}
				        	});
				        	//房源标签
				        	var tags = "";
				        	var tags2 = "";
				        	$("input[type=checkbox].tags:checked").each(function(i){
				        		if(i==0){
				        			tags = $(this).val();
				        			tags2 = $(this).next().html();
				        		}else{
				        			tags += (","+$(this).val());
				        			tags2 += (","+$(this).next().html());
				        		}
				        	});
				        	//联系人
				        	var list =[];
				        	$("#lm_tbody").children().each(function(){
			        			var type = $(this).find("#type  option:selected").val();
								var name = $(this).find("input[name='name']").val();
								var contactType = $(this).find("input[name='contactType']").val();
								var obj='{"type":"'+type+'","name":"'+name+'","contactType":"'+contactType+'"}';
								list.push(obj);
				        	});
				        	
				        	data+="&addrDetail="+addrDetail+"&roomId="+roomId+"&useType="+useType+"&remark="+remark+"&haunted="+haunted+"&ownerName="+ownerName+"&ownerTel="+ownerTel+
				        	"&haunted2="+haunted2+"&lookWay="+lookWay+"&lookWay2="+lookWay2+"&special="+special+"&special2="+special2+"&tags="+tags+"&tags2="+tags2+"&unitPrice="+unitPrice+
				        	"&linkManList="+list.join("-");
				        	//保存房源
				        	$.ajax({
								url : "${CTX}/houseManage/insertHouseSale.do",
								dataType : "json",
								type : "post",
								data : data,
								success : function(data) {
									if(data==1){
										alert("保存成功！");
									}else{
										alert("保存失败！");
									}
								}
							});
				        	$(this).dialog("close");
				        	$("#saleJqGrid").trigger('reloadGrid');
			            },
			            "取消" : function() {
			                $(this).dialog("close");
			            }
			        },
					openCall: function() {
						
					},
					closeCall: function() {
						$(this).empty();
					}
			 });
		 },
		 /* 评论弹窗 */
		 openCommentDialog : function(url){
			 oaDialogOpen(
				   "CommentDialog",{
					url: url,
					closeOnEscpe: true,
				    width : 1100,
				    height: $(window).height()-150,
				    modal : true,
			        title : "房源评论",
			        buttons : {
			            "确定" : function() {
				        	$(this).dialog("close");	
			            },
			            "取消" : function() {
			                $(this).dialog("close");
			            }
			        },
					openCall: function() {
						
					},
					closeCall: function() {
						$(this).empty();
					}
			 });
		 },
		 /* 租赁房源弹窗 */
		 openLeaseDialog : function(title,url){
			 oaDialogOpen(
				   "leaseHouseDialog",{
					url: url,
					closeOnEscpe: true,
				    width : 1300,
				    height: $(window).height()-150,
				    modal : true,
			        title : title,
			        buttons : {
			            "确定" : function() {
			            	var data = $("#house_lease_Form").serialize();
				        	var addrDetail = $("#addrDetail").val();//具体地址
				        	var roomId = $("#roomId").val()!=undefined?$("#roomId").val():"";//房间id
				        	var houseUseType = $("#house_useType option:selected").val();//使用类别
				        	var remark = $("#remark").val();//备注
				        	if(addrDetail==""){
				        		alert("请选择具体地址！");
				        		return;
				        	}
				        	var linkmanflag = true;
							$("#lm_tbody tr").each(function(){
								var name = $(this).find("input[name='name']").val();
								var contactType = $(this).find("input[name='contactType']").val();
								if(name=="" || contactType==""){
									linkmanflag = false;
								}
							});
							if(!linkmanflag){
								alert("请完善联系人和联系方式！");
				        		return;
							}
				        	if(houseUseType==4){
				        		var carportId = $("#carPortId").val();
				        		if(carportId==""){
				        			alert("请选择车位号！");
				        			return;
				        		}
				        	}
				        	//业主姓名
				        	var ownerName = $("#lm_tbody tr:first").find("input[name='name']").val();
				        	//业主联系方式
				        	var ownerTel = $("#lm_tbody tr:first").find("input[name='contactType']").val();
				        	//房屋设施(住宅)
				        	var fwsh = "";
				        	$(".fwsh:checked").each(function(i){
			        	        if(i==0){
			        	        	fwsh = $(this).val();
			        	        }else{
			        	        	fwsh += (","+$(this).val());
			        	        }
		        	        });
				        	//室内家具(住宅)
				        	var furniture = "";
				        	$(".furniture:checked").each(function(i){
				        		if(i==0){
				        			furniture = $(this).val();
				        		}else{
				        			furniture += (","+$(this).val());
				        		}
				        	});
				        	//房源描述
				        	var special = "";
				        	$(".special:checked").each(function(i){
				        		if(i==0){
				        			special = $(this).val();
				        		}else{
				        			special += (","+$(this).val());
				        		}
				        	});
				        	//房源标签
				        	var tags = "";
				        	$(".tags:checked").each(function(i){
				        		if(i==0){
				        			tags = $(this).val();
				        		}else{
				        			tags += (","+$(this).val());
				        		}
				        	});
				        	//看房方式
				        	var lookWay = "";
				        	$(".lookWay:checked").each(function(i){
				        		if(i==0){
				        			lookWay = $(this).val();
				        		}else{
				        			lookWay += (","+$(this).val());
				        		}
				        	});
				        	//适合经营(商铺)
				        	var fitManagement = "";
				        	$(".fitManagement:checked").each(function(i){
				        		if(i==0){
				        			fitManagement = $(this).val();
				        		}else{
				        			fitManagement += (","+$(this).val());
				        		}
				        	});
				        	//联系人
				        	var list =[];
				        	$("#lm_tbody").children().each(function(){
			        			var type = $(this).find("#type option:selected").val();
								var name = $(this).find("input[name='name']").val();
								var contactType = $(this).find("input[name='contactType']").val();
								var obj='{"type":"'+type+'","name":"'+name+'","contactType":"'+contactType+'"}';
								list.push(obj);
				        	});
				        	data+="&addrDetail="+addrDetail+"&roomId="+roomId+"&useType="+houseUseType+"&remark="+remark+"&fwsh="+fwsh+
				        		  "&furniture="+furniture+"&special="+special+"&tags="+tags+"&fitManagement="+fitManagement+"&lookWay="+lookWay+
					        	  "&linkManList="+list.join("-")+"&ownerName="+ownerName+"&ownerTel="+ownerTel;
				        	//保存房源
				        	$.ajax({
								url : "${CTX}/houseLease/saveHouseLease.do",
								dataType : "json",
								type : "post",
								data : data,
								async : false,
								success : function(data) {
									if(data==1){
										alert("保存成功！");
									}else{
										alert("保存失败！");
									}
								}
							});  
				        	$(this).dialog("close");
				        	$("#house_lease_jqGrid").trigger('reloadGrid'); 
			            },
			            "取消" : function() {
			                $(this).dialog("close");
			            }
			        },
					openCall: function() {
						
					},
					closeCall: function() {
						$(this).empty();
					}
			 });
		 },
		 /**联系电话校验*/
		 validateTel : function(element){
			var flag = false;
			var tel = $(element).val();
			if(tel!=""){
				//数字校验  
				var reg = new RegExp("^[0-9]*$");
			    if(reg.test(tel)){  
			        flag = true;
			    }  
				//规则：1开头11位手机号码、0开头12位固定电话
				var firstNumber = tel.substring(0,1);
				if(firstNumber=="0" &&　tel.length==12){
					flag = true;
				}else if(firstNumber=="1"　&&　tel.length==11){
					flag = true;
				}else{
					flag = false;
				}
				if(flag==false){
					alert("请输入11位手机号码或12位固定电话!"); 
					$(element).val("");
				}
			}
		 }
	 };
	 
	 
	 $(function(){
		 /* 新增 */
	     $("#house_add").click(function(){
	    	 var tabIndex = aihome.getSelTabIndex();
			 var useType = aihome.getUseType();
			 var url;
			 var title;
			 if(tabIndex==1){
				 url = "${CTX}/houseManage/getSellAddDialog.do?useType="+useType;
				 title = "买卖房源新增";
			 }else{
				 url = "${CTX}/houseLease/getLeaseAddDialog.do?useType="+useType;
				 title = "租赁房源新增";
			 }
			 if(useType==1){
				 title+="-住宅";
			 }else if(useType==2){
				 title+="-商铺";
			 }else if(useType==3){
				 title+="-写字楼";
			 }else{
				 title+="-车位";
			 }
			 if(tabIndex==1){
				 aihome.openSaleDialog(title,url);
			 }else{
				 aihome.openLeaseDialog(title,url)
			 }
	     });
		 /* 评论 */
	     $("#house_comment").click(function(){
			 var useType = aihome.getUseType();
			 aihome.openCommentDialog("${CTX}/houseManage/getSellCommentDialog.do?useType="+useType);
	     });
	 });
	 
</script>