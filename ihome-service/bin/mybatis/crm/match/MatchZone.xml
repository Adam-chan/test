<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="matchZone" >
	<!-- 分页列表初始化及查询 -->
  <select id="getMatchZonePage" parameterType="map" resultType="matchZoneModel">
	select mz.id as id,mz.name as name,mc.name as categroyName,
	(case when mz.grade = 1 then '一级' when mz.grade = 2 then '二级'
		  when mz.grade = 3 then '三级' when mz.grade = 4 then '四级'
		  when mz.grade = 5 then '五级' end) as grade,
	(case when mz.bussuness_type = 1 then '买卖' 
		  when mz.bussuness_type = 2 then '租赁'
		  when mz.bussuness_type = 3 then '买卖 + 租赁' end) as bussunessType,
	wm_concat(case when mzt.bussiness_type = 1 then mzt.id end) as businessTeamId,
	wm_concat(case when mzt.bussiness_type = 2 then mzt.id end) as leaseTeamId,
	wm_concat(case when mzt.bussiness_type = 1 then mzt.name end) as businessTeamName,
	wm_concat(case when mzt.bussiness_type = 2 then mzt.name end) as leaseTeamName
	from match_zone mz
	left join match_zone_team mzt on mz.id = mzt.match_zone_id
	left join match_category mc on mz.category_id = mc.id
	 <where>
	 	<if test="zoneName!=null and zoneName !='' ">
	 		and mz.name = #{zoneName,jdbcType=VARCHAR}
	 	</if>
	 	
	 	<if test="categoryName!=null and categoryName !='' ">
	 		and mc.name = #{categoryName,jdbcType=VARCHAR}
	 	</if>
	 	
	 	<if test="grade!=null and grade !='' ">
	 		and mz.grade = #{grade,jdbcType=DECIMAL}
	 	</if>
	 </where>
group by mz.id,mz.name,mc.name,mz.grade,mz.bussuness_type
  </select>
  
  <!--查询类别名称 下拉框赋值  -->
  <select id="getCategoryName" parameterType="map" resultType="matchCategoryModel">
  	select mc.name as name ,mc.id as id from match_category mc where mc.status = #{status}
  </select>
  
  <!-- 获取新增赛区树形菜单判断条件参赛层级字段-->
  <select id="getCategoryLayerByName" parameterType="map" resultType="matchCategoryModel">
  	select mc.layer as layer from match_category mc where mc.name=#{name}
  </select>
  
  <!-- 新建赛区 插入match_zone -->
  <insert id="insertIntoMatchZone" parameterType="map">
  	insert into match_zone(
  	id,name,category_id,grade,bussuness_type
  	<if test="remark!=null and remark!='' ">
  	,remark
  	</if>
  	)values(
  	MATCH_ZONE_SEQ.NEXTVAL,#{name,jdbcType=VARCHAR},#{categoryId,jdbcType=DECIMAL},#{grade,jdbcType=DECIMAL},#{bussunessType,jdbcType=DECIMAL}
  	<if test="remark!=null and remark!='' ">
  	,#{remark,jdbcType=VARCHAR}
  	</if>
  	)
  </insert>
  
 <!--  新建赛区 插入match_zone_team -->
  <insert id="insertIntoMatchZoneTeam" parameterType="map">
  	insert into match_zone_team(
  	id,match_zone_id,team_id,bussiness_type,name
  	)values(
  	match_zone_team_seq.nextval,#{matchZoneId,jdbcType=DECIMAL},#{id,jdbcType=DECIMAL},#{bussinessType,jdbcType=DECIMAL},#{name,jdbcType=VARCHAR}
  	)
  </insert>
  
  <!-- 查询新建赛区时插入到match_zone中的赛区id -->
  <select id="selectMatchZoneId" resultType="java.lang.String">
  	select max(id) as id from match_zone
  </select>
  
  <!-- 获取修改页面数据  -->
  <select id="getUpdateMatchZone" parameterType="map" resultType="matchZoneModel">
  	select mz.id as id,mz.name as name,mc.name as categroyName,mz.grade as grade,mz.bussuness_type as bussunessType,mz.remark as remark,
	wm_concat(case when mzt.bussiness_type = 1 then mzt.id end) as businessTeamId,
	wm_concat(case when mzt.bussiness_type = 2 then mzt.id end) as leaseTeamId,
	wm_concat(case when mzt.bussiness_type = 1 then mzt.name end) as businessTeamName,
	wm_concat(case when mzt.bussiness_type = 2 then mzt.name end) as leaseTeamName
	from match_zone mz
	left join match_zone_team mzt on mz.id = mzt.match_zone_id
	left join match_category mc on mz.category_id = mc.id
	where mz.id = #{id}
	group by mz.id,mz.name,mc.name,mz.grade,mz.bussuness_type,mz.remark
  </select>
  
  <!-- 修改 match_zone -->
  <update id="updateMatchZone" parameterType="map">
  	update MATCH_ZONE set 
  	NAME = #{name},
  	CATEGORY_ID = #{categoryId,jdbcType=DECIMAL},
  	GRADE = #{grade,jdbcType=DECIMAL},
  	BUSSUNESS_TYPE = #{bussunessType,jdbcType=DECIMAL},
  	REMARK = #{remark}
  	where ID = #{id,jdbcType=DECIMAL}
  </update>
  
  <!-- 修改 match_zone_team -->
  <update id="updateMatchZoneTeam" parameterType="map">
  	update MATCH_ZONE_TEAM set 
  	TEAM_ID = #{id,jdbcType=DECIMAL},
  	BUSSINESS_TYPE = #{bussinessType,jdbcType=DECIMAL},
  	NAME = #{name}
  	where MATCH_ZONE_ID = #{matchZoneId,jdbcType=DECIMAL}
  </update>
  
  <!-- 删除match_zone -->
  <delete id="deleteMatchZone" parameterType="map">
  	delete from MATCH_ZONE where ID IN (${id})
  </delete>
  
  <!-- 删除match_zone_team -->
  <delete id="deleteMatchZoneTeam" parameterType="map">
  	delete from MATCH_ZONE_TEAM where MATCH_ZONE_ID IN (${id})
  </delete>
  
</mapper>