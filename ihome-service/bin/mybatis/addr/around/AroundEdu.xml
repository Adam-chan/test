<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu">
	<!-- 分页查询教育设施 -->
   	<select id="queryEduPage" parameterType="map" resultType="eduFacilityModel">
		SELECT
			a.id,
			a.name as eduName,
			a.TYPE as eduType,
			a.ROAD_ID as roadId,
			a.PHONE as eduPhone,
			a.INTRODUCE as eduIntroduce,
			a.ENROLLSCOPE as enrollScope,
			a.ENTRANCE_CON as enterCondition,
			a.LNG as lng,
			a.LAT as lat,
			b.ADDR_DETAIL as addrDetail,
			b.AREA_ID as areaId ,
			b.AREA as areaName
		FROM
			AROUND_EDU_FACILITIES a
			left join AREA_ROAD_NUM_ADDR b on a.ROAD_ID =  b.UNITE_ID
		where a.STATUS = 1
			<if test="id != null  and id !=''"> 
		    	 a.id = #{id}
		    </if>
		    <if test="eduName != null  and eduName !=''">
		    	and a.name = #{eduName}
		    </if>
		    <if test="eduType != null  and eduType !=''"> 
		    	and a.TYPE = #{eduType}
		    </if>
		ORDER BY a.id
   	</select>
   	
   	  <!-- 模糊查询教育设施信息 -->
	<select id="getEduNameByMatch" resultType="eduFacilityModel">
		SELECT
			id,
			name as eduName,
			TYPE as eduType
		FROM
			AROUND_EDU_FACILITIES
		<where>  
			<if test="eduId != null  and eduId !=''"> 
		     	id = #{eduId}
		    </if>
			<if test="matchStr != null  and matchStr !=''"> 
		     	and INSTR(NAME, #{matchStr}) > 0
		    </if>
		</where>
		ORDER BY id
   	</select>
   	
   	<!-- 教育设施验证 -->
	<select id="getEduInfo" resultType="eduFacilityModel">
		SELECT
			a.id,
			a.name as eduName,
			a.COPARTSPRIMARY as counterpartsPrimary,
			a.COPARTSMIDDLE as counterpartsMiddle,
			a.TYPE as eduType,
			a.ROAD_ID as roadId,
			a.PHONE as eduPhone,
			a.INTRODUCE as eduIntroduce,
			a.ENROLLSCOPE as enrollScope,
			a.ENTRANCE_CON as enterCondition,
			a.LNG as lng,
			a.LAT as lat,
			b.ADDR_DETAIL as addrDetail,
			b.AREA_ID as areaId,
			b.AREA as areaName
		FROM
			AROUND_EDU_FACILITIES a
			left join AREA_ROAD_NUM_ADDR b on a.ROAD_ID =  b.UNITE_ID
		where a.status = 1
			<if test="eduName != null  and eduName !=''"> 
		        and a.name = #{eduName}
		    </if>
		     <if test="roadId != null  and roadId !=''"> 
		     	and a.ROAD_ID =#{roadId}
		    </if>
		    <if test="eduType != null  and eduType !=''"> 
		     	and a.TYPE =#{eduType}
		    </if>
		    <if test="addrDetail != null  and addrDetail !=''"> 
		     	and b.ADDR_DETAIL =#{addrDetail}
		    </if>
		    <if test="eduId != null  and eduId !=''"> 
		     	and a.id =#{eduId}
		    </if>
   	</select>
   	
   	<!-- 新增教育设施 -->
	<insert id="insertEdu" parameterType="map" useGeneratedKeys="true" >
		<selectKey resultType="java.lang.Integer" order="BEFORE" keyProperty="newEduId">
			SELECT AROUND_EDU_FACILITIES_SEQ.NEXTVAL FROM DUAL
		</selectKey>
       INSERT INTO AROUND_EDU_FACILITIES
       		( ID, NAME,TYPE, ROAD_ID, 
		      PHONE, INTRODUCE, ENROLLSCOPE, 
		      ENTRANCE_CON,STATUS,LNG,LAT
		    <if test="counterpartsPrimary != null  and counterpartsPrimary !=''"> 
		     	,COPARTSPRIMARY
		    </if>
		     <if test="counterpartsMiddle != null  and counterpartsMiddle !=''"> 
		     	,COPARTSMIDDLE
		    </if> 
		     )
        VALUES 
        	( AROUND_EDU_FACILITIES_SEQ.NEXTVAL,#{eduName},#{eduType},#{roadId},
		      #{eduPhone},#{eduIntroduce},#{enrollScope},#{enterCondition},#{status},#{lng},#{lat}
	        <if test="counterpartsPrimary != null  and counterpartsPrimary !=''">
		     	,#{counterpartsPrimary}
		    </if>
		    <if test="counterpartsMiddle != null  and counterpartsMiddle !=''"> 
		     	,#{counterpartsMiddle}
		    </if>
	        )
    </insert>
    
  	  	<!-- 逻辑删除教育设施  修改数据 -->
   	<update id="updateEduStatus" parameterType="map">
	     UPDATE AROUND_EDU_FACILITIES
	      	<set>
				<if test="eduStatus != null and eduStatus != ''">
					 status = #{eduStatus},
				</if>
				<if test="eduName != null and eduName != ''">
					 NAME = #{eduName},
				</if>
				<if test="eduType != null and eduType != ''">
					 TYPE = #{eduType},
				</if>
				<if test="roadId != null and roadId != ''">
					 ROAD_ID = #{roadId},
				</if>
				<if test="eduPhone != null and eduPhone != ''">
					 PHONE = #{eduPhone},
				</if>
				<if test="eduIntroduce != null and eduIntroduce != ''">
					 INTRODUCE = #{eduIntroduce},
				</if>
				<if test="enrollScope != null and enrollScope != ''">
					 ENROLLSCOPE = #{enrollScope},
				</if>
				<if test="enterCondition != null and enterCondition != ''">
					 ENTRANCE_CON = #{enterCondition},
				</if>
				<if test="lng != null and lng != ''">
					 LNG = #{lng},
				</if>
				<if test="lat != null and lat != ''">
					 LAT = #{lat},
				</if>
				<if test="counterpartsPrimary != null and counterpartsPrimary != ''">
					 COPARTSPRIMARY = #{counterpartsPrimary},
				</if>
				<if test="counterpartsMiddle != null and counterpartsMiddle != ''">
					 COPARTSMIDDLE = #{counterpartsMiddle},
				</if>
	      	</set>
	     WHERE id in(${eduId})   
	</update>
	
		
   	<!-- 新增教育设施图片 -->
	<insert id="insertEduImg" parameterType="map">
       INSERT INTO AROUND_EDU_IMG
       		( ID,FOLDER_NAME,FILE_NAME, CREATE_TIME, 
		      EDU_ID)
		 SELECT AROUND_EDU_IMG_SEQ.NEXTVAL,a.*,#{createTime},#{eduNewId} from (
	    <foreach collection="file" item="item" index="index" separator="UNION ALL" >
	    	SELECT 
	        	#{item.folderName},#{item.fileName}
	        FROM DUAL
	    </foreach>)a
    </insert>
    
     	<!-- 教育设施查询图片 -->
	<select id="getEduImg" parameterType="map" resultType="aroundEduImgModel">
       SELECT
			ID,
			FOLDER_NAME as folderName,
			FILE_NAME as fileName, 
			CREATE_TIME as createTime, 
		    EDU_ID as eduId
		FROM
			AROUND_EDU_IMG
		<where>  
			<if test="eduId != null  and eduId !=''"> 
		     	EDU_ID = #{eduId}
		    </if>
		</where>
		ORDER BY id
    </select>
    
      <!-- 教育设施图片删除 -->
   <delete id="deleteEduImg" parameterType="map" >
    	delete from AROUND_EDU_IMG
   	 	where EDU_ID = #{eduId}
  </delete>
  
  	<!-- 根据楼盘id拼接周边教育设施名称 -->
    <select id="getEduNameConcat" parameterType="java.lang.String" resultType="java.lang.String">
       SELECT
			wm_concat(NAME)
		FROM
			around_edu_facilities
		WHERE
			id IN (${_parameter})
    </select>
</mapper>