<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="addrDist">

	<!-- 道路 -->
	<select id="getRoadList" parameterType="map" resultType="map">
		SELECT
			AR.ID AS ID,
			AR.NAME AS NAME
		FROM
			AREA_ROAD AR
		INNER JOIN
			AREA_ROAD_NUM ARN
		ON
			AR.ID = ARN.ROAD_ID AND
			ARN.AREA_ID = #{areaId}
		GROUP BY
			AR.ID,
			AR.NAME
		ORDER BY
			AR.ID
	</select>

	<!-- 模糊匹配楼盘 -->
	<select id="getPremisesListByMatch" parameterType="map" resultType="map">
		SELECT
			*
		FROM
		(
			SELECT
				TMP_TB.*,
				ROWNUM ROW_ID
			FROM
			(
				SELECT
					BP.ID AS ID,
					BP.NAME AS NAME
				FROM
					BASE_PREMISES BP
				WHERE
					1 = 1
				<if test="matchStr != null and matchStr !=''"> 
					AND INSTR(BP.NAME, #{matchStr}) > 0
				</if>
				ORDER BY
					BP.ID
			) TMP_TB
			WHERE
				ROWNUM &lt; 31
		)
		WHERE
			ROW_ID &gt;= 1
	</select>

	<!-- 楼栋分组 -->
	<select id="getGroup" parameterType="map" resultType="map">
		SELECT
			BG.ID AS ID,
			BG.GROUP_NAME AS NAME
		FROM
			BUILDING_GROUP BG
		WHERE
			BG.PREMISES_ID = #{premisesId}
		UNION ALL
		SELECT
			100000000000 AS ID,
			'未分组' AS NAME
		FROM
			BASE_BUILDING BB
		WHERE
			BB.PREMISES_ID = #{premisesId} AND
			BB.BUILDING_GROUP_ID IS NULL
		GROUP BY
			0
	</select>

	<!-- 楼栋 -->
	<select id="getBuilding" parameterType="map" resultType="map">
		SELECT
			BB.ID AS ID,
			BB.BUILDING_NAME AS NAME
		FROM
			BASE_BUILDING BB
		WHERE
			BB.PREMISES_ID = #{premisesId} AND
		<if test="groupId != null and groupId !='' and groupId != '100000000000'"> 
			BB.BUILDING_GROUP_ID = #{groupId}
		</if>
		<if test="groupId == '100000000000'"> 
			BB.BUILDING_GROUP_ID IS NULL
		</if>
		ORDER BY
			BB.ID
	</select>

	<!-- 单元/商铺 -->
	<select id="getUnit" parameterType="map" resultType="map">
		SELECT
			BU.ID AS ID,
			BB.UNIT_PRE || BU.CODE || BB.UNIT_SUF AS NAME
		FROM
			BUILDING_UNITS BU
		INNER JOIN
			BASE_BUILDING BB
		ON
			BU.PREMISES_ID = BB.PREMISES_ID AND
			BU.BUILDING_ID = BB.ID
		WHERE
			BU.PREMISES_ID = #{premisesId} AND
			BU.BUILDING_ID = #{buildingId}
		UNION ALL
		SELECT
			100000000000 AS ID,
			'商铺' AS CODE
		FROM
			BASE_HOUSE BH
		INNER JOIN
			BASE_BUILDING BB
		ON
			BH.PREMISES_ID = BB.PREMISES_ID AND
			BH.BUILDING_ID = BB.ID
		WHERE
			BH.PREMISES_ID = #{premisesId} AND
			BH.BUILDING_ID = #{buildingId} AND
			BH.PURPOSE = 2
		GROUP BY
			0
		ORDER BY
			ID
	</select>

	<!-- 地址库列表分页 -->
	<select id="getSaleAddrDistListPage" parameterType="map" resultType="distModel">
		SELECT
			BA.ID AS AREAID,
			BA.NAME AS AREANAME,
			BP.SUBDISTRICT_ID AS SUBDISTRICTID,
			ASUB.NAME AS SUBDISTRICTNAME,
			BP.COMMUNITY_ID AS COMMUNITYID,
			ACOM.NAME AS COMMUNITYNAME,
			AR.NAME || ' ' || ARN.NUM AS ROADADDR,
			BP.ID AS PREMISESID,
			BP.NAME AS PREMISESNAME,
			<if test="hierarchyType == 2 or hierarchyType == 3 or hierarchyType == 4">
			<if test="hierarchyType != 4 or groupId != '100000000000'">
			BG.ID AS GROUPID,
			BG.GROUP_NAME AS GROUPNAME,
			</if>
			<if test="hierarchyType == 3 or hierarchyType == 4">
			BB.ID AS BUILDINGID,
			BB.BUILDING_NAME AS BUILDINGNAME,
			</if>
			<if test="hierarchyType == 4">
			BUH.ID AS UNITID,
			CASE WHEN BUH.TYPE = 'BU' THEN BB.UNIT_PRE || BUH.CODE || BB.UNIT_SUF || '（单元）' ELSE BUH.CODE || '（商铺）' END AS UNITCODE,
			</if>
			</if>
			<if test="hierarchyType != 2 and hierarchyType != 3 and hierarchyType != 4">
			DS.AREA_NAME AS DUTYAREA,
			DS.ZONE_NAME AS DUTYZONE,
			DS.GROUP_NAME AS DUTYGROUP,
			DS.USER_NAME AS USERNAME,
			TO_CHAR(DS.OPERATE_DATE, 'YYYY-MM-DD HH24:MI') AS OPERATEDATE,
			1 AS DATATYPE
			</if>
			<if test="hierarchyType == 2">
			NVL(DS.AREA_NAME, DSP.AREA_NAME) AS DUTYAREA,
			NVL(DS.ZONE_NAME, DSP.ZONE_NAME) AS DUTYZONE,
			NVL(DS.GROUP_NAME, DSP.GROUP_NAME) AS DUTYGROUP,
			NVL(DS.USER_NAME, DSP.USER_NAME) AS USERNAME,
			TO_CHAR(NVL(DS.OPERATE_DATE, DSP.OPERATE_DATE), 'YYYY-MM-DD HH24:MI') AS OPERATEDATE,
			${hierarchyType} AS DATATYPE
			</if>
			<if test="hierarchyType == 3">
			NVL(DS.AREA_NAME, NVL(DSG.AREA_NAME, DSP.AREA_NAME)) AS DUTYAREA,
			NVL(DS.ZONE_NAME, NVL(DSG.ZONE_NAME, DSP.ZONE_NAME)) AS DUTYZONE,
			NVL(DS.GROUP_NAME, NVL(DSG.GROUP_NAME, DSP.GROUP_NAME)) AS DUTYGROUP,
			NVL(DS.USER_NAME, NVL(DSG.USER_NAME, DSP.USER_NAME)) AS USERNAME,
			TO_CHAR(NVL(DS.OPERATE_DATE, NVL(DSG.OPERATE_DATE, DSP.OPERATE_DATE)), 'YYYY-MM-DD HH24:MI') AS OPERATEDATE,
			${hierarchyType} AS DATATYPE
			</if>
			<if test="hierarchyType == 4 and groupId != '100000000000'">
			NVL(DS.AREA_NAME, NVL(DSB.AREA_NAME, NVL(DSG.AREA_NAME, DSP.AREA_NAME))) AS DUTYAREA,
			NVL(DS.ZONE_NAME, NVL(DSB.ZONE_NAME, NVL(DSG.ZONE_NAME, DSP.ZONE_NAME))) AS DUTYZONE,
			NVL(DS.GROUP_NAME, NVL(DSB.GROUP_NAME, NVL(DSG.GROUP_NAME, DSP.GROUP_NAME))) AS DUTYGROUP,
			NVL(DS.USER_NAME, NVL(DSB.USER_NAME, NVL(DSG.USER_NAME, DSP.USER_NAME))) AS USERNAME,
			TO_CHAR(NVL(DS.OPERATE_DATE, NVL(DSB.OPERATE_DATE, NVL(DSG.OPERATE_DATE, DSP.OPERATE_DATE))), 'YYYY-MM-DD HH24:MI') AS OPERATEDATE,
			CASE WHEN BUH.TYPE = 'BU' THEN ${hierarchyType} ELSE 6 END AS DATATYPE
			</if>
			<if test="hierarchyType == 4 and groupId == '100000000000'">
			NVL(DS.AREA_NAME, NVL(DSB.AREA_NAME, DSP.AREA_NAME)) AS DUTYAREA,
			NVL(DS.ZONE_NAME, NVL(DSB.ZONE_NAME, DSP.ZONE_NAME)) AS DUTYZONE,
			NVL(DS.GROUP_NAME, NVL(DSB.GROUP_NAME, DSP.GROUP_NAME)) AS DUTYGROUP,
			NVL(DS.USER_NAME, NVL(DSB.USER_NAME, DSP.USER_NAME)) AS USERNAME,
			TO_CHAR(NVL(DS.OPERATE_DATE, NVL(DSB.OPERATE_DATE, DSP.OPERATE_DATE)), 'YYYY-MM-DD HH24:MI') AS OPERATEDATE,
			CASE WHEN BUH.TYPE = 'BU' THEN ${hierarchyType} ELSE 6 END AS DATATYPE
			</if>
		FROM
			BASE_PREMISES BP
		INNER JOIN
			AREA_ROAD_NUM ARN
		ON
			BP.ROAD_ID = ARN.UNITE_ID
		LEFT JOIN
			AREA_ROAD AR
		ON
			ARN.ROAD_ID = AR.ID
		LEFT JOIN
			BASE_AREA BA
		ON
			ARN.AREA_ID = BA.ID
		LEFT JOIN
			BUSI_AREA BUA
		ON
			BP.BUSI_AREA_ID = BUA.ID
		LEFT JOIN
			AREA_SUBDISTRICT ASUB
		ON
			BP.SUBDISTRICT_ID = ASUB.ID
		LEFT JOIN
			AREA_COMMUNITY ACOM
		ON
			BP.COMMUNITY_ID = ACOM.ID
		<if test="hierarchyType == 2 or hierarchyType == 3 or hierarchyType == 4">
		<if test="hierarchyType == 3 or hierarchyType == 4">
		INNER JOIN
			BASE_BUILDING BB
		ON
			BP.ID = BB.PREMISES_ID
		</if>
		<if test="hierarchyType == 4">
		INNER JOIN
			(
				SELECT
					BU.ID AS ID,
					BU.CODE AS CODE,
					BU.BUILDING_ID AS BUILDING_ID,
					'BU' AS TYPE
				FROM
					BUILDING_UNITS BU
				UNION ALL
				SELECT
					BH.ID AS ID,
					BH.HOUSE_NAME AS CODE,
					BH.BUILDING_ID AS BUILDING_ID,
					'BH' AS TYPE
				FROM
					BASE_HOUSE BH
				WHERE
					BH.PURPOSE = 2
			) BUH
		ON
			BB.ID = BUH.BUILDING_ID
		</if>
		<if test="hierarchyType == 2">
		INNER JOIN
		</if>
		<if test="hierarchyType == 3 or (hierarchyType == 4 and groupId != '100000000000')">
		LEFT JOIN
		</if>
		<if test="hierarchyType != 4 or groupId != '100000000000'">
			BUILDING_GROUP BG
		ON
			BP.ID = BG.PREMISES_ID
		</if>
		<if test="hierarchyType == 3 or (hierarchyType == 4 and groupId != '100000000000')">
			AND BB.BUILDING_GROUP_ID = BG.ID
		</if>
		</if>
		LEFT JOIN
			DUTY_SALE DS
		ON
		<if test="hierarchyType != 2 and hierarchyType != 3 and hierarchyType != 4">
			DS.DATA_ID = BP.ID AND
			DS.TYPE = 1
		</if>
		<if test="hierarchyType == 2">
			DS.DATA_ID = BG.ID AND
			DS.TYPE = 2
		</if>
		<if test="hierarchyType == 3">
			DS.DATA_ID = BB.ID AND
			DS.TYPE = 3
		</if>
		<if test="hierarchyType == 4">
			(DS.DATA_ID = BUH.ID AND DS.TYPE = 4) OR
			(DS.DATA_ID = BUH.ID AND DS.TYPE = 6)
		</if>
		<if test="hierarchyType == 2 or hierarchyType == 3 or hierarchyType == 4">
		LEFT JOIN
			DUTY_SALE DSP
		ON
			DSP.DATA_ID = BP.ID AND
			DSP.TYPE = 1
		</if>
		<if test="hierarchyType == 3 or (hierarchyType == 4 and groupId != '100000000000')">
		LEFT JOIN
			DUTY_SALE DSG
		ON
			DSG.DATA_ID = BG.ID AND
			DSG.TYPE = 2
		</if>
		<if test="hierarchyType == 4">
		LEFT JOIN
			DUTY_SALE DSB
		ON
			DSB.DATA_ID = BB.ID AND
			DSB.TYPE = 3
		</if>
		WHERE
			BP.FLAG = 1
		<if test="areaId != null and areaId != ''">
			AND BA.ID = #{areaId}
		</if>
		<if test="busiAreaParentId != null and busiAreaParentId != '' and (busiAreaId == null or busiAreaId == '')">
			AND (BUA.ID = #{busiAreaParentId} OR BUA.PARENT_ID = #{busiAreaParentId})
		</if>
		<if test="busiAreaId != null and busiAreaId != ''">
			AND BUA.ID = #{busiAreaId}
		</if>
		<if test="subdistrictId != null and subdistrictId != ''">
			AND ASUB.ID = #{subdistrictId}
		</if>
		<if test="communityId != null and communityId != ''">
			AND ACOM.ID = #{communityId}
		</if>
		<if test="roadId != null and roadId != ''">
			AND ARN.ROAD_ID = #{roadId}
		</if>
		<if test="roadNumFrom != null and roadNumFrom != ''">
			AND ARN.NUM &gt;= #{roadNumFrom}
		</if>
		<if test="roadNumTo != null and roadNumTo != ''">
			AND ARN.NUM &lt;= #{roadNumTo}
		</if>
		<if test="premisesId != null and premisesId != ''">
			AND BP.ID = #{premisesId}
		</if>
		<if test="(hierarchyType == 2 or hierarchyType == 3 or hierarchyType == 4) and groupId != null and groupId != '' and groupId != '100000000000'">
			AND BG.ID = #{groupId}
		</if>
		<if test="hierarchyType == 2 and groupId == '100000000000'">
			AND BG.ID = #{groupId}
		</if>
		<if test="(hierarchyType == 3 or hierarchyType == 4) and groupId == '100000000000'">
			AND BB.BUILDING_GROUP_ID IS NULL
		</if>
		<if test="(hierarchyType == 3 or hierarchyType == 4) and buildingId != null and buildingId != ''">
			AND BB.ID = #{buildingId}
		</if>
		<if test="hierarchyType == 4 and unitId != null and unitId != '' and unitId != '100000000000'">
			AND BUH.ID = #{unitId}
		</if>
		<if test="hierarchyType == 4 and unitId == '100000000000'">
			AND BUH.TYPE = 'BH'
		</if>
		<if test="completeStatus == 1">
			AND DS.ORG_LEVEL IS NULL
		</if>
		<if test="completeStatus == 2">
			AND DS.ORG_LEVEL = 1
		</if>
		<if test="completeStatus == 3">
			AND DS.ORG_LEVEL = 2
		</if>
		<if test="completeStatus == 4">
			AND DS.ORG_LEVEL = 3
		</if>
		<if test="completeStatus == 5">
			AND DS.ORG_LEVEL IS NOT NULL
		</if>
		<if test="status != null and status != ''">
			AND BP.STATUS = #{status}
		</if>
		<if test="dutyAreaId != null and dutyAreaId != ''">
			<if test="dutyZoneId != null and dutyZoneId != ''">
				<if test="dutyGroupId != null and dutyGroupId != ''">
					<if test="userId != null and userId != ''">
						AND DS.USER_ID = #{userId}
					</if>
					<if test="userId == null or userId == ''">
						AND DS.ORG_CODE = #{dutyGroupId}
					</if>
				</if>
				<if test="dutyGroupId == null or dutyGroupId == ''">
					AND DS.ORG_CODE = #{dutyZoneId}
				</if>
			</if>
			<if test="dutyZoneId == null or dutyZoneId == ''">
				AND DS.ORG_CODE = #{dutyAreaId}
			</if>
		</if>
		<if test="busiAreaId != null and busiAreaId != ''">
		</if>
		<if test="maintenanceCategory != null and maintenanceCategory != ''">
			AND BP.MAINTENANCE_CATEGORY = #{maintenanceCategory}
		</if>
		ORDER BY
			BP.ID
		<if test="hierarchyType == 2">
			,BG.ID
		</if>
		<if test="hierarchyType == 3">
			,BG.ID,BB.ID
		</if>
		<if test="hierarchyType == 4 and groupId != '100000000000'">
			,BG.ID,BB.ID,BUH.ID
		</if>
		<if test="hierarchyType == 4 and groupId == '100000000000'">
			,BB.ID,BUH.ID
		</if>
	</select>

	<!-- 原分配 -->
	<select id="oldSaleAssignment" parameterType="map" resultType="map">
		SELECT
			ID AS ID,
			DS.AREA_NAME || NVL2(DS.ZONE_NAME, ' ' || DS.ZONE_NAME, '') || NVL2(DS.GROUP_NAME, ' ' || DS.GROUP_NAME, '') || NVL2(DS.USER_NAME, ' ' || DS.USER_NAME, '') AS OLDASSIGNMENT
		FROM
			DUTY_SALE DS
		WHERE
			DS.TYPE = #{dataType} AND
			DS.DATA_ID = #{dataId}
	</select>

	<!-- 上一级组织结构 -->
	<select id="lastSaleOrg" parameterType="map" resultType="java.lang.String">
		SELECT
			<if test="dataType == 2">
			DSP.ORG_CODE AS LASTASSIGNMENT
			</if>
			<if test="dataType == 3">
				<if test="dataGroupId != null and dataGroupId != ''">
				NVL(DSG.ORG_CODE, DSP.ORG_CODE) AS LASTASSIGNMENT
				</if>
				<if test="dataGroupId == null or dataGroupId == ''">
				DSP.ORG_CODE AS LASTASSIGNMENT
				</if>
			</if>
			<if test="dataType == 4 or dataType == 6">
				<if test="dataGroupId != null and dataGroupId != ''">
				NVL(DSB.ORG_CODE, NVL(DSG.ORG_CODE, DSP.ORG_CODE)) AS LASTASSIGNMENT
				</if>
				<if test="dataGroupId == null or dataGroupId == ''">
				NVL(DSB.ORG_CODE, DSP.ORG_CODE) AS LASTASSIGNMENT
				</if>
			</if>
		FROM
			DUTY_SALE DSP
		<if test="dataType != 1 and dataType != 2">
		LEFT JOIN
			DUTY_SALE DSG
		ON
			DSG.TYPE = 2 AND
			DSG.DATA_ID = #{dataGroupId}
		</if>
		<if test="dataType == 4 or dataType == 6">
		LEFT JOIN
			DUTY_SALE DSB
		ON
			DSB.TYPE = 3 AND
			DSB.DATA_ID = #{dataBuildingId}
		</if>
		WHERE
			DSP.TYPE = 1 AND
			DSP.DATA_ID = #{dataPremisesId}
	</select>

	<!-- 下属层级是否被分配 -->
	<select id="nextSaleAssignment" parameterType="map" resultType="java.lang.String">
		SELECT
			COUNT(0) AS NEXTASSIGNMENT
		FROM
			DUTY_SALE DS
		WHERE
			<if test="dataType == 1">
			(DS.TYPE = 2 OR DS.TYPE = 3 OR DS.TYPE = 4 OR DS.TYPE = 6) AND
			DS.BP_ID = #{dataPremisesId}
			</if>
			<if test="dataType == 2">
			(DS.TYPE = 3 OR DS.TYPE = 4 OR DS.TYPE = 6) AND
			DS.BG_ID = #{dataGroupId}
			</if>
			<if test="dataType == 3">
			(DS.TYPE = 4 OR DS.TYPE = 6) AND
			DS.BB_ID = #{dataBuildingId}
			</if>
	</select>

	<!-- 添加分配 -->
	<insert id="addSaleAssignment" useGeneratedKeys="true" parameterType="map">
		<selectKey resultType="java.lang.Integer" order="BEFORE" keyProperty="dutySaleId">
			SELECT DUTY_SALE_SEQ.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO
			DUTY_SALE
		(
			ID,
			TYPE,
			DATA_ID,
			ORG_LEVEL,
			ORG_CODE,
			<if test="userId != null and userId != ''">
			USER_ID,
			</if>
			<if test="userName != null and userName != ''">
			USER_NAME,
			</if>
			BP_ID,
			<if test="groupId != null and groupId != ''">
			BG_ID,
			</if>
			<if test="buildingId != null and buildingId != ''">
			BB_ID,
			</if>
			<if test="dataType == 4">
			BU_ID,
			</if>
			<if test="dataType == 6">
			BH_ID,
			</if>
			AREA_NAME,
			<if test="zoneName != null and zoneName != ''">
			ZONE_NAME,
			</if>
			<if test="groupName != null and groupName != ''">
			GROUP_NAME,
			</if>
			OPERATE_DATE
		)
		VALUES
		(
			#{dutySaleId},
			#{dataType},
			#{dataId},
			#{orgLevel},
			#{orgCode},
			<if test="userId != null and userId != ''">
			#{userId},
			</if>
			<if test="userName != null and userName != ''">
			#{userName},
			</if>
			#{premisesId},
			<if test="groupId != null and groupId != ''">
			#{groupId},
			</if>
			<if test="buildingId != null and buildingId != ''">
			#{buildingId},
			</if>
			<if test="dataType == 4">
			#{unitId},
			</if>
			<if test="dataType == 6">
			#{unitId},
			</if>
			#{areaName},
			<if test="zoneName != null and zoneName != ''">
			#{zoneName},
			</if>
			<if test="groupName != null and groupName != ''">
			#{groupName},
			</if>
			#{operateDate}
		)
	</insert>

	<!-- 修改分配 -->
	<update id="updateSaleAssignment" parameterType="map">
		UPDATE
			DUTY_SALE
		SET
			ORG_LEVEL = #{orgLevel},
			ORG_CODE = #{orgCode},
			<if test="userId != null and userId != ''">
			USER_ID = #{userId},
			</if>
			<if test="userName != null and userName != ''">
			USER_NAME = #{userName},
			</if>
			AREA_NAME = #{areaName},
			<if test="zoneName != null and zoneName != ''">
			ZONE_NAME = #{zoneName},
			</if>
			<if test="groupName != null and groupName != ''">
			GROUP_NAME = #{groupName},
			</if>
			OPERATE_DATE = #{operateDate}
		WHERE
			ID = #{dutySaleId}
	</update>

	<!-- 删除分配 -->
	<delete id="deleteSaleAssignment" parameterType="map">
		DELETE
			DUTY_SALE
		WHERE
			<if test="dataType == 1">
			TYPE &lt;&gt; 1 AND
			BP_ID = #{premisesId}
			</if>
			<if test="dataType == 2">
			TYPE &lt;&gt; 1 AND
			TYPE &lt;&gt; 2 AND
			BG_ID = #{groupId}
			</if>
			<if test="dataType == 3">
			(TYPE = 4 OR TYPE = 6) AND
			BB_ID = #{buildingId}
			</if>
	</delete>

	<!-- 地址库列表分页 -->
	<select id="getLeaseAddrDistListPage" parameterType="map" resultType="distModel">
		SELECT
			BA.ID AS AREAID,
			BA.NAME AS AREANAME,
			BP.SUBDISTRICT_ID AS SUBDISTRICTID,
			ASUB.NAME AS SUBDISTRICTNAME,
			BP.COMMUNITY_ID AS COMMUNITYID,
			ACOM.NAME AS COMMUNITYNAME,
			AR.NAME || ' ' || ARN.NUM AS ROADADDR,
			BP.ID AS PREMISESID,
			BP.NAME AS PREMISESNAME,
			<if test="hierarchyType == 2 or hierarchyType == 3 or hierarchyType == 4">
			<if test="hierarchyType != 4 or groupId != '100000000000'">
			BG.ID AS GROUPID,
			BG.GROUP_NAME AS GROUPNAME,
			</if>
			<if test="hierarchyType == 3 or hierarchyType == 4">
			BB.ID AS BUILDINGID,
			BB.BUILDING_NAME AS BUILDINGNAME,
			</if>
			<if test="hierarchyType == 4">
			BUH.ID AS UNITID,
			CASE WHEN BUH.TYPE = 'BU' THEN BB.UNIT_PRE || BUH.CODE || BB.UNIT_SUF || '（单元）' ELSE BUH.CODE || '（商铺）' END AS UNITCODE,
			</if>
			</if>
			<if test="hierarchyType != 2 and hierarchyType != 3 and hierarchyType != 4">
			DL.AREA_NAME AS DUTYAREA,
			DL.ZONE_NAME AS DUTYZONE,
			DL.GROUP_NAME AS DUTYGROUP,
			DL.USER_NAME AS USERNAME,
			TO_CHAR(DL.OPERATE_DATE, 'YYYY-MM-DD HH24:MI') AS OPERATEDATE,
			1 AS DATATYPE
			</if>
			<if test="hierarchyType == 2">
			NVL(DL.AREA_NAME, DLP.AREA_NAME) AS DUTYAREA,
			NVL(DL.ZONE_NAME, DLP.ZONE_NAME) AS DUTYZONE,
			NVL(DL.GROUP_NAME, DLP.GROUP_NAME) AS DUTYGROUP,
			NVL(DL.USER_NAME, DLP.USER_NAME) AS USERNAME,
			TO_CHAR(NVL(DL.OPERATE_DATE, DLP.OPERATE_DATE), 'YYYY-MM-DD HH24:MI') AS OPERATEDATE,
			${hierarchyType} AS DATATYPE
			</if>
			<if test="hierarchyType == 3">
			NVL(DL.AREA_NAME, NVL(DLG.AREA_NAME, DLP.AREA_NAME)) AS DUTYAREA,
			NVL(DL.ZONE_NAME, NVL(DLG.ZONE_NAME, DLP.ZONE_NAME)) AS DUTYZONE,
			NVL(DL.GROUP_NAME, NVL(DLG.GROUP_NAME, DLP.GROUP_NAME)) AS DUTYGROUP,
			NVL(DL.USER_NAME, NVL(DLG.USER_NAME, DLP.USER_NAME)) AS USERNAME,
			TO_CHAR(NVL(DL.OPERATE_DATE, NVL(DLG.OPERATE_DATE, DLP.OPERATE_DATE)), 'YYYY-MM-DD HH24:MI') AS OPERATEDATE,
			${hierarchyType} AS DATATYPE
			</if>
			<if test="hierarchyType == 4 and groupId != '100000000000'">
			NVL(DL.AREA_NAME, NVL(DLB.AREA_NAME, NVL(DLG.AREA_NAME, DLP.AREA_NAME))) AS DUTYAREA,
			NVL(DL.ZONE_NAME, NVL(DLB.ZONE_NAME, NVL(DLG.ZONE_NAME, DLP.ZONE_NAME))) AS DUTYZONE,
			NVL(DL.GROUP_NAME, NVL(DLB.GROUP_NAME, NVL(DLG.GROUP_NAME, DLP.GROUP_NAME))) AS DUTYGROUP,
			NVL(DL.USER_NAME, NVL(DLB.USER_NAME, NVL(DLG.USER_NAME, DLP.USER_NAME))) AS USERNAME,
			TO_CHAR(NVL(DL.OPERATE_DATE, NVL(DLB.OPERATE_DATE, NVL(DLG.OPERATE_DATE, DLP.OPERATE_DATE))), 'YYYY-MM-DD HH24:MI') AS OPERATEDATE,
			CASE WHEN BUH.TYPE = 'BU' THEN ${hierarchyType} ELSE 6 END AS DATATYPE
			</if>
			<if test="hierarchyType == 4 and groupId == '100000000000'">
			NVL(DL.AREA_NAME, NVL(DLB.AREA_NAME, DLP.AREA_NAME)) AS DUTYAREA,
			NVL(DL.ZONE_NAME, NVL(DLB.ZONE_NAME, DLP.ZONE_NAME)) AS DUTYZONE,
			NVL(DL.GROUP_NAME, NVL(DLB.GROUP_NAME, DLP.GROUP_NAME)) AS DUTYGROUP,
			NVL(DL.USER_NAME, NVL(DLB.USER_NAME, DLP.USER_NAME)) AS USERNAME,
			TO_CHAR(NVL(DL.OPERATE_DATE, NVL(DLB.OPERATE_DATE, DLP.OPERATE_DATE)), 'YYYY-MM-DD HH24:MI') AS OPERATEDATE,
			CASE WHEN BUH.TYPE = 'BU' THEN ${hierarchyType} ELSE 6 END AS DATATYPE
			</if>
		FROM
			BASE_PREMISES BP
		INNER JOIN
			AREA_ROAD_NUM ARN
		ON
			BP.ROAD_ID = ARN.UNITE_ID
		LEFT JOIN
			AREA_ROAD AR
		ON
			ARN.ROAD_ID = AR.ID
		LEFT JOIN
			BASE_AREA BA
		ON
			ARN.AREA_ID = BA.ID
		LEFT JOIN
			BUSI_AREA BUA
		ON
			BP.BUSI_AREA_ID = BUA.ID
		LEFT JOIN
			AREA_SUBDISTRICT ASUB
		ON
			BP.SUBDISTRICT_ID = ASUB.ID
		LEFT JOIN
			AREA_COMMUNITY ACOM
		ON
			BP.COMMUNITY_ID = ACOM.ID
		<if test="hierarchyType == 2 or hierarchyType == 3 or hierarchyType == 4">
		<if test="hierarchyType == 3 or hierarchyType == 4">
		INNER JOIN
			BASE_BUILDING BB
		ON
			BP.ID = BB.PREMISES_ID
		</if>
		<if test="hierarchyType == 4">
		INNER JOIN
			(
				SELECT
					BU.ID AS ID,
					BU.CODE AS CODE,
					BU.BUILDING_ID AS BUILDING_ID,
					'BU' AS TYPE
				FROM
					BUILDING_UNITS BU
				UNION ALL
				SELECT
					BH.ID AS ID,
					BH.HOUSE_NAME AS CODE,
					BH.BUILDING_ID AS BUILDING_ID,
					'BH' AS TYPE
				FROM
					BASE_HOUSE BH
				WHERE
					BH.PURPOSE = 2
			) BUH
		ON
			BB.ID = BUH.BUILDING_ID
		</if>
		<if test="hierarchyType == 2">
		INNER JOIN
		</if>
		<if test="hierarchyType == 3 or (hierarchyType == 4 and groupId != '100000000000')">
		LEFT JOIN
		</if>
		<if test="hierarchyType != 4 or groupId != '100000000000'">
			BUILDING_GROUP BG
		ON
			BP.ID = BG.PREMISES_ID
		</if>
		<if test="hierarchyType == 3 or (hierarchyType == 4 and groupId != '100000000000')">
			AND BB.BUILDING_GROUP_ID = BG.ID
		</if>
		</if>
		LEFT JOIN
			DUTY_LEASE DL
		ON
		<if test="hierarchyType != 2 and hierarchyType != 3 and hierarchyType != 4">
			DL.DATA_ID = BP.ID AND
			DL.TYPE = 1
		</if>
		<if test="hierarchyType == 2">
			DL.DATA_ID = BG.ID AND
			DL.TYPE = 2
		</if>
		<if test="hierarchyType == 3">
			DL.DATA_ID = BB.ID AND
			DL.TYPE = 3
		</if>
		<if test="hierarchyType == 4">
			(DL.DATA_ID = BUH.ID AND DL.TYPE = 4) OR
			(DL.DATA_ID = BUH.ID AND DL.TYPE = 6)
		</if>
		<if test="hierarchyType == 2 or hierarchyType == 3 or hierarchyType == 4">
		LEFT JOIN
			DUTY_LEASE DLP
		ON
			DLP.DATA_ID = BP.ID AND
			DLP.TYPE = 1
		</if>
		<if test="hierarchyType == 3 or (hierarchyType == 4 and groupId != '100000000000')">
		LEFT JOIN
			DUTY_LEASE DLG
		ON
			DLG.DATA_ID = BG.ID AND
			DLG.TYPE = 2
		</if>
		<if test="hierarchyType == 4">
		LEFT JOIN
			DUTY_LEASE DLB
		ON
			DLB.DATA_ID = BB.ID AND
			DLB.TYPE = 3
		</if>
		WHERE
			BP.FLAG = 1
		<if test="areaId != null and areaId != ''">
			AND BA.ID = #{areaId}
		</if>
		<if test="busiAreaParentId != null and busiAreaParentId != '' and (busiAreaId == null or busiAreaId == '')">
			AND (BUA.ID = #{busiAreaParentId} OR BUA.PARENT_ID = #{busiAreaParentId})
		</if>
		<if test="busiAreaId != null and busiAreaId != ''">
			AND BUA.ID = #{busiAreaId}
		</if>
		<if test="subdistrictId != null and subdistrictId != ''">
			AND ASUB.ID = #{subdistrictId}
		</if>
		<if test="communityId != null and communityId != ''">
			AND ACOM.ID = #{communityId}
		</if>
		<if test="roadId != null and roadId != ''">
			AND ARN.ROAD_ID = #{roadId}
		</if>
		<if test="roadNumFrom != null and roadNumFrom != ''">
			AND ARN.NUM &gt;= #{roadNumFrom}
		</if>
		<if test="roadNumTo != null and roadNumTo != ''">
			AND ARN.NUM &lt;= #{roadNumTo}
		</if>
		<if test="premisesId != null and premisesId != ''">
			AND BP.ID = #{premisesId}
		</if>
		<if test="(hierarchyType == 2 or hierarchyType == 3 or hierarchyType == 4) and groupId != null and groupId != '' and groupId != '100000000000'">
			AND BG.ID = #{groupId}
		</if>
		<if test="hierarchyType == 2 and groupId == '100000000000'">
			AND BG.ID = #{groupId}
		</if>
		<if test="(hierarchyType == 3 or hierarchyType == 4) and groupId == '100000000000'">
			AND BB.BUILDING_GROUP_ID IS NULL
		</if>
		<if test="(hierarchyType == 3 or hierarchyType == 4) and buildingId != null and buildingId != ''">
			AND BB.ID = #{buildingId}
		</if>
		<if test="hierarchyType == 4 and unitId != null and unitId != '' and unitId != '100000000000'">
			AND BUH.ID = #{unitId}
		</if>
		<if test="hierarchyType == 4 and unitId == '100000000000'">
			AND BUH.TYPE = 'BH'
		</if>
		<if test="completeStatus == 1">
			AND DL.ORG_LEVEL IS NULL
		</if>
		<if test="completeStatus == 2">
			AND DL.ORG_LEVEL = 1
		</if>
		<if test="completeStatus == 3">
			AND DL.ORG_LEVEL = 2
		</if>
		<if test="completeStatus == 4">
			AND DL.ORG_LEVEL = 3
		</if>
		<if test="completeStatus == 5">
			AND DL.ORG_LEVEL IS NOT NULL
		</if>
		<if test="status != null and status != ''">
			AND BP.STATUS = #{status}
		</if>
		<if test="dutyAreaId != null and dutyAreaId != ''">
			<if test="dutyZoneId != null and dutyZoneId != ''">
				<if test="dutyGroupId != null and dutyGroupId != ''">
					<if test="userId != null and userId != ''">
						AND DL.USER_ID = #{userId}
					</if>
					<if test="userId == null or userId == ''">
						AND DL.ORG_CODE = #{dutyGroupId}
					</if>
				</if>
				<if test="dutyGroupId == null or dutyGroupId == ''">
					AND DL.ORG_CODE = #{dutyZoneId}
				</if>
			</if>
			<if test="dutyZoneId == null or dutyZoneId == ''">
				AND DL.ORG_CODE = #{dutyAreaId}
			</if>
		</if>
		<if test="busiAreaId != null and busiAreaId != ''">
		</if>
		<if test="maintenanceCategory != null and maintenanceCategory != ''">
			AND BP.MAINTENANCE_CATEGORY = #{maintenanceCategory}
		</if>
		ORDER BY
			BP.ID
		<if test="hierarchyType == 2">
			,BG.ID
		</if>
		<if test="hierarchyType == 3">
			,BG.ID,BB.ID
		</if>
		<if test="hierarchyType == 4 and groupId != '100000000000'">
			,BG.ID,BB.ID,BUH.ID
		</if>
		<if test="hierarchyType == 4 and groupId == '100000000000'">
			,BB.ID,BUH.ID
		</if>
	</select>

	<!-- 原分配 -->
	<select id="oldLeaseAssignment" parameterType="map" resultType="map">
		SELECT
			ID AS ID,
			DL.AREA_NAME || NVL2(DL.ZONE_NAME, ' ' || DL.ZONE_NAME, '') || NVL2(DL.GROUP_NAME, ' ' || DL.GROUP_NAME, '') || NVL2(DL.USER_NAME, ' ' || DL.USER_NAME, '') AS OLDASSIGNMENT
		FROM
			DUTY_LEASE DL
		WHERE
			DL.TYPE = #{dataType} AND
			DL.DATA_ID = #{dataId}
	</select>

	<!-- 上一级组织结构 -->
	<select id="lastLeaseOrg" parameterType="map" resultType="java.lang.String">
		SELECT
			<if test="dataType == 2">
			DLP.ORG_CODE AS LASTASSIGNMENT
			</if>
			<if test="dataType == 3">
				<if test="dataGroupId != null and dataGroupId != ''">
				NVL(DLG.ORG_CODE, DLP.ORG_CODE) AS LASTASSIGNMENT
				</if>
				<if test="dataGroupId == null or dataGroupId == ''">
				DLP.ORG_CODE AS LASTASSIGNMENT
				</if>
			</if>
			<if test="dataType == 4 or dataType == 6">
				<if test="dataGroupId != null and dataGroupId != ''">
				NVL(DLB.ORG_CODE, NVL(DLG.ORG_CODE, DLP.ORG_CODE)) AS LASTASSIGNMENT
				</if>
				<if test="dataGroupId == null or dataGroupId == ''">
				NVL(DLB.ORG_CODE, DLP.ORG_CODE) AS LASTASSIGNMENT
				</if>
			</if>
		FROM
			DUTY_LEASE DLP
		<if test="dataType != 1 and dataType != 2">
		LEFT JOIN
			DUTY_LEASE DLG
		ON
			DLG.TYPE = 2 AND
			DLG.DATA_ID = #{dataGroupId}
		</if>
		<if test="dataType == 4 or dataType == 6">
		LEFT JOIN
			DUTY_LEASE DLB
		ON
			DLB.TYPE = 3 AND
			DLB.DATA_ID = #{dataBuildingId}
		</if>
		WHERE
			DLP.TYPE = 1 AND
			DLP.DATA_ID = #{dataPremisesId}
	</select>

	<!-- 下属层级是否被分配 -->
	<select id="nextLeaseAssignment" parameterType="map" resultType="java.lang.String">
		SELECT
			COUNT(0) AS NEXTASSIGNMENT
		FROM
			DUTY_LEASE DL
		WHERE
			<if test="dataType == 1">
			(DL.TYPE = 2 OR DL.TYPE = 3 OR DL.TYPE = 4 OR DL.TYPE = 6) AND
			DL.BP_ID = #{dataPremisesId}
			</if>
			<if test="dataType == 2">
			(DL.TYPE = 3 OR DL.TYPE = 4 OR DL.TYPE = 6) AND
			DL.BG_ID = #{dataGroupId}
			</if>
			<if test="dataType == 3">
			(DL.TYPE = 4 OR DL.TYPE = 6) AND
			DL.BB_ID = #{dataBuildingId}
			</if>
	</select>

	<!-- 添加分配 -->
	<insert id="addLeaseAssignment" useGeneratedKeys="true" parameterType="map">
		<selectKey resultType="java.lang.Integer" order="BEFORE" keyProperty="dutyLeaseId">
			SELECT DUTY_LEASE_SEQ.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO
			DUTY_LEASE
		(
			ID,
			TYPE,
			DATA_ID,
			ORG_LEVEL,
			ORG_CODE,
			<if test="userId != null and userId != ''">
			USER_ID,
			</if>
			<if test="userName != null and userName != ''">
			USER_NAME,
			</if>
			BP_ID,
			<if test="groupId != null and groupId != ''">
			BG_ID,
			</if>
			<if test="buildingId != null and buildingId != ''">
			BB_ID,
			</if>
			<if test="dataType == 4">
			BU_ID,
			</if>
			<if test="dataType == 6">
			BH_ID,
			</if>
			AREA_NAME,
			<if test="zoneName != null and zoneName != ''">
			ZONE_NAME,
			</if>
			<if test="groupName != null and groupName != ''">
			GROUP_NAME,
			</if>
			OPERATE_DATE
		)
		VALUES
		(
			#{dutyLeaseId},
			#{dataType},
			#{dataId},
			#{orgLevel},
			#{orgCode},
			<if test="userId != null and userId != ''">
			#{userId},
			</if>
			<if test="userName != null and userName != ''">
			#{userName},
			</if>
			#{premisesId},
			<if test="groupId != null and groupId != ''">
			#{groupId},
			</if>
			<if test="buildingId != null and buildingId != ''">
			#{buildingId},
			</if>
			<if test="dataType == 4">
			#{unitId},
			</if>
			<if test="dataType == 6">
			#{unitId},
			</if>
			#{areaName},
			<if test="zoneName != null and zoneName != ''">
			#{zoneName},
			</if>
			<if test="groupName != null and groupName != ''">
			#{groupName},
			</if>
			#{operateDate}
		)
	</insert>

	<!-- 修改分配 -->
	<update id="updateLeaseAssignment" parameterType="map">
		UPDATE
			DUTY_LEASE
		SET
			ORG_LEVEL = #{orgLevel},
			ORG_CODE = #{orgCode},
			<if test="userId != null and userId != ''">
			USER_ID = #{userId},
			</if>
			<if test="userName != null and userName != ''">
			USER_NAME = #{userName},
			</if>
			AREA_NAME = #{areaName},
			<if test="zoneName != null and zoneName != ''">
			ZONE_NAME = #{zoneName},
			</if>
			<if test="groupName != null and groupName != ''">
			GROUP_NAME = #{groupName},
			</if>
			OPERATE_DATE = #{operateDate}
		WHERE
			ID = #{dutyLeaseId}
	</update>

	<!-- 删除分配 -->
	<delete id="deleteLeaseAssignment" parameterType="map">
		DELETE
			DUTY_LEASE
		WHERE
			<if test="dataType == 1">
			TYPE &lt;&gt; 1 AND
			BP_ID = #{premisesId}
			</if>
			<if test="dataType == 2">
			TYPE &lt;&gt; 1 AND
			TYPE &lt;&gt; 2 AND
			BG_ID = #{groupId}
			</if>
			<if test="dataType == 3">
			(TYPE = 4 OR TYPE = 6) AND
			BB_ID = #{buildingId}
			</if>
	</delete>
</mapper>