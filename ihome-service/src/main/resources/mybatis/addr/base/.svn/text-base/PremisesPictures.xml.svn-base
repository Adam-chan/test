<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="premisesPictures">

	<!-- 分页查询下载资料 -->
	<select id="getPremisesPicturesPage" parameterType="map"
		resultType="PremisesPicturesModel">
		SELECT
		ID AS id,
		FILE_NAME AS fileName,
		CREATE_TIME AS createTime,
		STATUS AS status,
		FOLDER_NAME AS folderName,
		FILE_NAME_LONG AS
		fileNameLong,
		PREMISES_ID AS premisesId,
		IS_COVER AS isCover,
		PIC_TYPE AS picType,
		REPRESENT_PIC AS representPic
		FROM
		PREMISES_IMAGES
		<where>
			<if test="premisesId !=null and premisesId != ''">
				PREMISES_ID=#{premisesId}
			</if>
			<if test="picType !=null and picType != ''">
				and PIC_TYPE=#{picType}
			</if>
		</where>
		ORDER BY
		CREATE_TIME DESC
	</select>

	<!-- 保存上传的文件 -->
	<insert id="saveUploadPicture" parameterType="map">
		INSERT INTO PREMISES_IMAGES
		(ID,FILE_NAME,FOLDER_NAME,FILE_NAME_LONG,CREATE_TIME,PREMISES_ID,PIC_TYPE,IS_COVER,STATUS)
		select
		PREMISES_PICTURES_SEQ.NEXTVAL,a.*,sysdate,#{premisesId},#{picType},#{isCover},#{status}
		from (
		<foreach collection="dataStr" item="item" index="index"
			separator="UNION ALL">
			SELECT
			#{item.fileName},#{item.folderName},#{item.fileNameLong}
			FROM DUAL
		</foreach>
		)a
	</insert>

	<!-- 批量删除图片 -->
	<delete id="deletePicture" parameterType="map">
		DELETE
		FROM
		PREMISES_IMAGES
		WHERE
		id IN (${rowIdsStr})
	</delete>

	<!-- 根据图片类型进行分组 -->
	<select id="getGroupsByPicType" parameterType="map" resultType="map">
		SELECT
		PIC_TYPE AS picType,
		count(id) AS count
		FROM
		PREMISES_IMAGES
		WHERE
		PREMISES_ID = #{premisesId}
		GROUP BY
		PIC_TYPE
	</select>

	<!-- 设置代表图片 -->
	<update id="setRepresentPic" parameterType="map">
		UPDATE
			PREMISES_IMAGES
			SET
			REPRESENT_PIC = 1
			WHERE
			id = #{id}
		
	</update>
	
	<!-- 重置代表图片 -->
	<update id="resetRepresent" parameterType="map">
		UPDATE
			PREMISES_IMAGES
			SET
			REPRESENT_PIC = 2
	</update>
</mapper>
