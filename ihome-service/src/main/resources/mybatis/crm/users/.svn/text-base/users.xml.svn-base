<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="users" >
	
	<select id="getUserCheckInfo" parameterType="java.lang.String" resultType="userCheckModel">
		select 
			uc.id ,		
			uc.USER_ID userId,
			uc.USER_ORG_CODE orgCode,
			uc.USER_TYPE userType,
			uc.CUSTOMER_SALE_TELL_COUNT customerSaleTellCount,
			uc.CUSTOMER_LEASE_TELL_COUNT customerLeaseTellCount,
			uc.HOUSE_SALE_TELL_COUNT houseSaleTellCount,
			uc.HOUSE_LEASE_TELL_COUNT houseLeaseTellCount,
			uc.HOUSE_SALE_ADDR_COUNT houseSaleAddrCount,
			uc.HOUSE_LEASE_ADDR_COUNT houseLeaseAddrCount,
			uc.OPERATE_TIME operateTime
		from USER_CHECK uc
		where uc.USER_ID = #{_parameter}
	</select>
	<update id="updateUserCheck" parameterType="userCheckModel">
		update USER_CHECK <set>
			<if test="customerSaleTellCount !=null">
				CUSTOMER_SALE_TELL_COUNT  = #{customerSaleTellCount},
			</if>
			<if test="customerLeaseTellCount !=null">
				CUSTOMER_LEASE_TELL_COUNT = #{customerLeaseTellCount},
			</if>
			<if test="houseSaleTellCount !=null">
				HOUSE_SALE_TELL_COUNT =#{houseSaleTellCount},
			</if>
			<if test="houseLeaseTellCount !=null">
				HOUSE_LEASE_TELL_COUNT =#{houseLeaseTellCount},
			</if>
			<if test="houseSaleAddrCount !=null">
				HOUSE_SALE_ADDR_COUNT =#{houseSaleAddrCount},
			</if>
			<if test="houseLeaseAddrCount !=null">
				HOUSE_LEASE_ADDR_COUNT =#{houseLeaseAddrCount},
			</if>
			<if test="operateTime !=null">
				OPERATE_TIME =#{operateTime}
			</if>
		</set> 	
		where user_id = #{userId}
	</update>
	<insert id="insertUserCheck" parameterType="userCheckModel">
		insert into USER_CHECK(
			ID,			
			USER_ID,
			USER_ORG_CODE,
			USER_TYPE
			<if test="customerSaleTellCount != null">
				,CUSTOMER_SALE_TELL_COUNT
			</if>
			<if test="customerLeaseTellCount != null">
				,CUSTOMER_LEASE_TELL_COUNT
			</if>
			<if test="houseSaleTellCount != null">
				,HOUSE_SALE_TELL_COUNT
			</if>
			<if test="houseLeaseTellCount != null">
				,HOUSE_LEASE_TELL_COUNT
			</if>
			
			<if test="houseSaleAddrCount != null">
				,HOUSE_SALE_ADDR_COUNT
			</if>
			
			<if test="houseLeaseAddrCount != null">
				,HOUSE_LEASE_ADDR_COUNT
			</if>
		)values (
			USER_CHECK_SEQ.NEXTVAL,
			#{userId},
			#{orgCode},
			#{userType}
			<if test="customerSaleTellCount != null">
				,#{customerSaleTellCount}
			</if>
			<if test="customerLeaseTellCount != null">
				,#{customerLeaseTellCount}
			</if>
			<if test="houseSaleTellCount != null">
				,#{houseSaleTellCount}
			</if>
			<if test="houseLeaseTellCount != null">
				,#{houseLeaseTellCount}
			</if>
			
			<if test="houseSaleAddrCount != null">
				,#{houseSaleAddrCount}
			</if>
			
			<if test="houseLeaseAddrCount != null">
				,#{houseLeaseAddrCount}
			</if>
		)
	</insert>
	<!-- 查询房源电话地址和证载地址 -->
	<select id="getHouseInfoContact" parameterType="java.lang.String" resultType="java.util.HashMap">
		select 
		hl.TYPE type,
		hl.NAME userName,
		hl.CONTACT_TYPE contact
		from HOUSE_LINKMAN hl
		where hl.house_info_id = #{_parameter}
	</select>
	<!-- 查询房源电话地址和证载地址 -->
	<select id="getHouseInfoAddress" parameterType="java.util.Map" resultType="java.util.HashMap">
		
		select 
			ADDRESS_DETAIL,
			ZZDZ_DETAIL
		from 
		<if test="demandType == 2">
			HOUSE_LEASE h 
		</if>
		<if test="demandType == 1">
			HOUSE_SALE h
		</if>
		where 
			<if test="houseId != null and houseId != ''">
				h.house_info_id = #{houseId}
			</if>
			<if test="houseCode != null and houseCode != ''">
				h.house_info_id = #{houseCode}
			</if>
	</select>
	<!-- 通过客源ID和客源编号查询客户的联系电话 -->
	<select id="getCustomerInfoTell" parameterType="map" resultType="java.util.HashMap">
		select c.user_name USERNAME,c.TELL,c.SPARE_TELL SPARETELL from CUSTOMER_DEMAND t 
		left join CUSTOMERS c on t.CUSTOMER_ID = c.id
		where 1=1  
		<if test="customerId != null and customerId !='' ">
			and c.id= #{customerId}
		</if>
		<if test="demandType != null and demandType !='' ">
			and t.DEMAND_TYPE = #{demandType}
		</if>
		<if test="demandId != null and demandId != '' ">
			and t.id = #{demandId}
		</if>
		<if test="demandCode != null and demandCode != '' ">
			and t.demand_code = #{demandCode}
		</if>
	</select>
	<!-- 通过房源ID查询运行权限-->
	<select id="checkHouseJyPerview" parameterType="map" resultType="java.lang.String">
		select os.org_code 
	        from house_info hi 
        left join base_house bh on  hi.room_id = bh.id
        left join base_premises bp on bp.id = bh.premises_id
        left join 
        <if test="demandType == 1">
        	OPERATE_SALE 
        </if>
        <if test="demandType == 2">
        	OPERATE_LEASE
        </if>
        os on (os.type = 1 and os.data_id =  bh.premises_id) or  (os.type =2 and os.data_id = bp.busi_area_id)
       	where hi.id= #{houseId} 
	</select>
	<!-- 通过客源ID和客源编号查询客户的联系电话 -->
	<select id="checkHouseZrPerview" parameterType="map" resultType="java.util.HashMap">
		select bh.premises_id,bp.busi_area_id,DIVIDE_USER_ID,DIVIDE_ORG_CODE 
	        from house_info hi 
        left join base_house bh on  hi.room_id = bh.id
        left join base_premises bp on bp.id = bh.premises_id
       	where hi.id= #{houseId} 
	</select>
	<!-- 通过客源ID和客源编号查询客户的联系电话 -->
	<select id="checkCustomerPriv" parameterType="map" resultType="java.util.HashMap">
		select t.ORG_CODE,t.OPERATE_USER_ID,t.CD_TYPE from CUSTOMER_DEMAND t where 
		<if test="demandId != null and  demandId != '' ">
			t.id = #{demandId}
		</if>
		<if test="demandCode != null and demandCode != '' ">
			t.DEMAND_CODE = #{demandCode}
		</if>
	</select>
	<!-- cha -->
	<select id="getZrByRoomId" parameterType="map" resultType="java.util.HashMap">
		select a.ORG_CODE, a.USER_ID,a.USER_NAME,a.AREA_NAME,a.ZONE_NAME,a.GROUP_NAME from (
			select dl.ORG_CODE, dl.USER_ID,dl.USER_NAME,dl.AREA_NAME,dl.ZONE_NAME,dl.GROUP_NAME ,rownum from base_house bh
			left join <if test="demandType == 1 ">DUTY_SALE </if><if test="demandType == 2 "> DUTY_LEASE </if> dl on bh.premises_id = dl.bp_id
			where bh.id =#{roomId} and dl.org_level = 4 and (bh.group_id = dl.BG_ID or bh.building_id = dl.BB_ID or bh.unit_id = dl.BU_ID or bh.id = dl.bh_id)
			order by type desc
		) a where rownum = 1
	</select>
</mapper>