<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="customerPool">

	<!-- 分页查询成交客户池 -->
	<select id="getCustomerPoolListForPage" parameterType="map" resultType="CustomerSourceModel">
		SELECT
			cd.id,
			cd.demand_code AS demandCode,
			cd.demand_type AS demandType,
			cd.cus_judge AS custJudge,
			c.user_name AS userName,
			c.tell,
			cd.build_area AS buildArea,
			cd.afford_price AS affordPrice,
			cd.demand_status AS demandStatus,
		  	cd.firstpay AS firstPay,
			cd.operate_user AS operateUser,
			cd.operate_time AS operateTime,
			cd.create_time AS createTime,
			cd.decoration,
			cd.remark,
			cd.DEMAND_PREMISES AS demandPremises,
			cd.CHECK_IN_TIME AS checkInTime,
			cd.DEAL_REASON AS dealReason,
			s1.id AS parentSource,
			s2.id AS childSource,
			CASE WHEN promise.isPromised IS NULL THEN 0 ELSE promise.isPromised END AS isPromised,
		  	promise.takeDate,
			to_char((
				SELECT
					max(ccb.call_back_time)
				FROM
					customer_call_back ccb
				WHERE
					ccb.demand_id = cd.id
			),'yyyy-mm-dd') AS visiteTimeStr,
			(
				SELECT
					count(0)
				FROM
					customer_promise cp
				WHERE
					cp.demand_id = cd.id
			) AS promisedCount,
			(
				SELECT
					DESCRIBE
				FROM
					SYS_HOUSE_PARAME shp
				WHERE
					shp.id = cd.cus_judge
			) AS custJudge2
		FROM
			customer_demand cd
		LEFT JOIN customers c ON c.id = cd.customer_id
		LEFT JOIN owner_source s1 ON s1.id = cd.cusfrom
		LEFT JOIN owner_source s2 ON s2.id = cd.cusfrom_2
		LEFT JOIN (
			SELECT
				count(0) AS isPromised,
				max(cp.take_date) AS takeDate,
				cp.demand_id
			FROM
				customer_promise cp
			GROUP BY
				cp.demand_id
		) promise ON promise.demand_id = cd.id
		<where>
			<if test="poolType==1">
				cd.cd_type in(2,3)
			</if>
			<if test="poolType==2">
				(cd.demand_status = 5 OR cd.cd_type = 4)
			</if>
			<if test="demandCode !=null and demandCode !=''"> <!-- 客源编号 -->
				AND cd.demand_code = #{demandCode}
			</if>
			<if test="userName !=null and userName !=''"> <!-- 客户姓名 -->
				AND c.user_name = #{userName}
			</if>
			<if test="tell !=null and tell !=''"> <!-- 客户电话 -->
				AND c.tell = #{tell}
			</if>
			<if test="demandStatus !=null and demandStatus !=''"> <!-- 客户状态 -->
				AND cd.demand_status = #{demandStatus}
			</if>
			<if test="propertyType !=null and propertyType !=''"> <!-- 需求类型 -->
				AND cd.property_type = #{propertyType}
			</if>
			<if test="buildAreaS !=null and buildAreaS !=''"> <!-- 需求面积 -->
				AND cd.build_area &gt;= #{buildAreaS}
			</if>
			<if test="buildAreaE !=null and buildAreaE !=''"> 
				AND cd.build_area &lt;= #{buildAreaE}
			</if>
			<if test="affordPriceS !=null and affordPriceS !=''"> <!-- 价格 -->
				AND cd.afford_price &gt;= #{affordPriceS}
			</if>
			<if test="affordPriceE !=null and affordPriceE !=''"> 
				AND cd.afford_price &lt;= #{affordPriceE}
			</if>
			<if test="orientation !=null and orientation !=''"> <!-- 朝向 -->
				AND cd.orientation = #{orientation}
			</if>
			<if test="createTimeS !=null and createTimeS !=''"> <!-- 登记时间 -->
				AND cd.create_time &gt;= to_date(#{createTimeS},'yyyy-mm-dd')
			</if>
			<if test="createTimeE !=null and createTimeE !=''"> 
				AND cd.create_time &lt;= to_date(#{createTimeE}||' '||'23:59:59','yyyy-mm-dd hh24:mi:ss')
			</if>
			<if test="dealTimeS !=null and dealTimeS !=''"> <!-- 成交时间 -->
				AND cd.demand_status = 5
				AND cd.operate_time &gt;= to_date(#{dealTimeS},'yyyy-mm-dd')
			</if>
			<if test="dealTimeE !=null and dealTimeE !=''"> 
				AND cd.demand_status = 5
				AND cd.operate_time &lt;= to_date(#{dealTimeE}||' '||'23:59:59','yyyy-mm-dd hh24:mi:ss')
			</if>
			<if test="checkInTimeS !=null and checkInTimeS !=''"> <!-- 需求时间 -->
				AND cd.check_in_time &gt;= to_date(#{checkInTimeS},'yyyy-mm-dd')
			</if>
			<if test="checkInTimeE !=null and checkInTimeE !=''"> 
				AND cd.check_in_time &lt;= to_date(#{checkInTimeE}||' '||'23:59:59','yyyy-mm-dd hh24:mi:ss')
			</if>
			<if test="operateUser !=null and operateUser !=''"> <!-- 登记人 -->
				AND cd.operate_user_id = #{operateUser}
			</if>
			<if test="decoration !=null and decoration !=''"> <!-- 装修 -->
				AND cd.decoration = #{decoration}
			</if>
			<if test="custJudge !=null and custJudge !=''"> <!-- 客户评价 -->
				AND cd.cus_judge = #{custJudge}
			</if>
			<if test="parentSource !=null and parentSource !=''"> <!-- 客户来源1 -->
				AND cd.cusfrom = #{parentSource}
			</if>
			<if test="childSource !=null and childSource !=''"> <!-- 客户来源2 -->
				AND cd.cusfrom_2 = #{childSource}
			</if>
			<if test="demandRegionId !=null and demandRegionId !=''"> <!-- 需求区域 -->
				AND instr(','||cd.demand_region_ids||',' , ','||#{demandRegionId}||',' )>0
			</if>
			<if test="demandPremisesId !=null and demandPremisesId !=''"> <!-- 意向小区 -->
				AND instr(','||cd.demand_premises_ids||',' , ','||#{demandPremisesId}||',' )>0
			</if>
			<if test="cdType !=null and cdType !=''"> <!-- 公客类型 -->
				AND cd.cd_type = #{cdType}
			</if>
		</where>
		ORDER BY
			c.tell
	</select>
	
	<!-- 模糊搜索商圈 dl-->
	<select id="getBusiAreaByMatch" parameterType="map" resultType="busiAreaModel" >
		SELECT
			id,
			NAME AS busiAreaName
		FROM
			busi_area ba
		<where>
	        <if test="matchStr != null and matchStr !=''"> 
		    	AND INSTR(NAME, #{matchStr}) > 0
		    </if>
		</where>
   	</select>
   	
   	<!-- 分配 -->
   	<update id="customerPoolComment" parameterType="map">
   		UPDATE 
   			customer_demand cd 
   		SET 
   			cd.cd_type = 1
   		<if test="operateUser !=null and operateUser !=''">
   			,cd.operate_user=#{operateUser} 
   		</if>
   		<if test="operateUserId !=null and operateUserId !=''">
   			,cd.operate_user_id =#{operateUserId}
   		</if>
   		<if test="orgCode !=null and orgCode !=''">
   			,cd.org_code = #{orgCode} 
   		</if>
   		<where>
   			cd.id in (#{demandIds})
   		</where>
   	</update>
   	
</mapper>