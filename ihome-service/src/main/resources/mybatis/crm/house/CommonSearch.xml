<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="commonSearch">

	<!-- 查询收藏数据 -->
	<select id="queryCollect" parameterType="map" resultType="java.lang.Integer">
		SELECT
			ID AS COLLECTID
		FROM
			HOUSE_COLLECT
		WHERE
			HOUSE_INFO_ID = #{houseInfoId} AND
			USER_NAME = #{userId}
	</select>

	<!-- 收藏 -->
	<insert id="addCollect" parameterType="map">
		<selectKey resultType="java.lang.Integer" order="BEFORE" keyProperty="collectId">
			SELECT HOUSE_COLLECT_SEQ.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO
			HOUSE_COLLECT
		VALUES
		(
			#{collectId},
			#{houseInfoId},
			#{userId},
			#{careteTime}
		)
	</insert>

	<!-- 取消收藏 -->
	<delete id="deleteCollect" parameterType="map">
		DELETE
			HOUSE_COLLECT
		WHERE
			ID = #{collectId}
	</delete>

	<!-- 跟进 -->
	<insert id="addFollow" parameterType="map">
		<selectKey resultType="java.lang.Integer" order="BEFORE" keyProperty="followId">
			SELECT HOUSE_FOLLOW_SEQ.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO
			HOUSE_FOLLOW
		(
			ID,
			HOUSE_INFO_ID,
			FOLLOW_TIME,
			<if test="followContent != null and followContent != ''">
			FOLLOW_CONTENT,
			</if>
			NEXT_FOLLOW_TIME,
			<if test="remindContent != null and remindContent != ''">
			REMIND_CONTENT,
			</if>
			CREATE_TIME,
			OPERATE_USER,
			OPERATE_USER_ID,
			FOLLOW_WAY,
			FOLLOW_TYPE
		)
		VALUES
		(
			#{followId},
			#{houseInfoId},
			TO_DATE(#{followTime},'YYYY-MM-DD HH24:MI:SS'),
			<if test="followContent != null and followContent != ''">
			#{followContent},
			</if>
			TO_DATE(#{nextFollowTime},'YYYY-MM-DD HH24:MI:SS'),
			<if test="remindContent != null and remindContent != ''">
			#{remindContent},
			</if>
			#{createTime},
			#{operateUser},
			#{operateUserId},
			#{followWay},
			#{followType}
		)
	</insert>

	<!-- 查询空看数据 -->
	<select id="querySpaceSee" parameterType="map" resultType="java.lang.Integer">
		SELECT
			ID AS SPACESEEID
		FROM
			HOUSE_SPACE_SEE
		WHERE
			HOUSE_INFO_ID = #{houseInfoId} AND
			OPERATE_USER_ID = #{userId}
	</select>

	<!-- 空看 -->
	<insert id="addSpaceSee" parameterType="map">
		<selectKey resultType="java.lang.Integer" order="BEFORE" keyProperty="spaceSeeId">
			SELECT HOUSE_SPACE_SEE_SEQ.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO
			HOUSE_SPACE_SEE
		(
			ID,
			HOUSE_INFO_ID,
			SPACE_SEE_TIME,
			<if test="remark != null and remark != ''">
			REMARK,
			</if>
			CREATE_TIME,
			OPERATE_USER,
			OPERATE_USER_ID,
			OPERATE_GROUP,
			OPERATE_GROUP_CODE,
			IFOPERATE
		)
		VALUES
		(
			#{spaceSeeId},
			#{houseInfoId},
			TO_DATE(#{spaceSeeTime},'YYYY-MM-DD HH24:MI:SS'),
			<if test="remark != null and remark != ''">
			#{remark},
			</if>
			#{createTime},
			#{operateUser},
			#{operateUserId},
			#{operateGroup},
			#{operateGroupCode},
			#{ifOperate}
		)
	</insert>

	<!-- 查询配客数据 -->
	<select id="getMatchCustomerListForPage" parameterType="map" resultType="CustomerSourceModel">
		SELECT
			CD.ID AS ID,
			CD.CUSTOMER_ID AS CUSTOMERID,
			CD.DEMAND_CODE AS DEMANDCODE,
			C.USER_NAME AS USERNAME,
			CD.DEMAND_PREMISES AS DEMANDPREMISES,
			CD.AFFORD_PRICE AS AFFORDPRICE,
			CD.BUILD_AREA AS BUILDAREA,
			CD.ROOMS AS ROOMS,
			CD.OFFICE AS OFFICE,
			CD.BALCONY AS BALCONY,
			CD.WC AS WC,
			CD.NEED_FLOOR_START AS NEEDFLOORSTART,
			CD.NEED_FLOOR_END AS NEEDFLOOREND,
			CD.ORIENTATION AS ORIENTATION,
			CD.DECORATION AS DECORATION
		FROM
			CUSTOMER_DEMAND CD
		INNER JOIN
			CUSTOMERS C
		ON
			CD.CUSTOMER_ID = C.ID
		WHERE
			CD.DEMAND_TYPE = #{demandType}
			AND CD.PROPERTY_TYPE = #{propertyType}
			<if test="sellPriceFrom != null and sellPriceFrom != ''">
				AND CD.AFFORD_PRICE &gt;= #{sellPriceFrom}
			</if>
			<if test="sellPriceTo != null and sellPriceTo != ''">
				AND CD.AFFORD_PRICE &lt;= #{sellPriceTo}
			</if>
			<if test="coveredAreaFrom != null and coveredAreaFrom != ''">
				AND CD.BUILD_AREA &gt;= #{coveredAreaFrom}
			</if>
			<if test="coveredAreaTo != null and coveredAreaTo != ''">
				AND CD.BUILD_AREA &lt;= #{coveredAreaTo}
			</if>
			<if test="floorsNum != null and floorsNum != ''">
				AND CD.NEED_FLOOR_END &gt;= #{floorsNum}
				AND CD.NEED_FLOOR_START &lt;= #{floorsNum}
			</if>
			<if test="decoradion != null and decoradion != ''">
				AND CD.DECORATION = #{decoradion}
			</if>
			<if test="rooms != null and rooms != ''">
				AND CD.ROOMS = #{rooms}
			</if>
			<if test="office != null and office != ''">
				AND CD.OFFICE = #{office}
			</if>
			<if test="kitchen != null and kitchen != ''">
				AND CD.BALCONY = #{kitchen}
			</if>
			<if test="wc != null and wc != ''">
				AND CD.WC = #{wc}
			</if>
			<if test="premisesName != null and premisesName != ''">
				AND INSTR(CD.DEMAND_PREMISES, #{premisesName}) > 0
			</if>
		ORDER BY
			CD.DEMAND_CODE DESC
	</select>

	<!-- 查询钥匙数据 -->
	<select id="queryReceiveKey" parameterType="map" resultType="java.lang.Integer">
		SELECT
			ID AS KEYID
		FROM
			MANAGE_KEY_INFO
		WHERE
			HOUSE_INFO_ID = #{houseInfoId} AND
			STATUS = 1
	</select>
		<!-- 查询钥匙数据Lb -->
	<select id="queryKeyInfo" parameterType="map" resultType="houseKeyModel">
		SELECT
			ID as id
			HOUSE_INFO_ID as houseInfoId
			HOUSE_CODE as houseCode
			TYPE as type
			COLELECT_USER as colelectUser   
			COLELECT_USER_ID as colelectUserId
			COLELECT_ORG as colelectOrg 
			COLELECT_ORG_CODE as colelectOrgCode
			COLELECT_ZONE as colelectZone
			COLELECT_ZONE_CODE as colelectZoneCode
			COLELECT_CONTACT as colelectContact
			KEY_CODE as keyCode
			PASSWORD  
			DEPOSIT	 
			DEPOSIT_USER_ID as depositUserId
			DEPOSIT_STORE_ID as depositStoreId
			DEPOSIT_CONTACT as depositContact
			REMARK 
			CREATE_TIME	DATE as createTime
			STATUS
			BACK_TYPE as backType
			BACK_TIME as backTime
			BACK_USER as backUser
			BACK_USER_ID as backUserId
			BORROW_TYPE as borrowType
			BORROW_USER as borrowUser
			BORROW_USER_ID as borrowUserId
			BORROW_USER_CONTACT as borrowUserContact
			BORROW_TIME  as borrowTime
			BORROW_BACK_TIME as borrowBackTime
			BORROW_OPERATE_USER as borrowOperateUser
			BORROW_OPERATE_USER_ID as borrowOperateUserId
			BORROW_STATUS as borrowStatus
			BORROW_CREATE_TIME as borrowCreateTime
		FROM
			MANAGE_KEY_INFO
		WHERE STATUS = 1
			and	HOUSE_INFO_ID = #{houseInfoId}
	</select>
	<!-- 收钥匙 -->
	<insert id="addKey" parameterType="map">
		<selectKey resultType="java.lang.Integer" order="BEFORE" keyProperty="keyId">
			SELECT MANAGE_KEY_INFO_SEQ.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO
			MANAGE_KEY_INFO
		(
			ID,
			HOUSE_INFO_ID,
			HOUSE_CODE,
			TYPE,
			COLELECT_USER,
			COLELECT_USER_ID,
			<if test="colelectOrg != null and colelectOrg != ''">
			COLELECT_ORG,
			</if>
			<if test="colelectOrgCode != null and colelectOrgCode != ''">
			COLELECT_ORG_CODE,
			</if>
			<if test="colelectZone != null and colelectZone != ''">
			COLELECT_ZONE,
			</if>
			<if test="colelectZoneCode != null and colelectZoneCode != ''">
			COLELECT_ZONE_CODE,
			</if>
			<if test="colelectContact != null and colelectContact != ''">
			COLELECT_CONTACT,
			</if>
			<if test="keyCode != null and keyCode != ''">
			KEY_CODE,
			</if>
			<if test="password != null and password != ''">
			PASSWORD,
			</if>
			<if test="deposit != null and deposit != ''">
			DEPOSIT,
			</if>
			<if test="depositUserId != null and depositUserId != ''">
			DEPOSIT_USER_ID,
			</if>
			<if test="depositStoreId != null and depositStoreId != ''">
			DEPOSIT_STORE_ID,
			</if>
			<if test="depositContact != null and depositContact != ''">
			DEPOSIT_CONTACT,
			</if>
			<if test="remark != null and remark != ''">
			REMARK,
			</if>
			CREATE_TIME,
			STATUS
		)
		VALUES
		(
			#{keyId},
			#{houseInfoId},
			#{houseCode},
			#{type},
			#{colelectUser},
			#{colelectUserId},
			<if test="colelectOrg != null and colelectOrg != ''">
			#{colelectOrg},
			</if>
			<if test="colelectOrgCode != null and colelectOrgCode != ''">
			#{colelectOrgCode},
			</if>
			<if test="colelectZone != null and colelectZone != ''">
			#{colelectZone},
			</if>
			<if test="colelectZoneCode != null and colelectZoneCode != ''">
			#{colelectZoneCode},
			</if>
			<if test="colelectContact != null and colelectContact != ''">
			#{colelectContact},
			</if>
			<if test="keyCode != null and keyCode != ''">
			#{keyCode},
			</if>
			<if test="password != null and password != ''">
			#{password},
			</if>
			<if test="deposit != null and deposit != ''">
			#{deposit},
			</if>
			<if test="depositUserId != null and depositUserId != ''">
			#{depositUserId},
			</if>
			<if test="depositStoreId != null and depositStoreId != ''">
			#{depositStoreId},
			</if>
			<if test="depositContact != null and depositContact != ''">
			#{depositContact},
			</if>
			<if test="remark != null and remark != ''">
			#{remark},
			</if>
			#{createTime},
			1
		)
	</insert>
		  <!-- 更新钥匙所属人 -->
  <update id="updateKeyInfo" parameterType="map" >
    update MANAGE_KEY_INFO
    <set>
       <if test="divideId != null" >
        COLELECT_USER_ID = #{divideId},
      </if>
      <if test="divideUser != null" >
        COLELECT_USER = #{divideUser},
      </if>
       <if test="divideOrg != null" >
        COLELECT_ORG = #{divideOrg},
      </if>
       <if test="divideQu != null" >
       COLELECT_ZONE = #{divideQu},
      </if>
       <if test="divideOrgCode != null" >
       COLELECT_ORG_CODE = #{divideOrgCode},
      </if>
        OPERATE_TIME = SYSDATE,
    </set>
    where ID = #{id}
  </update>
	<!-- 查询保护数据 -->
	<select id="queryProtect" parameterType="map" resultType="java.lang.Integer">
		SELECT
			ID AS PROTECTID
		FROM
			HOUSE_PROTECT
		WHERE
			HOUSE_INFO_ID = #{houseInfoId} AND
			EXAMINE_STATUS = 3
	</select>

	<!-- 查询保护数据 -->
	<select id="queryProtectCount" parameterType="map" resultType="java.lang.Integer">
		SELECT
			CASE WHEN HP.COUNT + 1 > SHP.DESCRIBE THEN 0 ELSE 1 END AS BOOLEAN
		FROM
			(
			SELECT
				NVL(COUNT(*), 0) AS COUNT
			FROM
				HOUSE_PROTECT
			WHERE
				HOUSE_INFO_ID = #{houseInfoId} AND
				EXAMINE_STATUS = 3
			) HP,
			(
			SELECT
				NVL(DESCRIBE, 0) AS DESCRIBE
			FROM
				SYS_HOUSE_PARAME
			WHERE
				TYPE = 'FYBH'
			) SHP
	</select>

	<!-- 查询保护数据 -->
	<select id="getProtectListForPage" parameterType="map" resultType="map">
		SELECT
			USER_NAME AS USERNAME,
			TRUNC(NVL(END_TIME, SYSDATE)) - TRUNC(CREATE_TIME) || '天' AS PROTECTDAY,
			TO_CHAR(CREATE_TIME, 'YYYY-MM-DD') AS CREATETIME,
			NVL(REMARK, '无') AS REMARK
		FROM
			HOUSE_PROTECT
		WHERE
			HOUSE_INFO_ID = #{houseInfoId}
	</select>

	<!-- 保护 -->
	<insert id="addProtect" parameterType="map">
		<selectKey resultType="java.lang.Integer" order="BEFORE" keyProperty="protectId">
			SELECT HOUSE_PROTECT_SEQ.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO
			HOUSE_PROTECT
		(
			ID,
			HOUSE_INFO_ID,
			USER_NAME,
			USER_ID,
			<if test="remark != null and remark != ''">
			REMARK,
			</if>
			CREATE_TIME
		)
		VALUES
		(
			#{protectId},
			#{houseInfoId},
			#{userName},
			#{userId},
			<if test="remark != null and remark != ''">
			#{remark},
			</if>
			TO_DATE(TO_CHAR(SYSDATE, 'YYYY-MM-DD'), 'YYYY-MM-DD')
		)
	</insert>

	<!-- 查询委托书数据 -->
	<select id="queryProxyInput" parameterType="map" resultType="map">
		SELECT
			ID AS PROXYID,
			OPERATE_USER AS OPERATEUSER,
			OPERATE_ORG AS OPERATEORG,
			COLELECT_ZONE AS COLELECTZONE,
			CODE AS ENTRUSTCODE,
			REMARK AS REMARK,
			TO_CHAR(CREATE_TIME,'YYYY-MM-DD HH24:MI') AS ENTRUSTTIME,
			FILE_NAME AS FILENAME,
			FLODER_NAME AS FLODERNAME,
			FILE_NAME_LONG AS FILENAMELONG
		FROM
			HOUSE_ENTRUST
		WHERE
			HOUSE_INFO_ID = #{houseInfoId}
	</select>
		<!-- 查询委托书数据 LB-->
	<select id="queryProxyInfo" parameterType="map" resultType="housePorxyModel">
		SELECT
			ID,
			OPERATE_USER AS operateUser,
			OPERATE_USER_ID as operateUserId,
			OPERATE_USER AS operateUser,
			OPERATE_ORG AS operateOrg,
			COLELECT_ZONE AS colelectZone,
			CODE as code,
			REMARK as remark,
			CREATE_TIME as createTime,
			TO_CHAR(OPERATE_TIME,'YYYY-MM-DD HH24:MI:SS') AS operateTime,
			FILE_NAME AS fileName,
			FLODER_NAME AS floderName,
			FILE_NAME_LONG AS fileNameLong
		FROM
			HOUSE_ENTRUST 
		WHERE
			 status = 1 and HOUSE_INFO_ID = #{houseInfoId}
	</select>
	  <!-- 更新委托书 -->
  <update id="updateProxyInfo" parameterType="map" >
    update HOUSE_ENTRUST
    <set >
       <if test="divideId != null" >
        OPERATE_USER_ID = #{divideId,jdbcType=VARCHAR},
      </if>
       <if test="divideId != null" >
        OPERATE_USER = #{divideUser,jdbcType=VARCHAR},
      </if>
        <if test="divideOrg != null" >
        OPERATE_ORG = #{divideOrg,jdbcType=VARCHAR},
      </if>
        <if test="divideQu != null" >
       COLELECT_ZONE = #{divideQu,jdbcType=VARCHAR},
      </if>
       <if test="divideDaQu != null" >
        OPERATE_BIG_ARRA = #{divideDaQu,jdbcType=VARCHAR},
      </if>
       <if test="divideOrgCode != null" >
       OPERATE_ORG_CODE= #{divideOrgCode,jdbcType=VARCHAR},
      </if>
        OPERATE_TIME = SYSDATE,
    </set>
    where ID = #{id,jdbcType=DECIMAL}
  </update>
	<!-- 添加委托书 -->
	<insert id="addProxyInput" parameterType="map">
		INSERT INTO
			HOUSE_ENTRUST
		(
			ID,
			HOUSE_INFO_ID,
			OPERATE_USER,
			OPERATE_USER_ID,
			OPERATE_ORG,
			OPERATE_ORG_CODE,
			COLELECT_ZONE,
			CODE,
			<if test="remark != null and remark != ''">
			REMARK,
			</if>
			CREATE_TIME,
			FILE_NAME,
			FLODER_NAME,
			FILE_NAME_LONG,
			STATUS,
			OPERATE_TIME
		)
		VALUES
		(
			HOUSE_ENTRUST_SEQ.NEXTVAL,
			#{houseInfoId},
			#{operateUser},
			#{operateUserId},
			#{operateOrg},
			#{operateOrgCode},
			#{operateZone},
			#{entrustCode},
			<if test="remark != null and remark != ''">
			#{remark},
			</if>
			TO_DATE(#{entrustTime},'yyyy-MM-dd hh24:mi'),
			#{fileName},
			#{folderName},
			#{fileNameLong},
			1,
			SYSDATE
		)
	</insert>

	<!-- 撤销委托书 -->
	<delete id="deleteProxyInput" parameterType="map">
		DELETE
			HOUSE_ENTRUST
		WHERE
			ID = #{proxyId}
	</delete>
	
			<!-- 查询房源归属记录 LB-->
	<select id="queryHouseGsLogList" parameterType="map" resultType="houseAffiliationLogModel">
	   select
		      id,
		      operator,
		      operatorId,
		      operatorCode,
		      operatorTime,
		      affiliationOld,
		      affiliationNow,
	     	  reason,
		      remark,
		      houseInfoId,
		      a.TYPE 
	 from ( SELECT
	      	ID as id,
	      	OPERATOR as operator,
	      	OPERATOR_ID as operatorId,
	      	OPERATOR_CODE as operatorCode,
	      	OPERATOR_TIME as operatorTime,
	      	AFFILIATION_OLD as affiliationOld,
	      	AFFILIATION_NOW as affiliationNow,
	      	REASON as reason,
	      	REMARK as remark,
	      	HOUSE_INFO_ID as houseInfoId,
	      	TYPE 
			FROM  HOUSE_AFFILIATION_LOG  WHERE  HOUSE_INFO_ID = #{houseInfoId} order by id desc )a
	     where rownum &lt;4
	</select>
		<!-- 保存房源归属日志 -->
	<insert id="insertHouseGsLog" parameterType="map">
		INSERT INTO
			HOUSE_AFFILIATION_LOG
		(
			ID,
			OPERATOR,
			OPERATOR_ID,
			OPERATOR_CODE,
			OPERATOR_TIME,
			AFFILIATION_OLD,
			AFFILIATION_NOW,
			REASON,
			REMARK,
			HOUSE_INFO_ID,
			TYPE
		)
		VALUES
		(
			HOUSE_AFFILIATION_LOG_SEQ.NEXTVAL,
			#{operator},
			#{operatorId},
			#{operatorCode},
			#{operateTime},
			#{affiliationOld},
			#{affiliationNow},
			#{reason},
			#{remark},
			#{houseInfoId},
			#{affiliationType}
		)
	</insert>
		<!-- 查询房产证数据 LB-->
	<select id="queryDeedInfo" parameterType="map" resultType="houseDeedModel">
		SELECT
			ID,
			OPERATE_USER AS operateUser,
			OPERATE_USER_ID as operateUserId,
			OPERATE_USER AS operateUser,
			OPERATE_ORG AS operateOrg,
			COLELECT_ZONE AS colelectZone,
			CODE,
			REMARK,
			CREATE_TIME as createTime,
			FILE_NAME AS fileName,
			FLODER_NAME AS floderName,
			FILE_NAME_LONG AS fileNameLong
		FROM
			HOUSE_DEED
		WHERE
			 status = 1 and HOUSE_INFO_ID = #{houseInfoId}
	</select>
	<!-- 添加房产证 -->
	<insert id="insertDeedInput" parameterType="map">
		INSERT INTO
			HOUSE_DEED
		(
			ID,
			HOUSE_INFO_ID,
			OPERATE_USER,
			OPERATE_USER_ID,
			OPERATE_ORG,
			OPERATE_ORG_CODE,
			COLELECT_ZONE,
			CODE,
			<if test="remark != null and remark != ''">
			REMARK,
			</if>
			CREATE_TIME,
			FILE_NAME,
			FLODER_NAME,
			FILE_NAME_LONG,
			STATUS
		)
		VALUES
		(
			HOUSE_DEED_SEQ.NEXTVAL,
			#{houseInfoId},
			#{operateUser},
			#{operateUserId},
			#{operateOrg},
			#{operateOrgCode},
			#{operateZone},
			#{entrustCode},
			<if test="remark != null and remark != ''">
			#{remark},
			</if>
			TO_DATE(#{entrustTime},'yyyy-MM-dd hh24:mi'),
			#{fileName},
			#{folderName},
			#{fileNameLong},
			1
		)
	</insert>

	<!-- 撤销房产证 -->
	<delete id="deleteDeedInput" parameterType="map">
		DELETE
			HOUSE_DEED
		WHERE
			ID = #{houseDeedId}
	</delete>
</mapper>