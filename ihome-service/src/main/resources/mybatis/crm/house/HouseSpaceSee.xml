<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="houseSpaceSee">

	<!-- 分页查询房源空看记录 sy -->
	<select id="getHouseSpaceSeeListForPage" parameterType="map" resultType="HouseSpaceSeeModel">
		SELECT
			  hi.id as houseInfoId,
			  hi.code as houseCode,
			  hi.id,
			  hi.demand_type as demandType,
			  CASE WHEN lease.id IS NULL THEN sale.use_type ELSE lease.use_type END AS useType,
			  (
			  	select 
				    count( hss.ifoperate)
				from house_space_see  hss
				where hss.ifoperate=0
				and hss.house_info_id = hi.id
			   )as isOperateUserCount, <!-- 所属组 -->
			   (
			     select 
				    count( hss.ifoperate)
				from house_space_see  hss
				where hss.ifoperate=1
				and hss.house_info_id = hi.id
			  )as noOperateUserCount  <!-- 非所属组 -->
			FROM
			  house_info hi
			  LEFT JOIN house_lease lease ON lease.house_info_id = hi.id
			  LEFT JOIN house_sale sale ON sale.house_info_id = hi.id
			WHERE
			  hi.id IN (
			    SELECT
			      t.house_info_id
			    FROM
			      house_space_see t
				<where>
					<if test="houseCode !=null and houseCode !=''">
						AND hi.code = #{houseCode}
					</if>
					<if test="quOrg !=null and quOrg !=''">
						AND hi.divide_qu_code = #{quOrg}
					</if>
					<if test="zuOrg !=null and zuOrg !=''">
						AND hi.divide_org_code = #{zuOrg}
					</if>
					<if test="jingjiren !=null and jingjiren !=''">
						AND hi.divide_user_id = #{jingjiren}
					</if>
					<if test="demandType !=null and demandType !=''">
						AND hi.demand_type = #{demandType}
					</if>
					<if test="useType !=null and useType !=''">
						AND sale.use_type = #{useType}
						OR lease.use_type = #{useType}
					</if>
					<if test="SpaceSeeTimeS !=null and SpaceSeeTimeS !=''">
						AND see.space_see_time &gt;= to_date (#{SpaceSeeTimeS}, 'yyyy-mm-dd')
					</if>
					<if test="SpaceSeeTimeE !=null and SpaceSeeTimeE !=''">
						AND see.space_see_time &lt;= to_date (#{SpaceSeeTimeE}, 'yyyy-mm-dd')
					</if>
				</where>  
			    GROUP BY
			      t.house_info_id
			  )
		
	</select>
	<!-- 所属组列表 -->
	<select id="getIsGroupListForPage" parameterType="map" resultType="HouseSpaceSeeModel">
		SELECT
		      hss.operate_group_code as operateGroupCode,
		      hss.operate_group as operateGroup,
		      hss.operate_user_id as operateUserId,
		      hss.operate_user as operateUser,
		      to_char (hss.space_see_time,'yyyy-mm-dd HH24:mi') AS spaceSeeTime,
		      hss.remark
		FROM
		  house_space_see hss
		WHERE hss.house_info_id = #{houseInfoId}
		AND hss.ifoperate=0
	</select>
	<!-- 所属组列表 -->
	<select id="getNoGroupListForPage" parameterType="map" resultType="HouseSpaceSeeModel">
		SELECT
		    hss.operate_group as operateGroup,
		    count(hss.operate_group) as spaceSeeCount,
		    max(hss.space_see_time) as lastSpaceSeeTime
		FROM
		    house_space_see hss
		WHERE
		    hss.house_info_id = #{houseInfoId}
		AND hss.ifoperate = 1
		GROUP BY
		    hss.operate_group
	</select>
    <!-- 批量删除空看 sy -->
	<delete id="deleteSpaceSeeByIds" parameterType="map">
        DELETE FROM house_space_see WHERE house_info_id IN (${spaceSeeIds})
	</delete>
</mapper>