<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="manageKey">
	<select id="getManageKeyPage" resultType="manageKeyModel">
		select MKI.ID as id, MKI.HOUSE_INFO_ID as houseInfoId, HI.CODE as houseCode,
		MKI.TYPE as type,MKI.COLELECT_USER as colelectUser,
		MKI.COLELECT_USER_ID as colelectUserId,MKI.COLELECT_ORG as colelectOrg,
		MKI.COLELECT_ORG_CODE as colelectOrgCode,MKI.COLELECT_ZONE as colelectZone,
		MKI.COLELECT_ZONE_CODE as colelectZoneCode,MKI.COLELECT_CONTACT as colelectContact,
		MKI.KEY_CODE as keyCode,MKI.PASSWORD as password, MKI.DEPOSIT as deposit,
		MKI.DEPOSIT_USER_ID as depositUserId,MKI.DEPOSIT_STORE_ID as depositStoreId,
		MKI.DEPOSIT_CONTACT as depositContact,MKI.REMARK as remark,MKI.CREATE_TIME as createTime,
		MKI.STATUS as KeyStatus, MKI.BACK_TYPE as backType,MKI.BACK_TIME as backTime,
		MKI.BACK_USER as backUser,MKI.BACK_USER_ID as backUserId,HI.ROOM_ID as roomId,
		BP.NAME as name,MKI.BORROW_STATUS as status,MKI.BORROW_BACK_TIME as broBackTime,HI.DEMAND_TYPE as demandType,
		MKI.BORROW_USER as borrowUser,MKI.BORROW_USER_CONTACT as borrowUserContact,MKI.BORROW_TIME as borrowTime,
		MKI.BORROW_OPERATE_USER as operateUser,
		(CASE WHEN MF.TYPE = 3 THEN MF.EXAMINE_STATUS END) as examineStatus,
		(CASE WHEN MF.TYPE = 1 THEN MF.EXAMINE_STATUS END) as houseExamineStatus
		FROM
		MANAGE_KEY_INFO MKI
		INNER JOIN HOUSE_INFO HI
		ON MKI.HOUSE_INFO_ID = HI.ID
		INNER JOIN BASE_HOUSE BH
		ON HI.ROOM_ID = BH.ID
		INNER JOIN BASE_PREMISES BP
		ON BH.PREMISES_ID = BP.ID
		LEFT JOIN HOUSE_SALE HS
		ON HI.ID = HS.HOUSE_INFO_ID
		LEFT JOIN HOUSE_LEASE HL
		ON HI.ID = HL.HOUSE_INFO_ID
		LEFT JOIN MANAGE_FAKE MF
		ON MF.HOUSE_CODE = HI.CODE
		<trim prefix="WHERE" prefixOverrides="and">
			<!-- 收钥匙时间 -->
			<if test="takeBackStart!=null and takeBackStart!='' and takeBackEnd!=null and takeBackEnd!=''">
				and MKI.CREATE_TIME between #{takeBackStart} and #{takeBackEnd}
			</if>
			<!-- 借钥匙时间 -->
			<if test="lendStart!=null and lendStart!='' and lendEnd!=null and lendEnd!=''">
				and MKI.BORROW_TIME between #{lendStart} and #{lendEnd}
			</if>
			<!-- 还钥匙时间 -->
			<if test="returnStart!=null and returnStart!='' and returnEnd!=null and returnEnd!=''">
				and MKI.BORROW_BACK_TIME between #{returnStart} and #{returnEnd}
			</if>
			<!-- 业务类型 -->
			<if test="businessType!=null and businessType!=''">
				and HI.DEMAND_TYPE = #{businessType}
			</if>
			<!-- 房源编号 -->
			<if test="houseNumber!=null and houseNumber!=''">
				and	HI.CODE = #{houseNumber}
			</if>
			<!-- 房源状态 -->
			<if test="houseStatus!=null and houseStatus!=''">
				<if test="houseStatus==2">
					and (CASE WHEN MF.TYPE = 1 THEN MF.EXAMINE_STATUS END) = 2
				</if>
			</if>
			<!-- 存放实体店 -->
			<if test="stroeId!=null and stroeId !=''">
				and MKI.DEPOSIT_STORE_ID = #{stroeId}
			</if>
			<!-- 钥匙编号 -->
			<if test="keyNumber!=null and keyNumber!=''">
				and MKI.KEY_CODE = #{keyNumber}
			</if>
			<!-- 存放状态(在库) -->
			<if test="depositStatus!=null and depositStatus!=''">
				<if test="depositStatus==1">
					and MKI.BORROW_STATUS is null or MKI.BORROW_STATUS = 1
				</if>
				<if test="depositStatus==2">
					and MKI.BORROW_STATUS = 2
				</if>
				<if test="depositStatus==3">
					and sysdate > MKI.BORROW_BACK_TIME 
				</if>
			</if>
			<!-- 收钥匙人 -->
			<if test="takeBackPerson!=null and takeBackPerson!=''">
				and MKI.COLELECT_USER = #{takeBackPerson}
			</if>
			<!-- 借钥匙人 -->
			<if test="lendPerson!=null and lendPerson!=''">
				and MKI.BORROW_OPERATE_USER = #{lendPerson}
			</if>
			<!-- 钥匙状态 -->
			<if test="keyStatus!=null and keyStatus!=''">
				and MKI.STATUS = #{keyStatus}
			</if>
		</trim>
	</select>
	
	<!-- 钥匙确认 -->
	<update id="confirmKey">
		UPDATE MANAGE_KEY_INFO MKI SET
		MKI.DEPOSIT_STORE_ID = #{depositStoreId},
		MKI.DEPOSIT_CONTACT = #{depositContact}
		WHERE MKI.ID = #{id}
	</update>
	
	<!-- 钥匙借出 -->
	<update id="lendKey">
		UPDATE MANAGE_KEY_INFO MKI SET
		MKI.BORROW_USER = #{lendKeyPerson},
		MKI.BORROW_USER_ID = #{lendKeyPersonId},
		MKI.BORROW_USER_CONTACT = #{personTel},
		MKI.BORROW_TIME	= #{lendStart},
		MKI.BORROW_BACK_TIME = #{lendEnd},
		MKI.BORROW_OPERATE_USER = #{lendPerson},
		MKI.REMARK = #{remarks},
		MKI.BORROW_STATUS = 1
		WHERE MKI.ID = #{keyId}
	</update>
	
	<!-- 钥匙归还 -->
	<update id="returnKey">
		UPDATE MANAGE_KEY_INFO MKI SET
		MKI.REMARK = #{remarks,jdbcType=VARCHAR},
		MKI.BORROW_CREATE_TIME = SYSDATE,
		MKI.BORROW_STATUS = 2
		WHERE MKI.ID = #{keyId}
	</update>
	
	<!-- 钥匙退还 -->
	<update id="backKey">
		UPDATE MANAGE_KEY_INFO MKI SET
		MKI.REMARK = #{remarks,jdbcType=VARCHAR},
		MKI.BACK_TYPE = #{backType},
		MKI.BACK_TIME = #{backTime},
		MKI.STATUS = 2
		WHERE MKI.ID = #{keyId}
	</update>
</mapper>