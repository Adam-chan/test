<div class="tableContent">
	<div class="row">
		<div class="col-xs-12" style="height: 26px;">
			<div class="col-xs-2">
				<div class=" form-xs form-group row">
					<label for="addClass" class="col-xs-4 control-label">车位号:</label>
					<div class="col-xs-8">
						<input id="parkNum_search" class="form-control input-xs searchKey">
					</div>
				</div>
			</div>
			<div class="col-xs-2">
				<div class="form-xs form-group row">
					<label class="col-xs-4 control-label">委托:</label>
					<div class="col-xs-8">
						<select id="authorize" class="input-xs form-control searchKey">
							<option value="">请选择</option>
							<option value="1">出租</option>
							<option value="2">出售</option>
							<option value="3">出租/出售</option>
						</select>
					</div>
				</div>
			</div>
			<div class="col-xs-2">
				<div class=" form-xs form-group row">
					<label for="tel" class="col-xs-4 control-label">电话:</label>
					<div class="col-xs-8">
						<input id="telephone" class="form-control input-xs searchKey">
					</div>
				</div>
			</div>
			<div class="col-xs-2">
				<div class="form-xs form-group row">
					<label class="col-xs-4 control-label">楼层:</label>
					<div class="col-xs-8">
						<select id="floor" class="input-xs form-control searchKey">
							<option value="">请选择</option>
							<option value="1">地上</option>
							<option value="2">地下</option>
						</select>
					</div>
				</div>
			</div>
			<div class="col-xs-2">
				<div class="form-xs form-group row">
					<label class="col-xs-4 control-label">类型:</label>
					<div class="col-xs-8">
						<select id="type" class="input-xs form-control searchKey">
							<option value="">请选择</option>
							<option value="1">车位</option>
							<option value="2">车库</option>
						</select>
					</div>
				</div>
			</div>
			<div class="col-xs-1 form-xs form-group row">
				<button class="car_search">查询</button>
			</div>
		</div>
		<div class="col-xs-12" style="background-color:#ccddff;margin-left: 12px;">
			<div class="col-xs-1" id="turn_rent" style="width:90px;cursor: pointer;">
				转为出租
			</div>
			<div class="col-xs-1" id="turn_sell" style="width:90px;cursor: pointer;">
				转为出售
			</div>
			<div class="col-xs-1" id="add_carPort" style="width:90px;cursor: pointer;">
				添加车位
			</div>
			<div class="col-xs-1" id="link_room" style="width:90px;cursor: pointer;">
				关联房间
			</div>
			<div class="col-xs-1" id="del_carPark" style="width:90px;cursor: pointer;">
				删除车位
			</div>
		</div>
		<div class="col-xs-12">
			<table id="car_jqGrid">
			
			</table>
			<div id="car_jqGridPager"></div>
		</div>
		<!-- 隐藏域 S -->
		<input id="premisesId" type="hidden" class="searchKey" value="${premisesId!''}">
		<!-- 隐藏域 E -->
	</div>
</div>
<!-- 关联房间页面form -->
<div id="link_roomForm"></div>
<!-- 转为出售form -->
<div id="turn_sellForm"></div>

<script type="text/javascript">

	$(function (){
		init_jqGrid();
	});
	
	function init_jqGrid(){
		$("#car_jqGrid").jqGrid({
			 url: "${CTX}/carPort/getCarPortListForPage.do", 
			 postData: {
			 	 premisesId: $("#premisesId").val(),
			     parkNum: $("#parkNum").val(),
			     authorize: $("#authorize").val(),
			     telephone: $("#telephone").val(),
			     floor: $("#floor").val(),
			     type: $("#type").val()
			 },
	         datatype: "json",
	         colModel: [
				 { label: 'id', name: 'id',index:'id',hidden:true},
				 { label: 'authorize', name: 'authorize',index:'authorize',hidden:true},
	             { label: '车位号', name: 'parkNum',index:'parkNum',sortable : true,width: 30,
					 formatter:function(rowName, options, rowObject){
	            	    return "<a href=\"javascript:showCarPortDetail('"+rowObject.id+"');\"  style='text-decoration:none;color:blue'>"+rowName+"</a>";
	             	 }
				 },
				 { label: '楼层', name: 'floorStr',index:'floorStr',sortable : true,width: 30 },
				 { label: '类型', name: 'typeStr',index:'typeStr',sortable : true,width: 30 },
				 { label: '电话', name: 'telephone',index:'telephone',sortable : true,width: 30 },
				 { label: '委托', name: 'authorizeStr',index:'authorizeStr',sortable : true,width: 30 },
				 { label: '使用现状', name: 'statusStr',index:'statusStr',sortable : true,width: 30 }
	         ],
	         multiselect: true,
	         multiboxonly: true,
	         viewrecords: true, 
	         autowidth:true,
	         height: $(window).height()-300,
	         rowNum:30, 
		     rowList:[10,20,30,50,100],
	         pager: "#car_jqGridPager",
	     	 jsonReader: { root: 'pagerResults', page:'currentPage',rows:'rowCount',total:'pageCount',records:'totalCount',repeatitems: false} 
	    });
		/* 查询 */
		$(".car_search").click(function(){
			var param = getSearchParam();
		 	$("#car_jqGrid").setGridParam({url:"${CTX}/carPort/getCarPortListForPage.do?"+param,page:1}).trigger('reloadGrid');
		});
		
	    /* 添加车位*/
		$("#add_carPort").click(function(){
			var url = "${CTX}/carPort/addCarPort.do?premisesId="+$("#premisesId").val();
			openCarPortDialog(url);
		});
	    
		/* 转为出租 */
		$("#turn_rent").click(function(){
			  var rowId=jQuery("#car_jqGrid").jqGrid('getGridParam', 'selarrrow');
			  var rowData = $("#car_jqGrid").jqGrid('getRowData',rowId);
			  var authorize = rowData.authorize;//委托状态
			  var carPortId = rowData.id;//车位id
		 	  var selCount=rowId.length;
			  if(selCount==0){
				 alert("没有选中的记录！");
				 return;
			  }
		  	  if(selCount >1){
		   		 alert("每次只能选择一条车位信息，请重新选择！");
		   		 return;
		   	  }
			  if(authorize==1 || authorize==3){
				  alert("该车位已转为出租！");
			   	  return;
			  }else{
				  var title = "租赁房源新增-车位";
				  var type = "rent";
				  turnRentSaleDialog("${CTX}/carPort/turnRentSale.do?id="+carPortId+"&type="+type,title,type);
			  }
		});
		
		/*转为出售*/
		$("#turn_sell").click(function(){
			 var rowId=jQuery("#car_jqGrid").jqGrid('getGridParam', 'selarrrow');
			 var rowData = $("#car_jqGrid").jqGrid('getRowData',rowId);
			 var authorize = rowData.authorize;//委托状态
		   	 var carPortId = rowData.id;//车位id
	 	  	 var selCount=rowId.length;
		     if(selCount==0){
				 alert("没有选中的记录！");
				 return;
		     }
	  	     if(selCount >1){
	   		 	alert("每次只能选择一条车位信息，请重新选择！");
	   		 	return;
	   	     }
		     if(authorize==2 || authorize==3){
			  	alert("该车位已转为出售！");
		   	  	return;
		     }else{
		    	var title = "买卖房源新增-车位";
		    	var type = "sale"
			  	turnRentSaleDialog("${CTX}/carPort/turnRentSale.do?id="+carPortId+"&type="+type,title,type);
		     }
		});
		
		/*关联房间*/
		 $("#link_room").click(function(){
			   var rowId=jQuery("#car_jqGrid").jqGrid('getGridParam', 'selarrrow');
		       var rowData = $("#car_jqGrid").jqGrid('getRowData',rowId);
		       var premisesId = $("#premisesId").val();
		       var selCount=rowId.length;
				  if(selCount==0){
					 alert("没有选中的记录！");
					 return;
				  }
			  	  if(selCount >1){
			   		 alert("每次只能选择一条车位信息，请重新选择！");
			   		 return;
			   	  }
		       $("#link_roomForm").attr("dialogUrl","${CTX}/carInfo/linkRoom.do?id="+premisesId);
			   $("#link_roomForm").dialog("open");
		 });
		
		 /* 弹窗 */
		 $("#link_roomForm").dialog({
		       autoOpen : false,
		       title:"关联房间",//弹框的title
			   closeOnEscpe:true,//是否通过escpe关闭弹框
			   closeBtn:true,//是否显示关闭按钮
			   modal : true,
			   width:900,//弹框的宽度
			   height:400,
		       buttons : {
		           "关联" : function() {
		        	   var rowId=jQuery("#car_jqGrid").jqGrid('getGridParam', 'selarrrow');
		     	       var rowData = $("#car_jqGrid").jqGrid('getRowData',rowId);
		     	       var roomId = $("#room_jqGrid").jqGrid('getGridParam', 'selarrrow');
		     	       var rowData2 = $("#room_jqGrid").jqGrid('getRowData',roomId);
			     	   var selCount=roomId.length;
						  if(selCount==0){
							 alert("没有选中房间！");
							 return;
						  }
					  	  if(selCount >1){
					   		 alert("每次只能选择一个房间，请重新选择！");
					   		 return;
					   	  }
		     	       
		     	       var carId =rowData.id;
		     	       var roomId = rowData2.roomId;
		        	   $.ajax({
			        		url: "${CTX}/carInfo/contactRoom.do",
			        		data:{
			        			carPortId:carId,
			        			roomId:roomId
			        		},
			        		type:"post",
			    			dataType:"json",
			        		success:function(data){
			        			$("#car_jqGrid").trigger('reloadGrid');
			        			if(data==1){
			        				alert("关联成功！");
			        			}else {
			        				alert("关联失败！");
			        			}
			        		}
			        	}); 
		       	  		$(this).dialog("close");
		            }
		       },
		       open:function(){
					$(this).load($(this).attr("dialogUrl"));
		       },
		       close : function() {
		            $(this).empty();
		       }
	    });
		 
	    /* 删除*/
		$("#del_carPark").click(function() {
			var rowIds=$("#car_jqGrid").jqGrid('getGridParam', 'selarrrow');
			var selCount=rowIds.length;
			if (selCount==0){
				alert("没有选中的记录！");
				return;
			}
			var rowDataNames = [];
			$(rowIds).each(function(i,rowId){
	             rowDataNames.push($("#car_jqGrid").jqGrid('getRowData',rowId));
	        });
			for(var i=0;i<rowDataNames.length;i++){
				if(rowDataNames[i].authorizeStr!=""){
					alert("已转出租、转出售的车位无法删除，请重新选择！");
					return;
				}
			}
			var str = rowIds.join(",");
			if (confirm("确认删除？")) {
				$.ajax({
					url : "${CTX}/carInfo/deleteCarPortByIds.do",
					dataType : "json",
					data : {
						carPortIds:str
					},
					success : function(data) {
						$("#car_jqGrid").trigger('reloadGrid');
						alert("删除成功！");
					}
				});
			}
		});
	}
	 
	 /* 新增弹窗 */
	 function openCarPortDialog(url){
		  oaDialogOpen(
			   "carPortDialog",{
				url: url,
				closeOnEscpe: true,
				width : 650,
		        height : 300,
		        modal : true,
		        title : "新增车位",
		        buttons : {
		            "保存" : function() {
		            	var premisesId = $("#premisesId").val();
		            	var addWays = $(".addWays:checked").val();
		            	var parkNum = $("#parkNum").val();
		            	var startNum = $("#startNum").val();
		            	var endNum = $("#endNum").val();
		            	var isNumberFill = $("#isNumberFill").is(":checked")==true?1:0;//1 补位 0不补位
		            	if(addWays == 1 && parkNum == ""){
		            		alert("车位号不能为空！");
		            		return;
		            	}
		            	if(addWays == 2){
			  				if(startNum==""){
			  					alert("起始号段不能为空！");
			  					return;
			  				}
			  				if(endNum==""){
			  					alert("结束号段不能为空！");
			  					return;
			  				}
			  				if(startNum!="" && endNum!=""){
			  					if(startNum>endNum){
			  						alert("起始号段应小于结束号段！");
				  					return;
			  					}
			  				}
		            	}
		            	var data = $("#carPortForm").serialize()+"&isNumberFill="+isNumberFill+"&premisesId="+premisesId;
		            	$.ajax({
			        		url: "${CTX}/carPort/insertCarPort.do",
			        		data:data,
			        		type:"post",
			    			dataType:"json",
			    			async : false,
			        		success:function(data){
			        			$("#car_jqGrid").trigger('reloadGrid');
			        			if(data==1){
			        				alert("保存成功！");
			        			}else if(data==0){
			        				alert("保存失败！");
			        			}else{
			        				alert("该号段数据已存在！");
			        			}
			        		}
			        	}); 
		            	$(this).dialog("close");
		            },
		            "取消" : function() {
		                $(this).dialog("close");
		                $("#car_jqGrid").trigger('reloadGrid');
		            }
		        },
				closeCall: function() {
					$(this).empty();
				}
		 });
	 }
	 /* 查看详情*/
	 function showCarPortDetail(carPortId){
	     openDetailDialog("${CTX}/carPort/carPortDetail.do?id="+carPortId);
	 }
	 /* 详情弹窗*/
	 function openDetailDialog(url){
		  oaDialogOpen(
			   "carPortDetailDialog",{
			   url: url,
			   autoOpen : false,
	    	   closeOnEscpe:true,
			   closeBtn:true,
		       width :700,
		       height : 400,
		       modal : true,
		       title : "车位信息",
		       buttons : {
		           "保存" : function() {
		        	   var parkNum = $("#parkNum_detail").val();
		        	   var remark = $("#remark").val();
		        	   if(parkNum==""){
		        		   alert("车位编号不能为空！");
		        	   }
		        	   var data = $("#carPortDetailForm").serialize();
		        	   data+="&remark="+remark;
		        	   $.ajax({
			        		url: "${CTX}/carPort/updateCarPort.do",
			        		data:data,
			        		type:"post",
			    			dataType:"json",
			    			success:function(data){
			        			$("#car_jqGrid").trigger('reloadGrid');
			        			if(data==1){
			        				alert("保存成功！");
			        			}else{
			        				alert("保存失败！");
			        			}
			        		}
			        	});
		       	  		$(this).dialog("close");	
	        	    },
	        	    "取消" : function() {
		                $(this).dialog("close");
		                $("#car_jqGrid").trigger('reloadGrid');
		            }
	           },
		       close : function() {
		            $(this).empty();
		       }
		 });
	 }
	 
	 /* 转为出租、出售弹窗*/
	 function turnRentSaleDialog(url,title,type){
		 oaDialogOpen(
			   "turnRentSaleDialog",{
			   url: url,
	    	   closeOnEscpe:true,
			   closeBtn:true,
			   width : 1300,
			   height: $(window).height()-150,
		       modal : true,
		       title : title,
		       buttons : {
		           "保存" : function() {
		        	   var data = $("#turn_Form").serialize();
		        	   var useType = $("#useType").val();
		        	   var addressDetail = $("#addressDetail").val();
		        	   var linkmanflag = true;
						$("#lm_tbody tr").each(function(){
							var name = $(this).find("input[name='name']").val();
							var contactType = $(this).find("input[name='contactType']").val();
							if(name=="" || contactType==""){
								linkmanflag = false;
							}
						});
						if(!linkmanflag){
							alert("请完善联系人和联系方式！");
			        		return;
						}
		        	   //房源标签
			           var tags = "";
			           $(".tags:checked").each(function(i){
			        		if(i==0){
			        			tags = $(this).val();
			        		}else{
			        			tags += (","+$(this).val());
			        		}
			           });
			           //业主姓名
			           var ownerName = $("#lm_tbody tr:first").find("input[name='name']").val();
			           //业主联系方式
			           var ownerTel = $("#lm_tbody tr:first").find("input[name='contactType']").val();
			           //联系人
			           var list =[];
			           $("#lm_tbody").children().each(function(){
		        			var type = $(this).find("#type option:selected").val();
							var name = $(this).find("input[name='name']").val();
							var contactType = $(this).find("input[name='contactType']").val();
							var obj='{"type":"'+type+'","name":"'+name+'","contactType":"'+contactType+'"}';
							list.push(obj);
			           });
			           data+="&tags="+tags+"&useType="+useType+"&ownerName="+ownerName+"&ownerTel="+ownerTel+"&linkManList="+list.join("-")+
			                 "&addressDetail="+addressDetail+"&type="+type;
		        	   $.ajax({
			        		url: "${CTX}/carPort/turnRentSaleInsert.do",
			        		data : data,
			        		type : "post",
			    			dataType:"json",
			    			async : false,
			        		success:function(data){
			        			if(data==1){
			        				alert("保存成功！");
			        			}else {
			        				alert("保存失败！");
			        			}
			        		}
			        	});   
		       	  		$(this).dialog("close");
		       	  		$("#car_jqGrid").trigger('reloadGrid');
	        	    },
	        	    "取消" : function() {
		                $(this).dialog("close");
		                $("#car_jqGrid").trigger('reloadGrid');
		            }
	           },
		       close : function() {
		            $(this).empty();
		       }
		 });
	 }
	 
	 /**联系电话校验*/
	 function validateTel(element){
		var flag = false;
		var tel = $(element).val();
		if(tel!=""){
			//数字校验  
			var reg = new RegExp("^[0-9]*$");
		    if(reg.test(tel)){  
		        flag = true;
		    }  
			//规则：1开头11位手机号码、0开头12位固定电话
			var firstNumber = tel.substring(0,1);
			if(firstNumber=="0" &&　tel.length==12){
				flag = true;
			}else if(firstNumber=="1"　&&　tel.length==11){
				flag = true;
			}else{
				flag = false;
			}
			if(flag==false){
				alert("请输入11位手机号码或12位固定电话!"); 
				$(element).val("");
			}
		}
	 }
	 
	 /**业主来源*/
	 function getChildrenSource(element){
			var parentId = $(element).val();
			$("#childSource").children().remove();
			if(parentId==""){
				$("#childSource").append("<option value=''>请选择</option>");
			}else{
				$.ajax({
					url: "${CTX}/carPort/getSourcesByParentId.do",
					data:{
						parentId:parentId
					},
					type:"post",
					dataType:"json",
					async:false,
					success:function(data){
						var html = "";
						if(data.length>0){
							for(var i=0;i<data.length;i++){
								html += "<option value='"+data[i].id+"'>"+data[i].source+"</option>";
							}
						}
						$("#childSource").append(html);
					}
				});
			}
		};

</script> 