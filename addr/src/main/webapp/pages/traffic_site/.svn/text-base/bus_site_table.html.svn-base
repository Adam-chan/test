<div class="tableContent" >
 	<div class="row">
 		<div class=" col-md-3 col-sm-6">
	        <div class=" form-xs form-group row">
	          <label for="addClass" class="col-md-3 col-sm-6 control-label">站点名称 :</label>
	          <div class="col-md-8">
	          		<input type="hidden" id="siteId" name="shipCompanyId" value ="" />
	          		<input class="col-md-12 selectInput" type="text" id="site_input" placeholder="站点名称" value="">
		      </div>
	        </div>
	    </div>
	    <div class=" col-md-3 col-sm-6">
	        <div class=" form-xs form-group row">
	          <label for="addClass" class="col-md-3 col-sm-6 control-label">公交线路 :</label>
	          <div class="col-xs-8">
				  <select id="line_select" class="city input-xs form-control" data-value="浙江省">
				  		<option class="" value="">--选择--</option>
				  		<#if (lineList?size>0)>  
			            	<#list lineList as line>
				            	<option value="${(line.id)!''}">${(line.lineName)!''}</option>
							</#list>
						</#if>
				  </select>
			  </div>
	        </div>
	    </div>
	    <div class="col-md-3 col-sm-6">
		  <div class=" form-xs form-group row">
		  	<div class="col-xs-4" style="text-align:right;" >
			    <form id="dataForm" name="dataForm" enctype="multipart/form-data">
				    <a href="javascript:void(0);" style="position: relative;overflow: hidden;display: block;float: right;height: 24px;color:#0196ff;">
			 	  		<a class="btn btn-xs btn-icon btn-blue"> 
			 	  			<input onchange="fileUpload(this);" name="file" type="file" title="请下载模板并阅读模板备注后上传文件" style="position: absolute;top: -6px;left: -2px;opacity: 0;border: 0;width: 78px;height: 24px!important;line-height: 70px!important; cursor: pointer;">
						    	<span>批量上传</span>
						    <input type="hidden" name="trafficType" value="1"/> 
						</a>
				    </a>
			  	</form>
			</div> 
		    <div class="col-xs-3">
		         <a id="download" href="${CTX}/temp/SiteUploadTemplate.xls" target="_blank" title="公共交通站点上传模板" class="col-sm-8 p_t_50" style="color:#0196ff;text-align: left;">
		         	<button class="btn btn-xs btn-icon btn-blue" style="top:-1px;"> 
					    <span>模板下载 </span>
					</button>
		        </a>
		    </div>
		  </div>
		</div>
		<div class="col-xs-12">
		    <div class="col-md-6 col-sm-12">
		    	<div class=" form-xs form-group row">
		          <span class="lineDetail"></span>
		        </div>
		    </div>
	    </div>
	    <div class="col-xs-12">
		    <table id="busSite_jqGrid">
				
			</table>
		 	<div id="jqGridPager"></div>
        </div>
    </div>  
</div>  

<script type="text/javascript">
	var rod_table = {};
	
	$(function (){
		init_jqGrid();
	});
	//Excel上传并解析
	function fileUpload(element){
		var formData = new FormData($("#dataForm")[0]);
		var strRegex = "(.xls|.xlsx)$";
     	var re=new RegExp(strRegex);
     	var path = $(element).val();
  		if(re.test(path)){
   			$.ajax({  
   	            url :"${CTX}/aroundSite/uploadExcel.do",
   	            type : 'POST',  
   	            data : formData,  
   	            async : false,
   	            processData : false,
   	            contentType : false,
   	            dataType:'JSON',
   		        success: function (data) {
   		        	alert(data);
   		        	$("[name='file']").val("");
   		        	$("#busSite_jqGrid").trigger('reloadGrid');
   		        }
   		    });  
   		}else{
   			alert("上传格式错误！");
   			$("[name='file']").val("");
   		}
	};
	
	function init_jqGrid(){
		$("#busSite_jqGrid").jqGrid({
			 url: "${CTX}/aroundSite/getSiteListForPage.do?trafficType=1", 
	         datatype: "json",
	         colModel: [
				 { label: 'id', name: 'id',index:'id',hidden:true},
	             { label: '公交站点', name: 'siteName',index:'siteName',sortable : false,width: 30 },
	             { label: '经过的公交路线', name: 'lines',index:'lines',width: 30 ,
	                 formatter:function(rowName, options, rowObject){
	            	     if(rowName){
	            	    	 var lineArray = rowName.split(",");
			            	 var html = "";
			            	 $(lineArray).each(function(i){
			            		 if(i==0){
			            			 html+="<a onclick='lookLineDetail(this)' style='text-decoration:underline;color:blue'>"+lineArray[i]+"</a>";
			            		 }else{
			            			 html+="、";
			            			 html+="<a onclick='lookLineDetail(this)' style='text-decoration:underline;color:blue'>"+lineArray[i]+"</a>";
			            		 }
			            	 });
			            	 return html;
	            	     }else{
	            	    	 return "";
	            	     }
		             }
	             },
	             { label: '辅助标识', name: 'assistSign',index:'assistSign',width: 30 },
	             { label: '临近站点', name: 'closeSite',index:'closeSite',width: 30 }
	         ],
	         multiselect: true,
	         multiboxonly: true,
	         onSelectRow: function (rowId, status, e) {
	         	 rowDataNames = [];
	             var rowIds = $("#busSite_jqGrid").jqGrid('getGridParam', 'selarrrow');
	             $(rowIds).each(function(i,rowId){
	                 rowDataNames.push($("#busSite_jqGrid").jqGrid('getRowData',rowId));
	             });
	         },
	         viewrecords: true, 
	         autowidth:true,
	         height: $(window).height()-300,
	         rowNum:30, 
		     rowList:[10,20,30,50,100],
	         pager: "#jqGridPager",
	     	 jsonReader: { root: 'pagerResults', page:'currentPage',rows:'rowCount',total:'pageCount',records:'totalCount',repeatitems: false} 
	    });
	}
	function lookLineDetail(element){
		var lineName = $(element).html();
		var url = "${CTX}/aroundSite/getSiteListForPage.do?lineName="+lineName+"&trafficType=1";
		$("#busSite_jqGrid").setGridParam({url:url,page:1}).trigger('reloadGrid');
		$.ajax({
			url : "${CTX}/aroundLine/getLineByLineName.do",
			dataType : "json",
			type : 'post',
			data : {
				lineName : lineName,
				trafficType : 1
			},
			success : function(data) {
				if(!data[0].startStation){
					data[0].startStation = "";
				}
				if(!data[0].endStation){
					data[0].endStation = "";
				}
				if(!data[0].firstTime){
					data[0].firstTime = "";
				}
				if(!data[0].lastTime){
					data[0].lastTime = "";
				}
				if(!data[0].ticketPrice){
					data[0].ticketPrice = "";
				}
				var html = "公交线路："+data[0].lineName+"   始发站："+data[0].startStation+"   终点站："+data[0].endStation+"   "+"首班："+data[0].firstTime+"   "+"末班："+data[0].lastTime+"   "+"票价："+data[0].ticketPrice+"元";
				$(".lineDetail").html("");
				$(".lineDetail").append(html);
			}
		}); 
	}
	$("#site_input").autocomplete({
		source : function(request, response) {
			$.ajax({
				url : "${CTX}/aroundSite/getSiteListByMatch.do",
				dataType : "json",
				type : 'post',
				data : {
					matchStr : request.term,
					trafficType : 1
				},
				success : function(data) {
					var array = new Array(data.length);
					for (var i = 0; i < data.length; i++) {
						var temp = {
							key : data[i].id,
							value : data[i].siteName
						};
						array[i] = temp;
					}
					response(array);
				}
			});
		},
		select : function(event, ui) {
			$("#siteId").val(ui.item.key);
			$("#site_input").val(ui.item.value);
			event.preventDefault();
		}
	}); 
	$("#site_input").blur(function(){
		if($("#site_input").val()==""){
			$("#siteId").val("");
		}
	});
</script> 
<style>
	.ui-jqgrid tr.jqgrow td {text-overflow : ellipsis;}
	.ui-jqgrid tr.jqgrow td {
	  white-space: normal !important;
	  height:auto;
	  vertical-align:text-top;
	  padding-top:2px;
	}
</style>
