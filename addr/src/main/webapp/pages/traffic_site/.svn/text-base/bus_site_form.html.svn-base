<form id="bus_site_Form">
  <div class="modal-body form-horizontal row">
    <div class="lineName_div col-sm-12">
      <div class=" form-xs form-group row">
         <label for="addGrade" class="col-xs-3 control-label">公交站点名称 </label>
         <div class="col-xs-7">
         	<input type="hidden" class="form-control input-xs" id="id" value="${(site.id)!''}" /> 
            <input id="siteName" type="text" class="form-control input-xs" maxlength="20" value="${(site.siteName)!''}" vRequired="true" placeholder="公交站点名称">
         </div>
       </div>
    </div>
    <!-- 线路气泡S -->
    <#if lineList?exists>
	    <#if (lineList?size>0)>  
	         <div class='col-sm-12'>
				<div class='form-xs form-group row'>
					<label for='addGrade' class='col-xs-3 control-label'></label>
					<div class='col-xs-7'>
						<div class='tags col-xs-9' style='margin:0;border:0;width: 75%;'>
						<#list lineList as line>
							<span class="tag" value="${(line.id)!''}">${(line.lineName)!''}<button type="button" class="close" onclick="closeSpan($(this));"'>×</button></span>
						</#list>
						</div>
					</div>
				</div>
			 </div>
		</#if>
	</#if>
    <!-- E -->
    <div class="col-sm-12">
        <div class=" form-xs form-group row">
           <label for="addClass" class="col-xs-3 control-label">经过线路</label>
           <div class="col-xs-7">
          		<input class="col-md-12 selectInput" type="text" id="line_input" placeholder="线路名称" value="">
	       </div>
        </div>
    </div>
    <div class="col-sm-12">
      <div class=" form-xs form-group row">
         <label for="addGrade" class="col-xs-3 control-label">辅助标识 </label>
         <div class="col-xs-7">
            <textarea id="assistSign" rows="4" cols="25" class="form-control" maxlength="300" placeholder="辅助标识">${(site.assistSign)!''}</textarea>
         </div>
       </div>
    </div>
    <div class="col-sm-12">
      <div class=" form-xs form-group row">
         <label for="addGrade" class="col-xs-3 control-label">临近站点 </label>
         <div class="col-xs-7">
            <textarea id="closeSite" rows="4" cols="25" class="form-control" maxlength="300" placeholder="临近站点">${(site.closeSite)!''}</textarea>
         </div>
       </div>
    </div>
  </div>
</form>

<div id="line_form" ></div>

<script type="text/javascript">

	$("#bus_site_Form").validationEngine('attach',{
		promptPosition: 'bottomRight',
	  	validationEventTrigger:"blur"
	});
	$("#siteName").blur(function(){
		var siteName = $("#siteName").val();
		var siteId = $("#id").val();
		if(siteName!=""){
			$.ajax({
	    		url: "${CTX}/aroundSite/getSiteByNameIs.do",
	    		data:{
	    			siteName:siteName,
	    			trafficType:1,
	    			siteId:siteId
	    		},
	    		type:"post",
				dataType:"json",
	    		success:function(data){
	    			if(data>0){
	    				alert("该站点名称已存在！");
	    				$("#siteName").val("");
	    			}
	    		}
	    	});
		}
	});
	$("#line_input").autocomplete({
		source : function(request, response) {
			$.ajax({
				url : "${CTX}/aroundLine/getLineListByMatch.do",
				dataType : "json",
				type : 'post',
				data : {
					matchStr : request.term,
					trafficType : 1
				},
				success : function(data) {
					//下拉框中过滤已选中的线路
					var tagArray = $(".tag");
					var lineIdArray = [];
					if(tagArray.length>0){
						for(var i = 0; i < tagArray.length; i++){
							lineIdArray.push(tagArray.eq(i).attr("value"));
						}
					}
					var array = [];//返回结果数组
					for (var i = 0; i < data.length; i++) {
						if(lineIdArray.length>0){
							if(lineIdArray.toString().indexOf(data[i].id)<=-1){
								var temp = {
									key : data[i].id,
									value : data[i].lineName
								};
								array.push(temp);
							}
						}else{
							var temp = {
								key : data[i].id,
								value : data[i].lineName
							};
							array.push(temp);
						}
					}
					response(array);
				}
			});
		},
		select : function(event, ui) {
			var lineId = ui.item.key;
			var lineName = ui.item.value;
			event.preventDefault();
			//选择的线路以气泡显示 
			var html = "";
			if($(".tags").length>0){
				html += "<span class='tag' value="+lineId+">"+lineName+"<button type='button' class='close' onclick='closeSpan($(this));''>×</button></span>";
				$(".tags").append(html);
			}else{
				html+="<div class='col-sm-12'>";
				html+="<div class='form-xs form-group row'>";
				html+="<label for='addGrade' class='col-xs-3 control-label'></label>";
				html+="<div class='col-xs-7'>";
				html+="<div class='tags col-xs-9' style='margin:0;border:0;width: 75%;'>";
				html+="<span class='tag' value="+lineId+">"+lineName+"<button type='button' class='close' onclick='closeSpan($(this));''>×</button></span>";
				html+="</div>";
				html+="</div>";
				html+="</div>";
				html+="</div>";	
				$(".lineName_div").append(html);
			}
		}
	});
	//删除选中标签 
	function closeSpan(obj) {
		var tagArray = $(".tag");
		if(tagArray.length>1){
			obj.parent().remove();
		}else{
			obj.parent().parent().parent().parent().remove();
		}
	}
</script>

