<title>公共交通站点管理</title>
<!-- tools S -->
<div id="top_tools" class=" btn-group">
  <button id="site_query" class="btn btn-sm btn-white  confirmBtn" id="confirm">
    <i class="iconfont">&#xe6e4;</i>
    <span>查询</span>
  </button>
  
  <button id="site_add" class="btn btn-sm btn-white ladda-button">
    <i class="iconfont">&#xe6e0;</i>
    <span>新增</span>
  </button>

 <button id="site_edit" class="btn btn-sm btn-white btn-default">
    <i class="iconfont">&#xe6dd;</i>
    <span>修改</span>
  </button>
  
  <button id="site_del" class="btn btn-sm btn-white btn-info">
    <i class="iconfont">&#xe6e3;</i>
    <span>删除</span>
  </button>
  
</div>
<!-- tools E -->
<!-- row S -->
<div class="row">
	<!-- tab S -->
	<div class="col-xs-12">
	  <div id="tabs" class="tabbable tabbable-lightBlue">
	    <ul class="nav nav-tabs" >
	      <li class="active">
	        <a data-toggle="tab" tabUrl="${CTX}/aroundSite/getSiteTable.do?selTabIndex=1" tabView="#tab-content1">公交站点管理</a>
	      </li>
	      <li>
	        <a data-toggle="tab" tabUrl="${CTX}/aroundSite/getSiteTable.do?selTabIndex=2" tabView="#tab-content1">地铁站点管理</a>
	      </li>
	    </ul>
	    <div class="tab-content" id="tab-content1"></div>
	  </div>
	</div> 
	<!-- tab E -->
</div> 
<!-- row S -->
<div id="site_form" ></div>

<script type="text/javascript">
	 $('.page-content-area').ace_ajax('loadScripts', [null, null], function () {});
	 
	 /* 获取当前选中tab页下标*/
	 function getSelTabIndex(){
		 var selTabIndex;
		 if($("#tabs ul>li").eq(0).attr("class")=="active"){
			 selTabIndex = 1;
		 }else if($("#tabs ul>li").eq(1).attr("class")=="active"){
			 selTabIndex = 2;
		 }
		 return selTabIndex;
	 }
	 /* 查询 */
	 $("#site_query").click(function(){
		var param = getSearchParam()
		var siteId = $("#siteId").val();
		var lineId = $("#line_select").val();
		var trafficType;
		var selTabIndex = getSelTabIndex();
	 	if(selTabIndex==1){
	 		trafficType = 1;
	 	}else{
	 		trafficType = 2;
	 	}
		param+="&siteId="+siteId+"&lineId="+lineId+"&trafficType="+trafficType;
		var url = "${CTX}/aroundSite/getSiteListForPage.do?"+param;
	 	if(trafficType==1){
	 		$("#busSite_jqGrid").setGridParam({url:url,page:1}).trigger('reloadGrid');
	 	}else{
	 		$("#subwaySite_jqGrid").setGridParam({url:url,page:1}).trigger('reloadGrid');
	 	}
	 	$(".lineDetail").html("");
	 });
     /* 新增 */
     $("#site_add").click(function(){
    	  openDialog("",getSelTabIndex());
     });
     /* 修改 */
	 $("#site_edit").click(function(){
		  var selTabIndex = getSelTabIndex();
		  var rowIds;
		  var trafficType;
		  if(selTabIndex==1){
			  rowIds = jQuery("#busSite_jqGrid").jqGrid('getGridParam', 'selarrrow');
			  trafficType = 1;
  	      }else{
  	    	  rowIds = jQuery("#subwaySite_jqGrid").jqGrid('getGridParam', 'selarrrow');
  	    	  trafficType = 2;
  	      }
  		  var selCount=rowIds.length;
		  if(selCount==0){
			 alert("没有选中的记录！");
			 return;
		  }
	  	  if(selCount >1){
	   		 alert("每次只能修改一条站点信息，请重新选择！");
	   		 return;
	   	  }
	  	  openDialog(rowIds,selTabIndex);
     });
	 /* 站点弹窗 */
	 function openDialog(rowIds,selTabIndex){
		 oaDialogOpen(
			   "addSiteDialog",{
				url: "${CTX}/aroundSite/getSiteAddDialog.do?id="+rowIds+"&selTabIndex="+selTabIndex,
				closeOnEscpe: true,
			    width : 550,
			    height:450,
			    modal : true,
		        title : "公共交通站点管理",
		        buttons : {
		           "确定" : function() {
		        	    var url = "${CTX}/aroundSite/saveSite.do";
		        	    var selTabIndex =  getSelTabIndex();
		        	    var siteName = $("#siteName").val();
		        	    var trafficType;
						var lineIds = "";
						var assistSign = $("#assistSign").val();
						var closeSite = $("#closeSite").val();
						//拼接线路id
		        	    var tagArray = $(".tag");
						var lineIdArray = [];
						if(tagArray.length>0){
							for(var i = 0; i < tagArray.length; i++){
								lineIdArray.push(tagArray.eq(i).attr("value"));
							}
							lineIds = lineIdArray.join(",");
						}
						//公共交通类型
		        	    if(selTabIndex==1){
		        	    	trafficType = 1;
		        	    }else{
		        	    	trafficType = 2;
		        	    }
		        	    if(siteName==""){
		        	    	alert("站点名称不能为空！");
		        	    }else{
				       		$.ajax({
				        		url: url,
				        		data:{
				        			id:$("#id").val(),
				        			siteName:siteName,
				        			trafficType:trafficType,
				        			lineIdStr:lineIds,
				        			assistSign:assistSign,
									closeSite:closeSite
				        		},
				        		type:"post",
				    			dataType:"json",
				        		success:function(data){
				        			$("#busSite_jqGrid").trigger('reloadGrid');
				        			$("#subwaySite_jqGrid").trigger('reloadGrid');
				        			if(data==1){
				        				alert("保存成功！");
				        			}else{
				        				alert("保存失败！");
				        			}
				        		}
				        	});
			       	  		$(this).dialog("close");	
		        	    }
		            },
		            "取消" : function() {
		                $(this).dialog("close");
		                $("#busSite_jqGrid").trigger('reloadGrid');
		                $("#subwaySite_jqGrid").trigger('reloadGrid');
		            }
		        },
				openCall: function() {
					
				},
				closeCall: function() {
					$(this).empty();
				}
		 });
	}
	/* 删除*/
	$("#site_del").click(function(){
		var selTabIndex = getSelTabIndex();
		var rowIds;
		if(selTabIndex==1){
			  rowIds = jQuery("#busSite_jqGrid").jqGrid('getGridParam', 'selarrrow');
 	    }else{
 	    	  rowIds = jQuery("#subwaySite_jqGrid").jqGrid('getGridParam', 'selarrrow');
 	    }
  		var selCount=rowIds.length;
		if (selCount==0){
			alert("没有选中的记录！");
			return;
		}
		var url = "${CTX}/aroundSite/deleteSites.do";
		var str = rowIds.join(",");
		if (confirm("确认删除？")) {
			$.ajax({
				url : url,
				dataType : "json",
				data : {
					rowIds : str
				},
				success : function(data) {
					$("#busSite_jqGrid").trigger('reloadGrid');
	                $("#subwaySite_jqGrid").trigger('reloadGrid');
					alert("删除成功！");
				}
			});
		}
	});
</script>