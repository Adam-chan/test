<div class="tableContent">
	<div id="distChange" class="row">
		<form id="searchForm">
			<div class="col-xs-12 my-group" enterforbtn="confirm-role">
				<div id="element_id" class="form-horizontal row">
					<div class="col-md-7 col-sm-7">
						<div class="form-xs form-group row">
							<label class="col-xs-2 control-label">行政区：</label>
							<div class="col-xs-2">
								<select id="areaId" class="input-xs form-control" name="areaId">
									<#list areaList as item>
										<option value="${item.id!}">${item.name!}</option>
									</#list>
								</select>
							</div>
							<div class="col-xs-4">
								<div class="row">
									<label class="col-xs-4 control-label">商圈：</label>
									<div class="col-xs-4">
										<select id="busiAreaParentId" class="input-xs form-control" name="busiAreaParentId">
											<option value="">全部</option>
										</select>
									</div>
									<div class="col-xs-4">
										<select id="busiAreaId" class="input-xs form-control" name="busiAreaId">
											<option value="">全部</option>
										</select>
									</div>
								</div>
							</div>
							<div class="col-xs-4">
								<div class="row">
									<label class="col-xs-4 control-label">街道社区：</label>
									<div class="col-xs-4">
										<select id="subdistrictId" class="input-xs form-control" name="subdistrictId">
											<option value="">全部</option>
										</select>
									</div>
									<div class="col-xs-4">
										<select id="communityId" class="input-xs form-control" name="communityId">
											<option value="">全部</option>
										</select>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="col-md-5 col-sm-5">
						<div class="form-xs form-group row">
							<label class="col-xs-2 control-label">道路：</label>
							<div class="col-xs-4">
								<select id="roadId" class="input-xs form-control" name="roadId">
									<option value="">全部</option>
								</select>
							</div>
							<label class="col-xs-2 control-label">号段：</label>
							<div class="col-xs-4">
								<input id="roadNumFrom" class="form-control input-xs" name="roadNumFrom" style="float: left; width: 47%;" onkeyup="this.value=this.value.replace(/\D/g,'')" />
								<span style="float: left; width: 5%;">—</span>
								<input id="roadNumTo" class="form-control input-xs" name="roadNumTo" style="float: left; width: 47%;" onkeyup="this.value=this.value.replace(/\D/g,'')" />
							</div>
						</div>
					</div>
					<div class="col-md-7 col-sm-7">
						<div class="form-xs form-group row">
							<label class="col-xs-2 control-label">楼盘地址：</label>
							<div class="col-xs-10">
								<div class="row" style="margin-left: -3px;">
									<div class="col-xs-3">
										<input id="premisesName" class="form-control input-xs" name="premisesName" type="text" placeholder="请输入楼盘名称">
										<input type="hidden" id="premisesId" name="premisesId" />
									</div>
									<div class="col-xs-3">
										<select id="groupId" class="input-xs form-control" name="groupId">
											<option value="">请选择楼栋分组</option>
										</select>
									</div>
									<div class="col-xs-3">
										<select id="buildingId" class="input-xs form-control" name="buildingId">
											<option value="">请选择栋座</option>
										</select>
									</div>
									<div class="col-xs-3">
										<select id="unitId" class="input-xs form-control" name="unitId">
											<option value="">请选择单元</option>
										</select>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="col-md-5 col-sm-5">
						<div class="form-xs form-group row">
							<label class="col-xs-2 control-label">分配情况：</label>
							<div class="col-xs-4">
								<select id="completeStatus" class="input-xs form-control" name="completeStatus">
									<option value="1">未分配到大区</option>
									<option value="2">未分配到区</option>
									<option value="3">未分配到组</option>
									<option value="4">未分配到人</option>
									<option value="5">已分配</option>
								</select>
							</div>
							<label class="col-xs-2 control-label">楼盘状态：</label>
							<div class="col-xs-4">
								<select id="status" class="input-xs form-control" name="status">
									<option value="">全部</option>
									<option value="1">有效</option>
									<option value="2">无效</option>
								</select>
							</div>
						</div>
					</div>
					<div class="col-md-7 col-sm-7">
						<div class="form-xs form-group row">
							<label class="col-xs-2 control-label">责任人：</label>
							<div class="col-xs-10">
								<div class="row" style="margin-left: -3px;">
									<div class="col-xs-3">
										<select id="dutyAreaId" class="input-xs form-control" name="dutyAreaId">
											<option value="">请选择责任大区</option>
											<#if dutyAreaList ??>
												<#list dutyAreaList as item>
													<option value="${item.orgCode}">${item.name!}</option>
												</#list>
											</#if>
										</select>
									</div>
									<div class="col-xs-3">
										<select id="dutyZoneId" class="input-xs form-control" name="dutyZoneId">
											<option value="">请选择责任区</option>
										</select>
									</div>
									<div class="col-xs-3">
										<select id="dutyGroupId" class="input-xs form-control" name="dutyGroupId">
											<option value="">请选择责任组</option>
										</select>
									</div>
									<div class="col-xs-3">
										<select id="userId" class="input-xs form-control" name="userId">
											<option value="">请选择责任人</option>
										</select>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="col-md-5 col-sm-5">
						<div class="form-xs form-group row">
							<div class="col-xs-4" style="margin-left: 9px;">
								<select id="userStatus" class="input-xs form-control" name="userStatus">
									<option value="">请选择员工状态</option>
									<option value="1">离职</option>
									<option value="2">在职</option>
								</select>
							</div>
							<label class="col-xs-2 control-label">小区定义维护：</label>
							<div class="col-xs-4">
								<select id="maintenanceCategory" class="input-xs form-control" name="maintenanceCategory">
									<option value="">全部</option>
									<option value="1">责任盘</option>
									<option value="2">非责任盘</option>
								</select>
							</div>
						</div>
					</div>
					<div class="col-md-7 col-sm-7">
						<div class="form-xs form-group row">
							<label class="col-xs-2 control-label">层级显示：</label>
							<div class="col-xs-9">
								<div class="radio-inline input-xs">
									<label>
										<input id="hierarchyType" name="hierarchyType" type="radio" class="ace" value="1" checked="checked">
										<span class="lbl">楼盘</span>
									</label>
								</div>
								<div class="radio-inline input-xs">
									<label>
										<input id="hierarchyType" name="hierarchyType" type="radio" class="ace" value="2">
										<span class="lbl">楼栋分组</span>
									</label>
								</div>
								<div class="radio-inline input-xs">
									<label>
										<input id="hierarchyType" name="hierarchyType" type="radio" class="ace" value="3">
										<span class="lbl">栋座</span>
									</label>
								</div>
								<div class="radio-inline input-xs">
									<label>
										<input id="hierarchyType" name="hierarchyType" type="radio" class="ace" value="4">
										<span class="lbl">单元/商铺</span>
									</label>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</form>
		<div class="col-xs-12 my-grid">
			<!-- PAGE CONTENT BEGINS -->
			<table id="jqGrid">
			</table>
			<div id="jqGridPager"></div>
			<!-- PAGE CONTENT ENDS -->
		</div>
		<input type="hidden" id="dataType" name="dataType" />
		<input type="hidden" id="dataPremisesId" name="dataPremisesId" />
		<input type="hidden" id="dataGroupId" name="dataGroupId" />
		<input type="hidden" id="dataBuildingId" name="dataBuildingId" />
		<input type="hidden" id="dataUnitId" name="dataUnitId" />
		<input type="hidden" id="saleAddress" name="saleAddress" />
	</div>
</div>
<script type="text/javascript">
$(window).on("resize.distChange", function () {
	$("#distChange .my-grid").css("top", $("#distChange .my-group").height() + 10);
	$("#distChange .ui-jqgrid-bdiv").css("height", $(window).height() - $("#distChange .my-group").height() - 226);
	$("#distChange .ui-jqgrid-hdiv").css("width", $("#distChange .my-grid").width());
	$("#distChange .ui-jqgrid-bdiv").css("width", $("#distChange .my-grid").width());
	$("#distChange .ui-jqgrid-pager").css("width", $("#distChange .my-grid").width());
});
var aihome = {
	/* 行政区 -> 大商圈(级联) */
	getParentBusiArea : function(areaId, objId) {
		$.ajax({
			type : "post",
			url : "${CTX}/busiArea/getParentBusiAreaList.do",
			async : false,
			dataType : "json",
			data : {"areaId" : areaId},
			success : function(data) {
				aihome.changeOption(data, objId);
			},
		});
	},
	/* 大商圈 -> 小商圈(级联) */
	getBusiArea : function(busiAreaParentId, areaId, objId) {
		$.ajax({
			type : "post",
			url : "${CTX}/busiArea/getBusiAreaList.do",
			async : false,
			dataType : "json",
			data : {"busiAreaParentId" : busiAreaParentId, "areaId" : areaId},
			success : function(data) {
				aihome.changeOption(data, objId);
			},
		});
	},
	/* 行政区 -> 街道(级联) */
	getSubdistrict : function(areaId, objId) {
		aihome.cleanOption("communityId");
		$.ajax({
			type : "post",
			url : "${CTX}/area/getSubdistrictList.do",
			async : false,
			dataType : "json",
			data : {"baseAreaId" : areaId},
			success : function(data) {
				aihome.changeOption(data, objId);
			},
		});
	},
	/* 街道 -> 社区(级联) */
	getCommunity : function(subdistrictId, objId) {
		$.ajax({
			type : "post",
			url : "${CTX}/area/getCommunityList.do",
			async : false,
			dataType : "json",
			data : {"subdistrictId" : subdistrictId},
			success : function(data) {
				aihome.changeOption(data, objId);
			},
		});
	},
	/* 行政区 -> 道路(级联) */
	getRoad : function(areaId, objId) {
		$.ajax({
			type : "post",
			url : "${CTX}/addrDist/getRoadList.do",
			async : false,
			dataType : "json",
			data : {"areaId" : areaId},
			success : function(data) {
				aihome.changeOption(data, objId);
			},
		});
	},
	/* 楼盘 -> 楼盘分组(级联) */
	getGroup : function(premisesId, objId) {
		$.ajax({
			type : "post",
			url : "${CTX}/addrDist/getGroup.do",
			async : false,
			dataType : "json",
			data : {"premisesId" : premisesId},
			success : function(data) {
				aihome.changeOption(data, objId);
			},
		});
	},
	/* 楼栋分组 -> 栋座(级联) */
	getBuilding : function(groupId, premisesId, objId) {
		$.ajax({
			type : "post",
			url : "${CTX}/addrDist/getBuilding.do",
			async : false,
			dataType : "json",
			data : {"groupId" : groupId, "premisesId" : premisesId},
			success : function(data) {
				aihome.changeOption(data, objId);
			},
		});
	},
	/* 栋座 -> 单元/商铺(级联) */
	getUnit : function(buildingId, premisesId, objId) {
		$.ajax({
			type : "post",
			url : "${CTX}/addrDist/getUnit.do",
			async : false,
			dataType : "json",
			data : {"buildingId" : buildingId, "premisesId" : premisesId},
			success : function(data) {
				aihome.changeOption(data, objId);
			},
		});
	},
	/* 大区 -> 区(级联) */
	getDutyZone : function(dutyAreaId, objId) {
		$.ajax({
			type : "post",
			url : "${CRM_CTX}/org/orgList.do",
			async : false,
			dataType : "json",
			data : {"orgCode" : dutyAreaId},
			success : function(data) {
				aihome.changeOption(data, objId);
			},
		});
	},
	/* 区 -> 组(级联) */
	getDutyGroup : function(dutyZoneId, objId) {
		$.ajax({
			type : "post",
			url : "${CRM_CTX}/org/orgList.do",
			async : false,
			dataType : "json",
			data : {"orgCode" : dutyZoneId},
			success : function(data) {
				aihome.changeOption(data, objId);
			},
		});
	},
	/* 组 -> 人(级联) */
	getUser : function(dutyGroupId, objId) {
		$.ajax({
			type : "post",
			url : "${CRM_CTX}/org/userList.do",
			async : false,
			dataType : "json",
			data : {"orgCode" : dutyGroupId},
			success : function(data) {
				aihome.changeOption(data, objId);
			},
		});
	},
	/* 级联改变下拉框内容 */
	changeOption : function (data, objId) {
		aihome.cleanOption(objId);
		var str = "";
		for(var i=0; i < data.length; i++) {
			var id = "";
			var name = "";
			if(objId == "busiAreaParentId" || objId == "busiAreaId") {
				id = data[i].id;
				name = data[i].busiAreaName;
			} else if(objId == "subdistrictId" || objId == "communityId") {
				id = data[i].id;
				name = data[i].name;
			} else if(objId == "roadId" || objId == "groupId" || objId == "buildingId" || objId == "unitId") {
				id = data[i].ID;
				name = data[i].NAME;
			} else if(objId == "dutyZoneId" || objId == "dutyGroupId" || objId == "assignmentDutyZoneId" || objId == "assignmentDutyGroupId") {
				id = data[i].orgCode;
				name = data[i].name;
			} else if(objId == "userId" || objId == "assignmentUserId") {
				id = data[i].userId;
				name = data[i].name;
			}
			var optionShow = $("[id$='" + objId + "']");
			str = "<option value=\"" + id + "\">" + name + "</option>";
			optionShow.append(str);
		}
	},
	/* 清空下拉框内容 */
	cleanOption : function(objId) {
		$("#" + objId).children().first().siblings().remove();
	},
	addrDistListInit : function() {
		$("#jqGrid").jqGrid({
			height: $(window).height(),
			multiboxonly: true,
			viewrecords: true,
			autowidth: true,
			async: false,
			url: "${CTX}/addrDist/getSaleAddrDistList.do",
			postData: {
				areaId: $("#areaId").val()
			},
			datatype: "json",
			colNames : ['区', '街道', '社区', '道路', '楼盘', '楼栋分组', '栋座', '单元/商铺',
						'区ID', '街道ID', '社区ID', '楼盘ID', '楼栋分组ID', '栋座ID', '单元ID',
						'责任大区', '责任区', '责任组','责任人<br>状态', '分配时间', '数据类型'],
			colModel: [
				{ name: 'areaName', index: 'areaName', sortable: false, width: 29, align: 'center'},
				{ name: 'subdistrictName', index: 'subdistrictName', sortable: false, width: 28, align: 'center'},
				{ name: 'communityName', index: 'communityName', sortable: false, width: 28, align: 'center'},
				{ name: 'roadAddr', index: 'roadAddr', sortable: false, width: 28, align: 'center'},
				{ name: 'premisesName', index: 'premisesName', sortable: false, width: 28, align: 'center'},
				{ name: 'groupName', index: 'groupName', sortable: false, width: 28, align: 'center'},
				{ name: 'buildingName', index: 'buildingName', sortable: false, width: 32, align: 'center'},
				{ name: 'unitCode', index: 'unitCode', sortable: false, width: 32, align: 'center'},
				{ name: 'areaId', index: 'areaId', hidden: true},
				{ name: 'subdistrictId', index: 'subdistrictId', hidden: true},
				{ name: 'communityId', index: 'communityId', hidden: true},
				{ name: 'premisesId', index: 'premisesId', hidden: true},
				{ name: 'groupId', index: 'groupId', hidden: true},
				{ name: 'buildingId', index: 'buildingId', hidden: true},
				{ name: 'unitId', index: 'unitId', hidden: true},
				{ name: 'dutyArea', index: 'dutyArea', sortable: false, width: 28, align: 'center'},
				{ name: 'dutyZone', index: 'dutyZone', sortable: false, width: 28, align: 'center'},
				{ name: 'dutyGroup', index: 'dutyGroup', sortable: false, width: 28, align: 'center'},
				{ name: 'userName', index: 'userName', sortable: false, width: 28, align: 'center'},
				{ name: 'operateDate', index: 'operateDate', sortable: false, width: 28, align: 'center'},
				{ name: 'dataType', index: 'dataType', hidden: true}
			],
			onSelectRow: function (rowId, status, e) {
				var rowIds = jQuery("#jqGrid").jqGrid('getGridParam', 'selarrrow');
				var rowData = $("#jqGrid").jqGrid('getRowData',rowId);
				$("#dataType").val(rowData.dataType);
				$("#dataPremisesId").val(rowData.premisesId);
				$("#dataGroupId").val(rowData.groupId);
				$("#dataBuildingId").val(rowData.buildingId);
				$("#dataUnitId").val(rowData.unitId);
				var saleAddress = rowData.areaName
					+ (rowData.subdistrictName == "" ? "" : " " + rowData.subdistrictName)
					+ (rowData.communityName == "" ? "" : " " + rowData.communityName)
					+ (rowData.roadAddr == "" ? "" : " " + rowData.roadAddr)
					+ (rowData.premisesName == "" ? "" : " " + rowData.premisesName)
					+ (rowData.groupName == "" ? "" : " " + rowData.groupName)
					+ (rowData.buildingName == "" ? "" : " " + rowData.buildingName)
					+ (rowData.unitCode == "" ? "" : " " + rowData.unitCode);
				$("#saleAddress").val(saleAddress);
			},
			gridComplete: function () {
				$("#distChange .my-grid").css("top", $("#distChange .my-group").height() + 10);
				$("#distChange .ui-jqgrid-bdiv").css("height", $(window).height() - $("#distChange .my-group").height() - 226);
			},
			rowNum:30, 
			rowList:[10,20,30,50,100],
			pager: "#jqGridPager",
			jsonReader: { root: 'pagerResults', page:'currentPage',rows:'rowCount',total:'pageCount',records:'totalCount',repeatitems: false}
		});
	},
	// 分配
	assignment : function() {
		if($("#dataType").val() == "") {
			alert("没有选中的记录！");
			return;
		}
		oaDialogOpen(
			"saleAssignment",//对话框ID，必填，且不能与当前页面的ID重复
			{
				url: "${CTX}/addrDist/saleAssignment.do?dataType=" + $("#dataType").val() + "&dataPremisesId=" + $("#dataPremisesId").val()
					+ "&dataGroupId=" + $("#dataGroupId").val() + "&dataBuildingId=" + $("#dataBuildingId").val()
					+ "&dataUnitId=" + $("#dataUnitId").val() + "&saleAddress=" + $("#saleAddress").val().replace(/\s+/g, ","),//调用页面的url
				title: "地址分配",//弹框的title
				closeOnEscpe: true,//是否通过esc关闭弹框
				closeBtn: true,//是否显示关闭按钮
				width: 600,//弹框的宽度
				height: 240,//弹框的高度
				buttons: {
					"分配" : function() {
						if(aihome.addAssignment(1)) {
							$(this).dialog("close");
							aihome.queryAddrDist();
						}
					},
					"分配并更新房源所属人" : function() {
						if(aihome.addAssignment(2)) {
							$(this).dialog("close");
							aihome.queryAddrDist();
						}
					},
					"取消" : function() {
						$(this).dialog("close");
					}
				},
				openCall: function() {
					//弹框打开后的回调函数
				},
				closeCall: function() {
					//弹框关闭后的回调函数
				}
			}
		)
	},
	// 查询
	queryAddrDist : function(){
		$("#dataType").val("");
		$("#dataId").val("");
		var param = $("#searchForm").serialize();
		var url = "${CTX}/addrDist/getSaleAddrDistList.do?" + param;
		jQuery("#jqGrid").setGridParam({datatype:'json', url:url, page:1}).trigger("reloadGrid");
	}
}
$(function () {
	aihome.getParentBusiArea($("#areaId").val(), "busiAreaParentId");
	aihome.getSubdistrict($("#areaId").val(), "subdistrictId");
	aihome.getRoad($("#areaId").val(), "roadId");
	// 行政区
	$("#areaId").change(function() {
		// 行政区 -> 大商圈(级联) Start
		aihome.getParentBusiArea($(this).val(), "busiAreaParentId");
		aihome.cleanOption("busiAreaId");
		// 行政区 -> 大商圈(级联) End
		// 行政区 -> 街道(级联) Start
		aihome.getSubdistrict($(this).val(), "subdistrictId");
		aihome.cleanOption("communityId");
		// 行政区 -> 街道(级联) End
		// 行政区 -> 道路(级联) Start
		aihome.getRoad($(this).val(), "roadId");
		// 行政区 -> 道路(级联) End
	});
	// 大商圈
	$("#busiAreaParentId").change(function() {
		// 大商圈 -> 小商圈(级联) Start
		aihome.getBusiArea($(this).val(), $("#areaId").val(), "busiAreaId");
		// 大商圈 -> 小商圈(级联) End
	});
	// 街道
	$("#subdistrictId").change(function() {
		// 街道 -> 社区(级联) Start
		aihome.getCommunity($(this).val(), "communityId");
		// 街道 -> 社区(级联) End
	});
	// 楼栋分组
	$("#groupId").change(function() {
		if($(this).val() == "") {
			aihome.cleanOption("buildingId");
			aihome.cleanOption("unitId");
			return;
		}
		// 楼栋分组 -> 栋座(级联) Start
		aihome.getBuilding($(this).val(), $("#premisesId").val(), "buildingId");
		// 楼栋分组 -> 栋座(级联) End
		aihome.cleanOption("unitId");
	});
	// 栋座
	$("#buildingId").change(function() {
		if($(this).val() == "") {
			aihome.cleanOption("unitId");
			return;
		}
		// 栋座 -> 单元/商铺(级联) Start
		aihome.getUnit($(this).val(), $("#premisesId").val(), "unitId");
		// 栋座 -> 单元/商铺(级联) End
	});
	// 大区
	$("#dutyAreaId").change(function() {
		if($(this).val() == "") {
			aihome.cleanOption("dutyZoneId");
			aihome.cleanOption("dutyGroupId");
			aihome.cleanOption("userId");
			return;
		}
		// 大区 -> 区(级联) Start
		aihome.getDutyZone($(this).val(), "dutyZoneId");
		// 大区 -> 区(级联) End
		aihome.cleanOption("dutyGroupId");
		aihome.cleanOption("userId");
	});
	// 区
	$("#dutyZoneId").change(function() {
		if($(this).val() == "") {
			aihome.cleanOption("dutyGroupId");
			aihome.cleanOption("userId");
			return;
		}
		// 区 -> 组(级联) Start
		aihome.getDutyGroup($(this).val(), "dutyGroupId");
		// 区 -> 组(级联) End
		aihome.cleanOption("userId");
	});
	// 组
	$("#dutyGroupId").change(function() {
		if($(this).val() == "") {
			aihome.cleanOption("userId");
			return;
		}
		// 组 -> 人(级联) Start
		aihome.getUser($(this).val(), "userId");
		// 组 -> 人(级联) End
	});
	// 楼盘
	$("#premisesName").autocomplete({
		source : function(request, response) {
			$.ajax({
				url : "${CTX}/addrDist/getPremisesListByMatch.do",
				dataType : "json",
				type : 'post',
				data : {
					matchStr : request.term.replace(/\s/g, "")
				},
				success : function(data) {
					var array = new Array(data.length);
					for (var i = 0; i < data.length; i++) {
						var temp = {
							key : data[i].ID,
							value : data[i].NAME
						};
						array[i] = temp;
					}
					response(array);
				}
			});
		},
		select : function(event, ui) {
			$("#premisesId").val(ui.item.key);
			$("#premisesName").val(ui.item.value);
			aihome.getGroup(ui.item.key, "groupId");
			aihome.cleanOption("buildingId");
			aihome.cleanOption("unitId");
			event.preventDefault();
		}
	});
	$("#premisesName").blur(function() {
		$(this).attr("placeholder", "请输入楼盘名称");
	});
	$("#premisesName").change(function() {
		$("#premisesId").val("");
		aihome.cleanOption("groupId");
		aihome.cleanOption("buildingId");
		aihome.cleanOption("unitId");
	});
	// 明细列表 Start
	aihome.addrDistListInit();
	// 明细列表 End
	$(".ui-autocomplete.ui-front.ui-menu.ui-widget.ui-widget-content").css("height", "145");
})
</script>